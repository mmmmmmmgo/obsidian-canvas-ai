"use strict";const te=require("obsidian"),Os={id:"gpt-4o",label:"ÈªòËÆ§Ê®°Âûã",endpoint:"https://api.openai.com/v1",apiKey:"",contextTokens:128e3,streaming:!0,functionCalling:!0,vision:!0,imageGeneration:!1,pinned:!0},K={models:[{...Os}],defaultModelId:Os.id,imageModelId:"",systemPrompt:"",expandNestedRefs:!0,warnOnContextTrim:!0,debugLog:{enabled:!1,limit:50},quickActions:{ai:!0,user:!1,assistant:!1,system:!1,arrangeLayout:!0},nodeSize:{userWidth:400,userHeight:140,assistantWidth:400,assistantHeight:300}};async function Kc(n){const e=await n.loadData();return Zc(e)}async function Qc(n,e){await n.saveData(e)}function Zc(n){const e=(n?.models??K.models).map((l,c)=>eu(l,c)),t=e.length>0?e:[{...K.models[0]}],s=n?.defaultModelId&&t.some(l=>l.id===n.defaultModelId)?n.defaultModelId:t[0].id,r=n?.imageModelId&&t.some(l=>l.id===n.imageModelId)?n.imageModelId:"",i={enabled:n?.debugLog?.enabled??K.debugLog.enabled,limit:n?.debugLog?.limit??K.debugLog.limit},a={ai:n?.quickActions?.ai??K.quickActions.ai,user:n?.quickActions?.user??K.quickActions.user,assistant:n?.quickActions?.assistant??K.quickActions.assistant,system:n?.quickActions?.system??K.quickActions.system,arrangeLayout:n?.quickActions?.arrangeLayout??K.quickActions.arrangeLayout},o={userWidth:n?.nodeSize?.userWidth??K.nodeSize.userWidth,userHeight:n?.nodeSize?.userHeight??K.nodeSize.userHeight,assistantWidth:n?.nodeSize?.assistantWidth??K.nodeSize.assistantWidth,assistantHeight:n?.nodeSize?.assistantHeight??K.nodeSize.assistantHeight};return{models:t,defaultModelId:s,imageModelId:r,systemPrompt:n?.systemPrompt??K.systemPrompt,expandNestedRefs:n?.expandNestedRefs??K.expandNestedRefs,warnOnContextTrim:n?.warnOnContextTrim??K.warnOnContextTrim,debugLog:i,quickActions:a,nodeSize:o}}function eu(n,e){return{id:n.id??`model-${e+1}`,label:n.label??"",endpoint:n.endpoint??K.models[0].endpoint,apiKey:n.apiKey??"",contextTokens:n.contextTokens??K.models[0].contextTokens,streaming:n.streaming??K.models[0].streaming,functionCalling:n.functionCalling??K.models[0].functionCalling,vision:n.vision??K.models[0].vision,imageGeneration:n.imageGeneration??K.models[0].imageGeneration,pinned:n.pinned??!1}}class tu extends te.Plugin{async onload(){this.settings=await Kc(this)}async saveSettings(){await Qc(this,this.settings)}onunload(){console.log("unloading plugin")}}const Mr=!1;var ni=Array.isArray,nu=Array.prototype.indexOf,Gs=Array.from,su=Object.defineProperty,Hn=Object.getOwnPropertyDescriptor,_o=Object.getOwnPropertyDescriptors,ru=Object.prototype,iu=Array.prototype,si=Object.getPrototypeOf,Ca=Object.isExtensible;function au(n){for(var e=0;e<n.length;e++)n[e]()}function yo(){var n,e,t=new Promise((s,r)=>{n=s,e=r});return{promise:t,resolve:n,reject:e}}const de=2,ri=4,ii=8,ou=1<<24,ht=16,pt=32,Yt=64,Ys=128,Ye=512,me=1024,ke=2048,st=4096,Te=8192,Ct=16384,ai=32768,hn=65536,Ea=1<<17,wo=1<<18,_n=1<<19,lu=1<<20,ut=1<<25,jt=32768,Tr=1<<21,oi=1<<22,Et=1<<23,Bt=Symbol("$state"),cu=Symbol(""),ln=new class extends Error{name="StaleReactionError";message="The reaction that called `getAbortSignal()` was re-run or destroyed"};function uu(){throw new Error("https://svelte.dev/e/async_derived_orphan")}function du(n){throw new Error("https://svelte.dev/e/effect_in_teardown")}function fu(){throw new Error("https://svelte.dev/e/effect_in_unowned_derived")}function hu(n){throw new Error("https://svelte.dev/e/effect_orphan")}function pu(){throw new Error("https://svelte.dev/e/effect_update_depth_exceeded")}function gu(){throw new Error("https://svelte.dev/e/state_descriptors_fixed")}function mu(){throw new Error("https://svelte.dev/e/state_prototype_fixed")}function vu(){throw new Error("https://svelte.dev/e/state_unsafe_mutation")}function _u(){throw new Error("https://svelte.dev/e/svelte_boundary_reset_onerror")}const yu=1,wu=2,bo=4,bu=8,xu=16,ku=1,Cu=2,ge=Symbol(),Eu="http://www.w3.org/1999/xhtml";function Su(){console.warn("https://svelte.dev/e/select_multiple_invalid_value")}function Au(){console.warn("https://svelte.dev/e/svelte_boundary_reset_noop")}function xo(n){return n===this.v}function ko(n,e){return n!=n?e==e:n!==e||n!==null&&typeof n=="object"||typeof n=="function"}function Co(n){return!ko(n,this.v)}let Ru=!1,He=null;function pn(n){He=n}function Vs(n,e=!1,t){He={p:He,i:!1,c:null,e:null,s:n,x:null,l:null}}function Js(n){var e=He,t=e.e;if(t!==null){e.e=null;for(var s of t)Fo(s)}return e.i=!0,He=e.p,{}}function Eo(){return!0}let cn=[];function Pu(){var n=cn;cn=[],au(n)}function Jn(n){if(cn.length===0){var e=cn;queueMicrotask(()=>{e===cn&&Pu()})}cn.push(n)}function So(n){var e=X;if(e===null)return U.f|=Et,n;if((e.f&ai)===0){if((e.f&Ys)===0)throw n;e.b.error(n)}else gn(n,e)}function gn(n,e){for(;e!==null;){if((e.f&Ys)!==0)try{e.b.error(n);return}catch(t){n=t}e=e.parent}throw n}const ms=new Set;let Q=null,ze=null,Ke=[],li=null,Nr=!1;class et{committed=!1;current=new Map;previous=new Map;#e=new Set;#t=new Set;#s=0;#n=0;#l=null;#i=new Set;#r=new Set;skipped_effects=new Set;is_fork=!1;is_deferred(){return this.is_fork||this.#n>0}process(e){Ke=[],this.apply();var t={parent:null,effect:null,effects:[],render_effects:[]};for(const s of e)this.#a(s,t);this.is_fork||this.#u(),this.is_deferred()?(this.#o(t.effects),this.#o(t.render_effects)):(Q=null,Sa(t.render_effects),Sa(t.effects),this.#l?.resolve()),ze=null}#a(e,t){e.f^=me;for(var s=e.first;s!==null;){var r=s.f,i=(r&(pt|Yt))!==0,a=i&&(r&me)!==0,o=a||(r&Te)!==0||this.skipped_effects.has(s);if((s.f&Ys)!==0&&s.b?.is_pending()&&(t={parent:t,effect:s,effects:[],render_effects:[]}),!o&&s.fn!==null){i?s.f^=me:(r&ri)!==0?t.effects.push(s):Qn(s)&&((s.f&ht)!==0&&this.#i.add(s),Gn(s));var l=s.first;if(l!==null){s=l;continue}}var c=s.parent;for(s=s.next;s===null&&c!==null;)c===t.effect&&(this.#o(t.effects),this.#o(t.render_effects),t=t.parent),s=c.next,c=c.parent}}#o(e){for(const t of e)(t.f&ke)!==0?this.#i.add(t):(t.f&st)!==0&&this.#r.add(t),this.#c(t.deps),ve(t,me)}#c(e){if(e!==null)for(const t of e)(t.f&de)===0||(t.f&jt)===0||(t.f^=jt,this.#c(t.deps))}capture(e,t){this.previous.has(e)||this.previous.set(e,t),(e.f&Et)===0&&(this.current.set(e,e.v),ze?.set(e,e.v))}activate(){Q=this,this.apply()}deactivate(){Q===this&&(Q=null,ze=null)}flush(){if(this.activate(),Ke.length>0){if(Iu(),Q!==null&&Q!==this)return}else this.#s===0&&this.process([]);this.deactivate()}discard(){for(const e of this.#t)e(this);this.#t.clear()}#u(){if(this.#n===0){for(const e of this.#e)e();this.#e.clear()}this.#s===0&&this.#d()}#d(){if(ms.size>1){this.previous.clear();var e=ze,t=!0,s={parent:null,effect:null,effects:[],render_effects:[]};for(const i of ms){if(i===this){t=!1;continue}const a=[];for(const[l,c]of this.current){if(i.current.has(l))if(t&&c!==i.current.get(l))i.current.set(l,c);else continue;a.push(l)}if(a.length===0)continue;const o=[...i.current.keys()].filter(l=>!this.current.has(l));if(o.length>0){var r=Ke;Ke=[];const l=new Set,c=new Map;for(const h of a)Ao(h,o,l,c);if(Ke.length>0){Q=i,i.apply();for(const h of Ke)i.#a(h,s);i.deactivate()}Ke=r}}Q=null,ze=e}this.committed=!0,ms.delete(this)}increment(e){this.#s+=1,e&&(this.#n+=1)}decrement(e){this.#s-=1,e&&(this.#n-=1),this.revive()}revive(){for(const e of this.#i)this.#r.delete(e),ve(e,ke),qt(e);for(const e of this.#r)ve(e,st),qt(e);this.flush()}oncommit(e){this.#e.add(e)}ondiscard(e){this.#t.add(e)}settled(){return(this.#l??=yo()).promise}static ensure(){if(Q===null){const e=Q=new et;ms.add(Q),et.enqueue(()=>{Q===e&&e.flush()})}return Q}static enqueue(e){Jn(e)}apply(){}}function Iu(){var n=Wt;Nr=!0;var e=null;try{var t=0;for(Ls(!0);Ke.length>0;){var s=et.ensure();if(t++>1e3){var r,i;Mu()}s.process(Ke),St.clear()}}finally{Nr=!1,Ls(n),li=null}}function Mu(){try{pu()}catch(n){gn(n,li)}}let ct=null;function Sa(n){var e=n.length;if(e!==0){for(var t=0;t<e;){var s=n[t++];if((s.f&(Ct|Te))===0&&Qn(s)&&(ct=new Set,Gn(s),s.deps===null&&s.first===null&&s.nodes===null&&(s.teardown===null&&s.ac===null?Bo(s):s.fn=null),ct?.size>0)){St.clear();for(const r of ct){if((r.f&(Ct|Te))!==0)continue;const i=[r];let a=r.parent;for(;a!==null;)ct.has(a)&&(ct.delete(a),i.push(a)),a=a.parent;for(let o=i.length-1;o>=0;o--){const l=i[o];(l.f&(Ct|Te))===0&&Gn(l)}}ct.clear()}}ct=null}}function Ao(n,e,t,s){if(!t.has(n)&&(t.add(n),n.reactions!==null))for(const r of n.reactions){const i=r.f;(i&de)!==0?Ao(r,e,t,s):(i&(oi|ht))!==0&&(i&ke)===0&&Ro(r,e,s)&&(ve(r,ke),qt(r))}}function Ro(n,e,t){const s=t.get(n);if(s!==void 0)return s;if(n.deps!==null)for(const r of n.deps){if(e.includes(r))return!0;if((r.f&de)!==0&&Ro(r,e,t))return t.set(r,!0),!0}return t.set(n,!1),!1}function qt(n){for(var e=li=n;e.parent!==null;){e=e.parent;var t=e.f;if(Nr&&e===X&&(t&ht)!==0&&(t&wo)===0)return;if((t&(Yt|pt))!==0){if((t&me)===0)return;e.f^=me}}Ke.push(e)}function Tu(n){let e=0,t=Xt(0),s;return()=>{qn()&&(p(t),fi(()=>(e===0&&(s=Qs(()=>n(()=>Wn(t)))),e+=1,()=>{Jn(()=>{e-=1,e===0&&(s?.(),s=void 0,Wn(t))})})))}}var Nu=hn|_n|Ys;function Ou(n,e,t){new $u(n,e,t)}class $u{parent;#e=!1;#t;#s=null;#n;#l;#i;#r=null;#a=null;#o=null;#c=null;#u=null;#d=0;#f=0;#p=!1;#h=null;#y=Tu(()=>(this.#h=Xt(this.#d),()=>{this.#h=null}));constructor(e,t,s){this.#t=e,this.#n=t,this.#l=s,this.parent=X.b,this.#e=!!this.#n.pending,this.#i=hi(()=>{X.b=this;{var r=this.#v();try{this.#r=De(()=>s(r))}catch(i){this.error(i)}this.#f>0?this.#m():this.#e=!1}return()=>{this.#u?.remove()}},Nu)}#w(){try{this.#r=De(()=>this.#l(this.#t))}catch(e){this.error(e)}this.#e=!1}#b(){const e=this.#n.pending;e&&(this.#a=De(()=>e(this.#t)),et.enqueue(()=>{var t=this.#v();this.#r=this.#g(()=>(et.ensure(),De(()=>this.#l(t)))),this.#f>0?this.#m():(Ht(this.#a,()=>{this.#a=null}),this.#e=!1)}))}#v(){var e=this.#t;return this.#e&&(this.#u=At(),this.#t.before(this.#u),e=this.#u),e}is_pending(){return this.#e||!!this.parent&&this.parent.is_pending()}has_pending_snippet(){return!!this.#n.pending}#g(e){var t=X,s=U,r=He;rt(this.#i),be(this.#i),pn(this.#i.ctx);try{return e()}catch(i){return So(i),null}finally{rt(t),be(s),pn(r)}}#m(){const e=this.#n.pending;this.#r!==null&&(this.#c=document.createDocumentFragment(),this.#c.append(this.#u),Uo(this.#r,this.#c)),this.#a===null&&(this.#a=De(()=>e(this.#t)))}#_(e){if(!this.has_pending_snippet()){this.parent&&this.parent.#_(e);return}this.#f+=e,this.#f===0&&(this.#e=!1,this.#a&&Ht(this.#a,()=>{this.#a=null}),this.#c&&(this.#t.before(this.#c),this.#c=null))}update_pending_count(e){this.#_(e),this.#d+=e,this.#h&&mn(this.#h,this.#d)}get_effect_pending(){return this.#y(),p(this.#h)}error(e){var t=this.#n.onerror;let s=this.#n.failed;if(this.#p||!t&&!s)throw e;this.#r&&(xe(this.#r),this.#r=null),this.#a&&(xe(this.#a),this.#a=null),this.#o&&(xe(this.#o),this.#o=null);var r=!1,i=!1;const a=()=>{if(r){Au();return}r=!0,i&&_u(),et.ensure(),this.#d=0,this.#o!==null&&Ht(this.#o,()=>{this.#o=null}),this.#e=this.has_pending_snippet(),this.#r=this.#g(()=>(this.#p=!1,De(()=>this.#l(this.#t)))),this.#f>0?this.#m():this.#e=!1};var o=U;try{be(null),i=!0,t?.(e,a),i=!1}catch(l){gn(l,this.#i&&this.#i.parent)}finally{be(o)}s&&Jn(()=>{this.#o=this.#g(()=>{et.ensure(),this.#p=!0;try{return De(()=>{s(this.#t,()=>e,()=>a)})}catch(l){return gn(l,this.#i.parent),null}finally{this.#p=!1}})})}}function Lu(n,e,t,s){const r=ci;if(t.length===0&&n.length===0){s(e.map(r));return}var i=Q,a=X,o=Fu();function l(){Promise.all(t.map(c=>Du(c))).then(c=>{o();try{s([...e.map(r),...c])}catch(h){(a.f&Ct)===0&&gn(h,a)}i?.deactivate(),$s()}).catch(c=>{gn(c,a)})}n.length>0?Promise.all(n).then(()=>{o();try{return l()}finally{i?.deactivate(),$s()}}):l()}function Fu(){var n=X,e=U,t=He,s=Q;return function(i=!0){rt(n),be(e),pn(t),i&&s?.activate()}}function $s(){rt(null),be(null),pn(null)}function ci(n){var e=de|ke,t=U!==null&&(U.f&de)!==0?U:null;return X!==null&&(X.f|=_n),{ctx:He,deps:null,effects:null,equals:xo,f:e,fn:n,reactions:null,rv:0,v:ge,wv:0,parent:t??X,ac:null}}function Du(n,e){let t=X;t===null&&uu();var s=t.b,r=void 0,i=Xt(ge),a=!U,o=new Map;return Zu(()=>{var l=yo();r=l.promise;try{Promise.resolve(n()).then(l.resolve,l.reject).then(()=>{c===Q&&c.committed&&c.deactivate(),$s()})}catch(u){l.reject(u),$s()}var c=Q;if(a){var h=!s.is_pending();s.update_pending_count(1),c.increment(h),o.get(c)?.reject(ln),o.delete(c),o.set(c,l)}const f=(u,d=void 0)=>{if(c.activate(),d)d!==ln&&(i.f|=Et,mn(i,d));else{(i.f&Et)!==0&&(i.f^=Et),mn(i,u);for(const[g,_]of o){if(o.delete(g),g===c)break;_.reject(ln)}}a&&(s.update_pending_count(-1),c.decrement(h))};l.promise.then(f,u=>f(null,u||"unknown"))}),di(()=>{for(const l of o.values())l.reject(ln)}),new Promise(l=>{function c(h){function f(){h===r?l(i):c(r)}h.then(f,f)}c(r)})}function mr(n){const e=ci(n);return jo(e),e}function zu(n){const e=ci(n);return e.equals=Co,e}function Po(n){var e=n.effects;if(e!==null){n.effects=null;for(var t=0;t<e.length;t+=1)xe(e[t])}}function Bu(n){for(var e=n.parent;e!==null;){if((e.f&de)===0)return(e.f&Ct)===0?e:null;e=e.parent}return null}function ui(n){var e,t=X;rt(Bu(n));try{n.f&=~jt,Po(n),e=Yo(n)}finally{rt(t)}return e}function Io(n){var e=ui(n);if(n.equals(e)||(Q?.is_fork||(n.v=e),n.wv=Xo()),!yn)if(ze!==null)(qn()||Q?.is_fork)&&ze.set(n,e);else{var t=(n.f&Ye)===0?st:me;ve(n,t)}}let Or=new Set;const St=new Map;let Mo=!1;function Xt(n,e){var t={f:0,v:n,reactions:null,equals:xo,rv:0,wv:0};return t}function Me(n,e){const t=Xt(n);return jo(t),t}function Hu(n,e=!1,t=!0){const s=Xt(n);return e||(s.equals=Co),s}function ue(n,e,t=!1){U!==null&&(!tt||(U.f&Ea)!==0)&&Eo()&&(U.f&(de|ht|oi|Ea))!==0&&!dt?.includes(n)&&vu();let s=t?kt(e):e;return mn(n,s)}function mn(n,e){if(!n.equals(e)){var t=n.v;yn?St.set(n,e):St.set(n,t),n.v=e;var s=et.ensure();s.capture(n,t),(n.f&de)!==0&&((n.f&ke)!==0&&ui(n),ve(n,(n.f&Ye)!==0?me:st)),n.wv=Xo(),To(n,ke),X!==null&&(X.f&me)!==0&&(X.f&(pt|Yt))===0&&(Fe===null?nd([n]):Fe.push(n)),!s.is_fork&&Or.size>0&&!Mo&&Wu()}return e}function Wu(){Mo=!1;var n=Wt;Ls(!0);const e=Array.from(Or);try{for(const t of e)(t.f&me)!==0&&ve(t,st),Qn(t)&&Gn(t)}finally{Ls(n)}Or.clear()}function Wn(n){ue(n,n.v+1)}function To(n,e){var t=n.reactions;if(t!==null)for(var s=t.length,r=0;r<s;r++){var i=t[r],a=i.f,o=(a&ke)===0;if(o&&ve(i,e),(a&de)!==0){var l=i;ze?.delete(l),(a&jt)===0&&(a&Ye&&(i.f|=jt),To(l,st))}else o&&((a&ht)!==0&&ct!==null&&ct.add(i),qt(i))}}function kt(n){if(typeof n!="object"||n===null||Bt in n)return n;const e=si(n);if(e!==ru&&e!==iu)return n;var t=new Map,s=ni(n),r=Me(0),i=Ut,a=o=>{if(Ut===i)return o();var l=U,c=Ut;be(null),Ma(i);var h=o();return be(l),Ma(c),h};return s&&t.set("length",Me(n.length)),new Proxy(n,{defineProperty(o,l,c){(!("value"in c)||c.configurable===!1||c.enumerable===!1||c.writable===!1)&&gu();var h=t.get(l);return h===void 0?h=a(()=>{var f=Me(c.value);return t.set(l,f),f}):ue(h,c.value,!0),!0},deleteProperty(o,l){var c=t.get(l);if(c===void 0){if(l in o){const h=a(()=>Me(ge));t.set(l,h),Wn(r)}}else ue(c,ge),Wn(r);return!0},get(o,l,c){if(l===Bt)return n;var h=t.get(l),f=l in o;if(h===void 0&&(!f||Hn(o,l)?.writable)&&(h=a(()=>{var d=kt(f?o[l]:ge),g=Me(d);return g}),t.set(l,h)),h!==void 0){var u=p(h);return u===ge?void 0:u}return Reflect.get(o,l,c)},getOwnPropertyDescriptor(o,l){var c=Reflect.getOwnPropertyDescriptor(o,l);if(c&&"value"in c){var h=t.get(l);h&&(c.value=p(h))}else if(c===void 0){var f=t.get(l),u=f?.v;if(f!==void 0&&u!==ge)return{enumerable:!0,configurable:!0,value:u,writable:!0}}return c},has(o,l){if(l===Bt)return!0;var c=t.get(l),h=c!==void 0&&c.v!==ge||Reflect.has(o,l);if(c!==void 0||X!==null&&(!h||Hn(o,l)?.writable)){c===void 0&&(c=a(()=>{var u=h?kt(o[l]):ge,d=Me(u);return d}),t.set(l,c));var f=p(c);if(f===ge)return!1}return h},set(o,l,c,h){var f=t.get(l),u=l in o;if(s&&l==="length")for(var d=c;d<f.v;d+=1){var g=t.get(d+"");g!==void 0?ue(g,ge):d in o&&(g=a(()=>Me(ge)),t.set(d+"",g))}if(f===void 0)(!u||Hn(o,l)?.writable)&&(f=a(()=>Me(void 0)),ue(f,kt(c)),t.set(l,f));else{u=f.v!==ge;var _=a(()=>kt(c));ue(f,_)}var m=Reflect.getOwnPropertyDescriptor(o,l);if(m?.set&&m.set.call(h,c),!u){if(s&&typeof l=="string"){var v=t.get("length"),y=Number(l);Number.isInteger(y)&&y>=v.v&&ue(v,y+1)}Wn(r)}return!0},ownKeys(o){p(r);var l=Reflect.ownKeys(o).filter(f=>{var u=t.get(f);return u===void 0||u.v!==ge});for(var[c,h]of t)h.v!==ge&&!(c in o)&&l.push(c);return l},setPrototypeOf(){mu()}})}function Aa(n){try{if(n!==null&&typeof n=="object"&&Bt in n)return n[Bt]}catch{}return n}function Uu(n,e){return Object.is(Aa(n),Aa(e))}var Ra,No,Oo,$o;function ju(){if(Ra===void 0){Ra=window,No=/Firefox/.test(navigator.userAgent);var n=Element.prototype,e=Node.prototype,t=Text.prototype;Oo=Hn(e,"firstChild").get,$o=Hn(e,"nextSibling").get,Ca(n)&&(n.__click=void 0,n.__className=void 0,n.__attributes=null,n.__style=void 0,n.__e=void 0),Ca(t)&&(t.__t=void 0)}}function At(n=""){return document.createTextNode(n)}function vn(n){return Oo.call(n)}function Kn(n){return $o.call(n)}function w(n,e){return vn(n)}function Lt(n,e=!1){{var t=vn(n);return t instanceof Comment&&t.data===""?Kn(t):t}}function x(n,e=1,t=!1){let s=n;for(;e--;)s=Kn(s);return s}function qu(n){n.textContent=""}function Lo(){return!1}let Pa=!1;function Xu(){Pa||(Pa=!0,document.addEventListener("reset",n=>{Promise.resolve().then(()=>{if(!n.defaultPrevented)for(const e of n.target.elements)e.__on_r?.()})},{capture:!0}))}function Ks(n){var e=U,t=X;be(null),rt(null);try{return n()}finally{be(e),rt(t)}}function Gu(n,e,t,s=t){n.addEventListener(e,()=>Ks(t));const r=n.__on_r;r?n.__on_r=()=>{r(),s(!0)}:n.__on_r=()=>s(!0),Xu()}function Yu(n){X===null&&(U===null&&hu(),fu()),yn&&du()}function Vu(n,e){var t=e.last;t===null?e.last=e.first=n:(t.next=n,n.prev=t,e.last=n)}function gt(n,e,t){var s=X;s!==null&&(s.f&Te)!==0&&(n|=Te);var r={ctx:He,deps:null,nodes:null,f:n|ke|Ye,first:null,fn:e,last:null,next:null,parent:s,b:s&&s.b,prev:null,teardown:null,wv:0,ac:null};if(t)try{Gn(r),r.f|=ai}catch(o){throw xe(r),o}else e!==null&&qt(r);var i=r;if(t&&i.deps===null&&i.teardown===null&&i.nodes===null&&i.first===i.last&&(i.f&_n)===0&&(i=i.first,(n&ht)!==0&&(n&hn)!==0&&i!==null&&(i.f|=hn)),i!==null&&(i.parent=s,s!==null&&Vu(i,s),U!==null&&(U.f&de)!==0&&(n&Yt)===0)){var a=U;(a.effects??=[]).push(i)}return r}function qn(){return U!==null&&!tt}function di(n){const e=gt(ii,null,!1);return ve(e,me),e.teardown=n,e}function Ju(n){Yu();var e=X.f,t=!U&&(e&pt)!==0&&(e&ai)===0;if(t){var s=He;(s.e??=[]).push(n)}else return Fo(n)}function Fo(n){return gt(ri|lu,n,!1)}function Ku(n){et.ensure();const e=gt(Yt|_n,n,!0);return(t={})=>new Promise(s=>{t.outro?Ht(e,()=>{xe(e),s(void 0)}):(xe(e),s(void 0))})}function Qu(n){return gt(ri,n,!1)}function Zu(n){return gt(oi|_n,n,!0)}function fi(n,e=0){return gt(ii|e,n,!0)}function we(n,e=[],t=[],s=[]){Lu(s,e,t,r=>{gt(ii,()=>n(...r.map(p)),!0)})}function hi(n,e=0){var t=gt(ht|e,n,!0);return t}function De(n){return gt(pt|_n,n,!0)}function Do(n){var e=n.teardown;if(e!==null){const t=yn,s=U;Ia(!0),be(null);try{e.call(null)}finally{Ia(t),be(s)}}}function zo(n,e=!1){var t=n.first;for(n.first=n.last=null;t!==null;){const r=t.ac;r!==null&&Ks(()=>{r.abort(ln)});var s=t.next;(t.f&Yt)!==0?t.parent=null:xe(t,e),t=s}}function ed(n){for(var e=n.first;e!==null;){var t=e.next;(e.f&pt)===0&&xe(e),e=t}}function xe(n,e=!0){var t=!1;(e||(n.f&wo)!==0)&&n.nodes!==null&&n.nodes.end!==null&&(td(n.nodes.start,n.nodes.end),t=!0),zo(n,e&&!t),Fs(n,0),ve(n,Ct);var s=n.nodes&&n.nodes.t;if(s!==null)for(const i of s)i.stop();Do(n);var r=n.parent;r!==null&&r.first!==null&&Bo(n),n.next=n.prev=n.teardown=n.ctx=n.deps=n.fn=n.nodes=n.ac=null}function td(n,e){for(;n!==null;){var t=n===e?null:Kn(n);n.remove(),n=t}}function Bo(n){var e=n.parent,t=n.prev,s=n.next;t!==null&&(t.next=s),s!==null&&(s.prev=t),e!==null&&(e.first===n&&(e.first=s),e.last===n&&(e.last=t))}function Ht(n,e,t=!0){var s=[];Ho(n,s,!0);var r=()=>{t&&xe(n),e&&e()},i=s.length;if(i>0){var a=()=>--i||r();for(var o of s)o.out(a)}else r()}function Ho(n,e,t){if((n.f&Te)===0){n.f^=Te;var s=n.nodes&&n.nodes.t;if(s!==null)for(const o of s)(o.is_global||t)&&e.push(o);for(var r=n.first;r!==null;){var i=r.next,a=(r.f&hn)!==0||(r.f&pt)!==0&&(n.f&ht)!==0;Ho(r,e,a?t:!1),r=i}}}function pi(n){Wo(n,!0)}function Wo(n,e){if((n.f&Te)!==0){n.f^=Te,(n.f&me)===0&&(ve(n,ke),qt(n));for(var t=n.first;t!==null;){var s=t.next,r=(t.f&hn)!==0||(t.f&pt)!==0;Wo(t,r?e:!1),t=s}var i=n.nodes&&n.nodes.t;if(i!==null)for(const a of i)(a.is_global||e)&&a.in()}}function Uo(n,e){if(n.nodes)for(var t=n.nodes.start,s=n.nodes.end;t!==null;){var r=t===s?null:Kn(t);e.append(t),t=r}}let Wt=!1;function Ls(n){Wt=n}let yn=!1;function Ia(n){yn=n}let U=null,tt=!1;function be(n){U=n}let X=null;function rt(n){X=n}let dt=null;function jo(n){U!==null&&(dt===null?dt=[n]:dt.push(n))}let _e=null,Re=0,Fe=null;function nd(n){Fe=n}let qo=1,Xn=0,Ut=Xn;function Ma(n){Ut=n}function Xo(){return++qo}function Qn(n){var e=n.f;if((e&ke)!==0)return!0;if(e&de&&(n.f&=~jt),(e&st)!==0){var t=n.deps;if(t!==null)for(var s=t.length,r=0;r<s;r++){var i=t[r];if(Qn(i)&&Io(i),i.wv>n.wv)return!0}(e&Ye)!==0&&ze===null&&ve(n,me)}return!1}function Go(n,e,t=!0){var s=n.reactions;if(s!==null&&!dt?.includes(n))for(var r=0;r<s.length;r++){var i=s[r];(i.f&de)!==0?Go(i,e,!1):e===i&&(t?ve(i,ke):(i.f&me)!==0&&ve(i,st),qt(i))}}function Yo(n){var e=_e,t=Re,s=Fe,r=U,i=dt,a=He,o=tt,l=Ut,c=n.f;_e=null,Re=0,Fe=null,U=(c&(pt|Yt))===0?n:null,dt=null,pn(n.ctx),tt=!1,Ut=++Xn,n.ac!==null&&(Ks(()=>{n.ac.abort(ln)}),n.ac=null);try{n.f|=Tr;var h=n.fn,f=h(),u=n.deps;if(_e!==null){var d;if(Fs(n,Re),u!==null&&Re>0)for(u.length=Re+_e.length,d=0;d<_e.length;d++)u[Re+d]=_e[d];else n.deps=u=_e;if(qn()&&(n.f&Ye)!==0)for(d=Re;d<u.length;d++)(u[d].reactions??=[]).push(n)}else u!==null&&Re<u.length&&(Fs(n,Re),u.length=Re);if(Eo()&&Fe!==null&&!tt&&u!==null&&(n.f&(de|st|ke))===0)for(d=0;d<Fe.length;d++)Go(Fe[d],n);return r!==null&&r!==n&&(Xn++,Fe!==null&&(s===null?s=Fe:s.push(...Fe))),(n.f&Et)!==0&&(n.f^=Et),f}catch(g){return So(g)}finally{n.f^=Tr,_e=e,Re=t,Fe=s,U=r,dt=i,pn(a),tt=o,Ut=l}}function sd(n,e){let t=e.reactions;if(t!==null){var s=nu.call(t,n);if(s!==-1){var r=t.length-1;r===0?t=e.reactions=null:(t[s]=t[r],t.pop())}}t===null&&(e.f&de)!==0&&(_e===null||!_e.includes(e))&&(ve(e,st),(e.f&Ye)!==0&&(e.f^=Ye,e.f&=~jt),Po(e),Fs(e,0))}function Fs(n,e){var t=n.deps;if(t!==null)for(var s=e;s<t.length;s++)sd(n,t[s])}function Gn(n){var e=n.f;if((e&Ct)===0){ve(n,me);var t=X,s=Wt;X=n,Wt=!0;try{(e&(ht|ou))!==0?ed(n):zo(n),Do(n);var r=Yo(n);n.teardown=typeof r=="function"?r:null,n.wv=qo;var i;Mr&&Ru&&(n.f&ke)!==0&&n.deps}finally{Wt=s,X=t}}}function p(n){var e=n.f,t=(e&de)!==0;if(U!==null&&!tt){var s=X!==null&&(X.f&Ct)!==0;if(!s&&!dt?.includes(n)){var r=U.deps;if((U.f&Tr)!==0)n.rv<Xn&&(n.rv=Xn,_e===null&&r!==null&&r[Re]===n?Re++:_e===null?_e=[n]:_e.includes(n)||_e.push(n));else{(U.deps??=[]).push(n);var i=n.reactions;i===null?n.reactions=[U]:i.includes(U)||i.push(U)}}}if(yn){if(St.has(n))return St.get(n);if(t){var a=n,o=a.v;return((a.f&me)===0&&a.reactions!==null||Jo(a))&&(o=ui(a)),St.set(a,o),o}}else t&&(!ze?.has(n)||Q?.is_fork&&!qn())&&(a=n,Qn(a)&&Io(a),Wt&&qn()&&(a.f&Ye)===0&&Vo(a));if(ze?.has(n))return ze.get(n);if((n.f&Et)!==0)throw n.v;return n.v}function Vo(n){if(n.deps!==null){n.f^=Ye;for(const e of n.deps)(e.reactions??=[]).push(n),(e.f&de)!==0&&(e.f&Ye)===0&&Vo(e)}}function Jo(n){if(n.v===ge)return!0;if(n.deps===null)return!1;for(const e of n.deps)if(St.has(e)||(e.f&de)!==0&&Jo(e))return!0;return!1}function Qs(n){var e=tt;try{return tt=!0,n()}finally{tt=e}}const rd=-7169;function ve(n,e){n.f=n.f&rd|e}function id(n){if(!(typeof n!="object"||!n||n instanceof EventTarget)){if(Bt in n)$r(n);else if(!Array.isArray(n))for(let e in n){const t=n[e];typeof t=="object"&&t&&Bt in t&&$r(t)}}}function $r(n,e=new Set){if(typeof n=="object"&&n!==null&&!(n instanceof EventTarget)&&!e.has(n)){e.add(n),n instanceof Date&&n.getTime();for(let s in n)try{$r(n[s],e)}catch{}const t=si(n);if(t!==Object.prototype&&t!==Array.prototype&&t!==Map.prototype&&t!==Set.prototype&&t!==Date.prototype){const s=_o(t);for(let r in s){const i=s[r].get;if(i)try{i.call(n)}catch{}}}}}const ad=["touchstart","touchmove"];function od(n){return ad.includes(n)}const Ko=new Set,Lr=new Set;function ld(n,e,t,s={}){function r(i){if(s.capture||Tn.call(e,i),!i.cancelBubble)return Ks(()=>t?.call(this,i))}return n.startsWith("pointer")||n.startsWith("touch")||n==="wheel"?Jn(()=>{e.addEventListener(n,r,s)}):e.addEventListener(n,r,s),r}function Ue(n,e,t,s,r){var i={capture:s,passive:r},a=ld(n,e,t,i);(e===document.body||e===window||e===document||e instanceof HTMLMediaElement)&&di(()=>{e.removeEventListener(n,a,i)})}function gi(n){for(var e=0;e<n.length;e++)Ko.add(n[e]);for(var t of Lr)t(n)}let Ta=null;function Tn(n){var e=this,t=e.ownerDocument,s=n.type,r=n.composedPath?.()||[],i=r[0]||n.target;Ta=n;var a=0,o=Ta===n&&n.__root;if(o){var l=r.indexOf(o);if(l!==-1&&(e===document||e===window)){n.__root=e;return}var c=r.indexOf(e);if(c===-1)return;l<=c&&(a=l)}if(i=r[a]||n.target,i!==e){su(n,"currentTarget",{configurable:!0,get(){return i||t}});var h=U,f=X;be(null),rt(null);try{for(var u,d=[];i!==null;){var g=i.assignedSlot||i.parentNode||i.host||null;try{var _=i["__"+s];_!=null&&(!i.disabled||n.target===i)&&_.call(i,n)}catch(m){u?d.push(m):u=m}if(n.cancelBubble||g===e||g===null)break;i=g}if(u){for(let m of d)queueMicrotask(()=>{throw m});throw u}}finally{n.__root=e,delete n.currentTarget,be(h),rt(f)}}}function Qo(n){var e=document.createElement("template");return e.innerHTML=n.replaceAll("<!>","<!---->"),e.content}function Ds(n,e){var t=X;t.nodes===null&&(t.nodes={start:n,end:e,a:null,t:null})}function oe(n,e){var t=(e&ku)!==0,s=(e&Cu)!==0,r,i=!n.startsWith("<!>");return()=>{r===void 0&&(r=Qo(i?n:"<!>"+n),t||(r=vn(r)));var a=s||No?document.importNode(r,!0):r.cloneNode(!0);if(t){var o=vn(a),l=a.lastChild;Ds(o,l)}else Ds(a,a);return a}}function cd(n,e,t="svg"){var s=!n.startsWith("<!>"),r=`<${t}>${s?n:"<!>"+n}</${t}>`,i;return()=>{if(!i){var a=Qo(r),o=vn(a);i=vn(o)}var l=i.cloneNode(!0);return Ds(l,l),l}}function wn(n,e){return cd(n,e,"svg")}function zs(){var n=document.createDocumentFragment(),e=document.createComment(""),t=At();return n.append(e,t),Ds(e,t),n}function q(n,e){n!==null&&n.before(e)}function xt(n,e){var t=e==null?"":typeof e=="object"?e+"":e;t!==(n.__t??=n.nodeValue)&&(n.__t=t,n.nodeValue=t+"")}function ud(n,e){return dd(n,e)}const en=new Map;function dd(n,{target:e,anchor:t,props:s={},events:r,context:i,intro:a=!0}){ju();var o=new Set,l=f=>{for(var u=0;u<f.length;u++){var d=f[u];if(!o.has(d)){o.add(d);var g=od(d);e.addEventListener(d,Tn,{passive:g});var _=en.get(d);_===void 0?(document.addEventListener(d,Tn,{passive:g}),en.set(d,1)):en.set(d,_+1)}}};l(Gs(Ko)),Lr.add(l);var c=void 0,h=Ku(()=>{var f=t??e.appendChild(At());return Ou(f,{pending:()=>{}},u=>{if(i){Vs({});var d=He;d.c=i}r&&(s.$$events=r),c=n(u,s)||{},i&&Js()}),()=>{for(var u of o){e.removeEventListener(u,Tn);var d=en.get(u);--d===0?(document.removeEventListener(u,Tn),en.delete(u)):en.set(u,d)}Lr.delete(l),f!==t&&f.parentNode?.removeChild(f)}});return Fr.set(c,h),c}let Fr=new WeakMap;function Na(n,e){const t=Fr.get(n);return t?(Fr.delete(n),t(e)):Promise.resolve()}class fd{anchor;#e=new Map;#t=new Map;#s=new Map;#n=new Set;#l=!0;constructor(e,t=!0){this.anchor=e,this.#l=t}#i=()=>{var e=Q;if(this.#e.has(e)){var t=this.#e.get(e),s=this.#t.get(t);if(s)pi(s),this.#n.delete(t);else{var r=this.#s.get(t);r&&(this.#t.set(t,r.effect),this.#s.delete(t),r.fragment.lastChild.remove(),this.anchor.before(r.fragment),s=r.effect)}for(const[i,a]of this.#e){if(this.#e.delete(i),i===e)break;const o=this.#s.get(a);o&&(xe(o.effect),this.#s.delete(a))}for(const[i,a]of this.#t){if(i===t||this.#n.has(i))continue;const o=()=>{if(Array.from(this.#e.values()).includes(i)){var c=document.createDocumentFragment();Uo(a,c),c.append(At()),this.#s.set(i,{effect:a,fragment:c})}else xe(a);this.#n.delete(i),this.#t.delete(i)};this.#l||!s?(this.#n.add(i),Ht(a,o,!1)):o()}}};#r=e=>{this.#e.delete(e);const t=Array.from(this.#e.values());for(const[s,r]of this.#s)t.includes(s)||(xe(r.effect),this.#s.delete(s))};ensure(e,t){var s=Q,r=Lo();if(t&&!this.#t.has(e)&&!this.#s.has(e))if(r){var i=document.createDocumentFragment(),a=At();i.append(a),this.#s.set(e,{effect:De(()=>t(a)),fragment:i})}else this.#t.set(e,De(()=>t(this.anchor)));if(this.#e.set(s,e),r){for(const[o,l]of this.#t)o===e?s.skipped_effects.delete(l):s.skipped_effects.add(l);for(const[o,l]of this.#s)o===e?s.skipped_effects.delete(l.effect):s.skipped_effects.add(l.effect);s.oncommit(this.#i),s.ondiscard(this.#r)}else this.#i()}}function Ie(n,e,t=!1){var s=new fd(n),r=t?hn:0;function i(a,o){s.ensure(a,o)}hi(()=>{var a=!1;e((o,l=!0)=>{a=!0,i(l,o)}),a||i(!1,null)},r)}function Ss(n,e){return e}function hd(n,e,t){for(var s=[],r=e.length,i,a=e.length,o=0;o<r;o++){let f=e[o];Ht(f,()=>{if(i){if(i.pending.delete(f),i.done.add(f),i.pending.size===0){var u=n.outrogroups;Dr(Gs(i.done)),u.delete(i),u.size===0&&(n.outrogroups=null)}}else a-=1},!1)}if(a===0){var l=s.length===0&&t!==null;if(l){var c=t,h=c.parentNode;qu(h),h.append(c),n.items.clear()}Dr(e,!l)}else i={pending:new Set(e),done:new Set},(n.outrogroups??=new Set).add(i)}function Dr(n,e=!0){for(var t=0;t<n.length;t++)xe(n[t],e)}var Oa;function Dt(n,e,t,s,r,i=null){var a=n,o=new Map,l=(e&bo)!==0;if(l){var c=n;a=c.appendChild(At())}var h=null,f=zu(()=>{var v=t();return ni(v)?v:v==null?[]:Gs(v)}),u,d=!0;function g(){m.fallback=h,pd(m,u,a,e,s),h!==null&&(u.length===0?(h.f&ut)===0?pi(h):(h.f^=ut,Nn(h,null,a)):Ht(h,()=>{h=null}))}var _=hi(()=>{u=p(f);for(var v=u.length,y=new Set,A=Q,k=Lo(),R=0;R<v;R+=1){var I=u[R],M=s(I,R),C=d?null:o.get(M);C?(C.v&&mn(C.v,I),C.i&&mn(C.i,R),k&&A.skipped_effects.delete(C.e)):(C=gd(o,d?a:Oa??=At(),I,M,R,r,e,t),d||(C.e.f|=ut),o.set(M,C)),y.add(M)}if(v===0&&i&&!h&&(d?h=De(()=>i(a)):(h=De(()=>i(Oa??=At())),h.f|=ut)),!d)if(k){for(const[T,O]of o)y.has(T)||A.skipped_effects.add(O.e);A.oncommit(g),A.ondiscard(()=>{})}else g();p(f)}),m={effect:_,items:o,outrogroups:null,fallback:h};d=!1}function pd(n,e,t,s,r){var i=(s&bu)!==0,a=e.length,o=n.items,l=n.effect.first,c,h=null,f,u=[],d=[],g,_,m,v;if(i)for(v=0;v<a;v+=1)g=e[v],_=r(g,v),m=o.get(_).e,(m.f&ut)===0&&(m.nodes?.a?.measure(),(f??=new Set).add(m));for(v=0;v<a;v+=1){if(g=e[v],_=r(g,v),m=o.get(_).e,n.outrogroups!==null)for(const O of n.outrogroups)O.pending.delete(m),O.done.delete(m);if((m.f&ut)!==0)if(m.f^=ut,m===l)Nn(m,null,t);else{var y=h?h.next:l;m===n.effect.last&&(n.effect.last=m.prev),m.prev&&(m.prev.next=m.next),m.next&&(m.next.prev=m.prev),_t(n,h,m),_t(n,m,y),Nn(m,y,t),h=m,u=[],d=[],l=h.next;continue}if((m.f&Te)!==0&&(pi(m),i&&(m.nodes?.a?.unfix(),(f??=new Set).delete(m))),m!==l){if(c!==void 0&&c.has(m)){if(u.length<d.length){var A=d[0],k;h=A.prev;var R=u[0],I=u[u.length-1];for(k=0;k<u.length;k+=1)Nn(u[k],A,t);for(k=0;k<d.length;k+=1)c.delete(d[k]);_t(n,R.prev,I.next),_t(n,h,R),_t(n,I,A),l=A,h=I,v-=1,u=[],d=[]}else c.delete(m),Nn(m,l,t),_t(n,m.prev,m.next),_t(n,m,h===null?n.effect.first:h.next),_t(n,h,m),h=m;continue}for(u=[],d=[];l!==null&&l!==m;)(c??=new Set).add(l),d.push(l),l=l.next;if(l===null)continue}(m.f&ut)===0&&u.push(m),h=m,l=m.next}if(n.outrogroups!==null){for(const O of n.outrogroups)O.pending.size===0&&(Dr(Gs(O.done)),n.outrogroups?.delete(O));n.outrogroups.size===0&&(n.outrogroups=null)}if(l!==null||c!==void 0){var M=[];if(c!==void 0)for(m of c)(m.f&Te)===0&&M.push(m);for(;l!==null;)(l.f&Te)===0&&l!==n.fallback&&M.push(l),l=l.next;var C=M.length;if(C>0){var T=(s&bo)!==0&&a===0?t:null;if(i){for(v=0;v<C;v+=1)M[v].nodes?.a?.measure();for(v=0;v<C;v+=1)M[v].nodes?.a?.fix()}hd(n,M,T)}}i&&Jn(()=>{if(f!==void 0)for(m of f)m.nodes?.a?.apply()})}function gd(n,e,t,s,r,i,a,o){var l=(a&yu)!==0?(a&xu)===0?Hu(t,!1,!1):Xt(t):null,c=(a&wu)!==0?Xt(r):null;return{v:l,i:c,e:De(()=>(i(e,l??t,c??r,o),()=>{n.delete(s)}))}}function Nn(n,e,t){if(n.nodes)for(var s=n.nodes.start,r=n.nodes.end,i=e&&(e.f&ut)===0?e.nodes.start:t;s!==null;){var a=Kn(s);if(i.before(s),s===r)return;s=a}}function _t(n,e,t){e===null?n.effect.first=t:e.next=t,t===null?n.effect.last=e:t.prev=e}function Mn(n,e,t){Qu(()=>{var s=Qs(()=>e(n,t?.())||{});if(t&&s?.update){var r=!1,i={};fi(()=>{var a=t();id(a),r&&ko(i,a)&&(i=a,s.update(a))}),r=!0}if(s?.destroy)return()=>s.destroy()})}const $a=[...` 	
\r\f¬†\v\uFEFF`];function md(n,e,t){var s=n==null?"":""+n;if(e&&(s=s?s+" "+e:e),t){for(var r in t)if(t[r])s=s?s+" "+r:r;else if(s.length)for(var i=r.length,a=0;(a=s.indexOf(r,a))>=0;){var o=a+i;(a===0||$a.includes(s[a-1]))&&(o===s.length||$a.includes(s[o]))?s=(a===0?"":s.substring(0,a))+s.substring(o+1):a=o}}return s===""?null:s}function vd(n,e){return n==null?null:String(n)}function $e(n,e,t,s,r,i){var a=n.__className;if(a!==t||a===void 0){var o=md(t,s,i);o==null?n.removeAttribute("class"):n.className=o,n.__className=t}else if(i&&r!==i)for(var l in i){var c=!!i[l];(r==null||c!==!!r[l])&&n.classList.toggle(l,c)}return i}function La(n,e,t,s){var r=n.__style;if(r!==e){var i=vd(e);i==null?n.removeAttribute("style"):n.style.cssText=i,n.__style=e}return s}function zr(n,e,t=!1){if(n.multiple){if(e==null)return;if(!ni(e))return Su();for(var s of n.options)s.selected=e.includes(Da(s));return}for(s of n.options){var r=Da(s);if(Uu(r,e)){s.selected=!0;return}}(!t||e!==void 0)&&(n.selectedIndex=-1)}function Fa(n){var e=new MutationObserver(()=>{zr(n,n.__value)});e.observe(n,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["value"]}),di(()=>{e.disconnect()})}function Da(n){return"__value"in n?n.__value:n.value}const _d=Symbol("is custom element"),yd=Symbol("is html");function je(n,e){var t=Zo(n);t.value===(t.value=e??void 0)||n.value===e&&(e!==0||n.nodeName!=="PROGRESS")||(n.value=e??"")}function Le(n,e,t,s){var r=Zo(n);r[e]!==(r[e]=t)&&(e==="loading"&&(n[cu]=t),t==null?n.removeAttribute(e):typeof t!="string"&&wd(n).includes(e)?n[e]=t:n.setAttribute(e,t))}function Zo(n){return n.__attributes??={[_d]:n.nodeName.includes("-"),[yd]:n.namespaceURI===Eu}}var za=new Map;function wd(n){var e=n.getAttribute("is")||n.nodeName,t=za.get(e);if(t)return t;za.set(e,t=[]);for(var s,r=n,i=Element.prototype;i!==r;){s=_o(r);for(var a in s)s[a].set&&t.push(a);r=si(r)}return t}function Nt(n,e,t=e){Gu(n,"change",s=>{var r=s?n.defaultChecked:n.checked;t(r)}),Qs(e)==null&&t(n.checked),fi(()=>{var s=e();n.checked=!!s})}function Ba(n,e,t,s){var r=s,i=!0,a=()=>(i&&(i=!1,r=s),r),o;o=n[e],o===void 0&&s!==void 0&&(o=a());var l;return l=()=>{var c=n[e];return c===void 0?a():(i=!0,c)},l}const bd="5";typeof window<"u"&&((window.__svelte??={}).v??=new Set).add(bd);var mi=(n=>(n.Role="role",n.Model="model",n))(mi||{});const Ha="vibe-canvas-badge-container",Wa="vibe-canvas-bottom-badge-container",xd="canvas-badges";function Bs(n){const e=n?.contentEl??null,t=n.nodeEl;if(!e)return null;let s=e.querySelector(`.${Ha}`);return s||(s=document.createElement("div"),s.className=Ha,s.setAttribute("aria-label",xd),e.prepend(s),t.classList.add("cai-badge-container")),s}function vr(n){const e=n?.contentEl??null;if(!e)return null;let t=e.querySelector(`.${Wa}`);return t||(t=document.createElement("div"),t.className=Wa,t.setAttribute("aria-label","canvas-bottom-badges"),e.appendChild(t)),t}function As(n,e){const t=Bs(n);return t?e.shouldShow(n)?e.createOrUpdateBadge(t,n):(e.removeBadge(t),null):null}function kd(n,e){const t=Bs(n);t&&(e.forEach(s=>{s.shouldShow(n)?s.createOrUpdateBadge(t,n):s.removeBadge(t)}),t.children.length===0&&t.remove())}function Ua(n,e){n?.nodes&&n.nodes.forEach(t=>{kd(t,e)})}const _r="vibe-canvas-role-badge",yr="badge-type";class Cd{constructor(){this.type=mi.Role}shouldShow(e){return ft(e)!==null}createOrUpdateBadge(e,t){const s=ft(t);if(!s)return null;let r=e.querySelector(`.${_r}[data-${yr}="${this.type}"]`);return r||(r=document.createElement("div"),r.className=_r,r.setAttribute(`data-${yr}`,this.type),r.setAttribute("aria-label","canvas-role"),e.appendChild(r)),r.textContent=this.getRoleBadgeText(s),r}removeBadge(e){e.querySelector(`.${_r}[data-${yr}="${this.type}"]`)?.remove()}getRoleBadgeText(e){switch(e){case"user":return"üë§ user";case"assistant":return"ü§ñ assistant";case"system":return"üñ•Ô∏è system";default:return""}}}function el(){return new Cd}const Ot="vibe-canvas-model-badge",Ed="badge-type";class Sd{constructor(e){this.type=mi.Model,this.plugin=null,this.plugin=e??null}shouldShow(e){const t=ft(e);return t==="user"?!0:t==="assistant"?Xa(e)!==null:!1}createOrUpdateBadge(e,t){const s=ft(t);if(s!=="user"&&s!=="assistant")return null;const r=s==="user",i=r?vr(t):Bs(t);if(!i)return null;const a=r?this.resolveUserModel(t):Xa(t);if(!r&&!a)return null;r?Bs(t)?.querySelector(`.${Ot}`)?.remove():vr(t)?.querySelector(`.${Ot}`)?.remove();let o=i.querySelector(`.${Ot}`);o||(o=this.createBadgeElement(i,r));const l=r?"‚öôÔ∏è":"‚ú®";return o.textContent=a?`${l} ${a}`:`${l} ÈÄâÊã©Ê®°Âûã`,r&&this.plugin&&!o.hasAttribute("data-bound")&&(o.setAttribute("data-bound","true"),o.addEventListener("click",c=>{c.stopPropagation(),this.openModelSelector(o,t)})),o}removeBadge(e){e.querySelector(`.${Ot}`)?.remove();const t=e.parentElement;t&&(e.classList.contains("vibe-canvas-badge-container")?t.querySelector(".vibe-canvas-bottom-badge-container")?.querySelector(`.${Ot}`)?.remove():e.classList.contains("vibe-canvas-bottom-badge-container")&&t.querySelector(".vibe-canvas-badge-container")?.querySelector(`.${Ot}`)?.remove())}resolveUserModel(e){const t=Br(e);if(t)return t;const s=this.getCanvasLastModel(e);return s?(e.unknownData||(e.unknownData={}),e.unknownData._cai_user_model=s,s):this.plugin?.settings.defaultModelId??null}getCanvasLastModel(e){const t=e.canvas;return!t||typeof t.getData!="function"?null:t.getData()._cai_lastUserModel??null}createBadgeElement(e,t){const s=document.createElement("div");return s.className=Ot,s.setAttribute(`data-${Ed}`,this.type),t&&(s.classList.add("clickable"),s.setAttribute("title","ÁÇπÂáªÈÄâÊã©Ê®°Âûã")),e.appendChild(s),s}openModelSelector(e,t){if(!this.plugin)return;document.querySelector(".vibe-canvas-model-dropdown")?.remove();const s=this.plugin.settings.models;if(s.length===0)return;const r=Br(t),i=t.canvas,a=document.createElement("div");a.className="vibe-canvas-model-dropdown",s.forEach(c=>{const h=document.createElement("div");h.className="vibe-canvas-model-dropdown-item",c.id===r&&h.classList.add("selected"),h.textContent=c.label?`${c.id}Ôºà${c.label}Ôºâ`:c.id,h.addEventListener("click",f=>{f.stopPropagation(),Hd(t,c.id,i);const u=vr(t);u&&this.createOrUpdateBadge(u,t),a.remove()}),a.appendChild(h)}),document.body.appendChild(a);const o=e.getBoundingClientRect();Object.assign(a.style,{position:"fixed",top:`${o.bottom+4}px`,left:`${o.left}px`,zIndex:"10000"});const l=c=>{!a.contains(c.target)&&c.target!==e&&(a.remove(),document.removeEventListener("click",l))};setTimeout(()=>document.addEventListener("click",l),0)}}function Ad(n){return new Sd(n)}const Rd=el();function Pd(n){if(!n)return"";if(typeof n.text=="string")return n.text;if(typeof n.getText=="function"){const e=n.getText.call(n);if(typeof e=="string")return e}return""}function Id(n){const e=n?.unknownData?._cai_role;return e==="user"||e==="assistant"||e==="system"?e:"user"}function Md(n,e,t){if(!n||!e||typeof n.createTextNode!="function")return{node:null,fromSide:"right",toSide:"left"};const s=t.assistantWidth,r=t.assistantHeight,i=Ld(n,e,s,r);return{node:n.createTextNode({pos:i.pos,size:{width:s,height:r},position:"center",text:"",save:!0,focus:!0})??null,fromSide:i.fromSide,toSide:i.toSide}}function Td(n,e,t,s="right",r="left"){if(!n||!e||!t||typeof n.getData!="function")return;const i=n.getData();if(!i)return;const a=Array.isArray(i.edges)?i.edges:[],o={id:Fd(a),fromNode:e.id,toNode:t.id,fromSide:s,toSide:r,toEnd:"arrow"};i.edges.push(o),n.setData(i),n.requestFrame?.()}function ja(n,e,t){n&&(typeof n.setText=="function"?n.setText(e):n.text=e,t?.requestFrame?.(),t?.requestSave?.())}function qa(n,e,t=!1){if(!n.trim())return e;const s=n.split(`
`).map(a=>`> ${a}`).join(`
`),i=`${t?"> [!note]- Thinking":"> [!note] Thinking"}
${s}`;return e.trim()?`${i}

${e}`:i}function Nd(n){return n?n.from!==void 0&&n.to!==void 0:!1}function Od(n,e){const t=n.edgeTo?.get?.(e);if(!t||t.size===0)return null;const s=t.values().next().value;if(!s)return null;const r=s.to?.side;return r==="top"?"bottom":"right"}function $d(n,e){const t=n.edgeFrom?.get?.(e);if(!t||t.size===0)return[];const s=[];for(const r of t){const i=r.to?.node;i&&s.push(i)}return s}function Ld(n,e,t,s){const a=e.x??0,o=e.y??0,l=e.width??t,c=e.height??s,h=Od(n,e),f=$d(n,e);let u,d,g,_;return h==="bottom"?(g="bottom",_="top",d=o+c+100+s/2,f.length===0?u=a+l/2:u=Math.max(...f.map(v=>(v.x??0)+(v.width??t)))+50+t/2):(g="right",_="left",u=a+l+100+t/2,f.length===0?d=o+c/2:d=Math.max(...f.map(v=>(v.y??0)+(v.height??s)))+50+s/2),{pos:{x:u,y:d},fromSide:g,toSide:_}}function Fd(n){let e="";do e=`edge-${Date.now().toString(36)}-${Math.random().toString(36).slice(2,8)}`;while(n.some(t=>t.id===e));return e}function Dd(n,e,t,s){n.unknownData||(n.unknownData={}),n.unknownData._cai_role=e,s&&(e==="user"?(n.width<s.userWidth&&(n.width=s.userWidth),n.height<s.userHeight&&(n.height=s.userHeight)):e==="assistant"&&(n.width<s.assistantWidth&&(n.width=s.assistantWidth),n.height<s.assistantHeight&&(n.height=s.assistantHeight))),As(n,Rd),n.render(),t?.requestSave?.()}function ft(n){const e=n?.unknownData?._cai_role;return e==="user"||e==="assistant"||e==="system"?e:null}function zd(n){return n==="assistant"?"Ê†áËÆ∞‰∏∫Âä©Êâã":n==="system"?"Ê†áËÆ∞‰∏∫Á≥ªÁªüÊèêÁ§∫":"Ê†áËÆ∞‰∏∫Áî®Êà∑"}function Bd(n,e,t){n.unknownData||(n.unknownData={}),n.unknownData._cai_model=e,n.render(),t?.requestSave?.()}function Xa(n){const e=n?.unknownData?._cai_model;return typeof e=="string"&&e.length>0?e:null}function Hd(n,e,t){n.unknownData||(n.unknownData={}),n.unknownData._cai_user_model=e,t&&typeof t.getData=="function"&&Wd(t,e),n.render(),t?.requestSave?.()}function Br(n){const e=n?.unknownData?._cai_user_model;return typeof e=="string"&&e.length>0?e:null}function Wd(n,e){if(!n||typeof n.getData!="function"||typeof n.setData!="function")return;const t=n.getData();t._cai_lastUserModel=e,n.setData(t)}const Hr=[{id:"ai",icon:"sparkles",tooltip:"AI ÊèêÈóÆ"},{id:"user",icon:"user",tooltip:"Ê†áËÆ∞‰∏∫Áî®Êà∑",isRole:!0},{id:"assistant",icon:"bot",tooltip:"Ê†áËÆ∞‰∏∫Âä©Êâã",isRole:!0},{id:"system",icon:"monitor",tooltip:"Ê†áËÆ∞‰∏∫Á≥ªÁªüÊèêÁ§∫",isRole:!0},{id:"arrangeLayout",icon:"network",tooltip:"Êï¥ÁêÜÂ∏ÉÂ±Ä"}];function Ud(n,e){return n.isRole&&e?zd(e):n.tooltip}var jd=oe('<button class="mock-btn svelte-g54mgz"></button>'),qd=oe('<button class="mock-grid-btn svelte-g54mgz"></button>'),Xd=oe('<div class="mock-dropdown svelte-g54mgz"><div class="mock-grid-label svelte-g54mgz">Êõ¥Â§öÊìç‰Ωú</div> <div class="mock-grid svelte-g54mgz"></div></div>'),Gd=oe('<button><div class="qa-item-icon svelte-g54mgz"></div> <div class="qa-item-info svelte-g54mgz"><div class="qa-item-label svelte-g54mgz"> </div></div> <div class="qa-item-toggle svelte-g54mgz"><div class="toggle-icon"></div></div></button>'),Yd=oe('<div class="qa-container svelte-g54mgz"><div class="qa-preview-section"><div class="qa-section-header svelte-g54mgz"><span class="qa-title svelte-g54mgz">È¢ÑËßà (Preview)</span> <span class="qa-subtitle svelte-g54mgz">Ê®°ÊãüÈÄâ‰∏≠Âç°ÁâáÊó∂ÁöÑËèúÂçïÊ†è</span></div> <div class="canvas-mock svelte-g54mgz"><div class="mock-node svelte-g54mgz"><div class="mock-menu-bar svelte-g54mgz"><!> <div class="mock-divider svelte-g54mgz"></div> <div class="mock-more-container svelte-g54mgz"><button class="mock-btn mock-more-btn svelte-g54mgz" title="Êõ¥Â§ö"></button> <!></div></div> <div class="mock-content svelte-g54mgz"><div class="mock-line svelte-g54mgz" style="width: 80%"></div> <div class="mock-line svelte-g54mgz" style="width: 60%"></div> <div class="mock-line svelte-g54mgz" style="width: 90%"></div></div></div></div></div> <div class="qa-config-section"><div class="qa-section-header svelte-g54mgz"><span class="qa-title svelte-g54mgz">ÈÖçÁΩÆ (Config)</span> <span class="qa-subtitle svelte-g54mgz">ÁÇπÂáªÂàáÊç¢ÊòæÁ§∫‰ΩçÁΩÆ</span></div> <div class="qa-list svelte-g54mgz"></div></div></div>');function Vd(n,e){Vs(e,!0);const t=Hr.map(v=>({id:v.id,icon:v.icon,label:v.tooltip}));function s(v){e.onChange({...e.value,[v]:!e.value[v]})}function r(v,y){return te.setIcon(v,y),{update(A){v.empty(),te.setIcon(v,A)}}}var i=Yd(),a=w(i),o=x(w(a),2),l=w(o),c=w(l),h=w(c);Dt(h,17,()=>t,Ss,(v,y)=>{var A=zs(),k=Lt(A);{var R=I=>{var M=jd();Mn(M,(C,T)=>r?.(C,T),()=>p(y).icon),we(()=>Le(M,"title",p(y).label)),q(I,M)};Ie(k,I=>{e.value[p(y).id]&&I(R)})}q(v,A)});var f=x(h,4),u=w(f);Mn(u,(v,y)=>r?.(v,y),()=>"lucide-more-horizontal");var d=x(u,2);{var g=v=>{var y=Xd(),A=x(w(y),2);Dt(A,21,()=>t,Ss,(k,R)=>{var I=zs(),M=Lt(I);{var C=T=>{var O=qd();Mn(O,(W,Ce)=>r?.(W,Ce),()=>p(R).icon),we(()=>Le(O,"title",p(R).label)),q(T,O)};Ie(M,T=>{e.value[p(R).id]||T(C)})}q(k,I)}),q(v,y)};Ie(d,v=>{t.some(y=>!e.value[y.id])&&v(g)})}var _=x(a,2),m=x(w(_),2);Dt(m,21,()=>t,Ss,(v,y)=>{var A=Gd();A.__click=()=>s(p(y).id);var k=w(A);Mn(k,(O,W)=>r?.(O,W),()=>p(y).icon);var R=x(k,2),I=w(R),M=w(I),C=x(R,2),T=w(C);Mn(T,(O,W)=>r?.(O,W),()=>e.value[p(y).id]?"eye":"eye-off"),we(()=>{$e(A,1,`qa-config-item ${e.value[p(y).id]?"is-primary":"is-secondary"}`,"svelte-g54mgz"),xt(M,p(y).label)}),q(v,A)}),q(n,i),Js()}gi(["click"]);var Jd=oe('<div class="ns-preview-wrapper svelte-wrwebx"><div class="ns-header svelte-wrwebx"><div class="ns-title-group"><span class="ns-main-title svelte-wrwebx">Â∏ÉÂ±ÄÈ¢ÑËßà</span> <span class="ns-desc svelte-wrwebx">‰∫§‰∫íÂºèË∞ÉÊï¥ËäÇÁÇπÁöÑÈªòËÆ§ÂÆΩÈ´ò (È¢ÑËßàÊØî‰æã 50%)</span></div></div> <div class="canvas-container svelte-wrwebx"><div class="canvas-bg svelte-wrwebx"></div> <div class="canvas-content svelte-wrwebx"><div class="mock-node user-node svelte-wrwebx"><div class="node-header svelte-wrwebx"><span class="node-icon svelte-wrwebx">üë§</span> <span class="node-type svelte-wrwebx">User Node</span></div> <div class="node-body svelte-wrwebx"><div class="dim-badge svelte-wrwebx"> </div></div> <div class="handle h-right svelte-wrwebx"></div> <div class="handle h-bottom svelte-wrwebx"></div> <div class="handle h-corner svelte-wrwebx"></div></div> <div class="mock-node assistant-node svelte-wrwebx"><div class="node-header svelte-wrwebx"><span class="node-icon svelte-wrwebx">ü§ñ</span> <span class="node-type svelte-wrwebx">Assistant Node</span></div> <div class="node-body svelte-wrwebx"><div class="dim-badge svelte-wrwebx"> </div> <div class="mock-text svelte-wrwebx"></div> <div class="mock-text short svelte-wrwebx"></div></div> <div class="handle h-right svelte-wrwebx"></div> <div class="handle h-bottom svelte-wrwebx"></div> <div class="handle h-corner svelte-wrwebx"></div></div></div></div></div>');function Kd(n,e){Vs(e,!0);const t=.5;let s=Me(null);function r(C,T,O){C.preventDefault(),C.stopPropagation();const W=T==="user"?e.value.userWidth:e.value.assistantWidth,Ce=T==="user"?e.value.userHeight:e.value.assistantHeight;ue(s,{node:T,handle:O,startX:C.clientX,startY:C.clientY,startWidth:W,startHeight:Ce},!0)}function i(C){if(!p(s))return;const T=(C.clientX-p(s).startX)/t,O=(C.clientY-p(s).startY)/t;let W=p(s).startWidth,Ce=p(s).startHeight;(p(s).handle==="right"||p(s).handle==="corner")&&(W=Math.max(50,p(s).startWidth+T)),(p(s).handle==="bottom"||p(s).handle==="corner")&&(Ce=Math.max(50,p(s).startHeight+O));const Ne={...e.value};p(s).node==="user"?(Ne.userWidth=Math.round(W),Ne.userHeight=Math.round(Ce)):(Ne.assistantWidth=Math.round(W),Ne.assistantHeight=Math.round(Ce)),e.onChange(Ne)}function a(){ue(s,null)}Ju(()=>{if(p(s))return window.addEventListener("mousemove",i),window.addEventListener("mouseup",a),()=>{window.removeEventListener("mousemove",i),window.removeEventListener("mouseup",a)}});var o=Jd(),l=x(w(o),2),c=x(w(l),2),h=w(c),f=x(w(h),2),u=w(f),d=w(u),g=x(f,2);g.__mousedown=C=>r(C,"user","right");var _=x(g,2);_.__mousedown=C=>r(C,"user","bottom");var m=x(_,2);m.__mousedown=C=>r(C,"user","corner");var v=x(h,2),y=x(w(v),2),A=w(y),k=w(A),R=x(y,2);R.__mousedown=C=>r(C,"assistant","right");var I=x(R,2);I.__mousedown=C=>r(C,"assistant","bottom");var M=x(I,2);M.__mousedown=C=>r(C,"assistant","corner"),we(()=>{La(h,`width: ${e.value.userWidth*t}px; height: ${e.value.userHeight*t}px;`),xt(d,`${e.value.userWidth??""} √ó ${e.value.userHeight??""}`),La(v,`width: ${e.value.assistantWidth*t}px; height: ${e.value.assistantHeight*t}px;`),xt(k,`${e.value.assistantWidth??""} √ó ${e.value.assistantHeight??""}`)}),q(n,o),Js()}gi(["mousedown"]);var Qd=oe('<span class="status-ok svelte-1y8kcgz"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg> Ê†°È™åÈÄöËøá</span>'),Zd=oe('<span class="status-warn svelte-1y8kcgz"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg> </span>'),ef=oe("<option> </option>"),tf=oe("<option> </option>"),nf=wn('<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="spinning svelte-1y8kcgz"><circle cx="12" cy="12" r="10"></circle><path d="M12 6v6l4 2"></path></svg>'),sf=wn('<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>'),rf=wn('<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>'),af=wn('<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>'),of=wn('<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"></path><circle cx="12" cy="12" r="3"></circle></svg>'),lf=wn('<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9.88 9.88a3 3 0 1 0 4.24 4.24"></path><path d="M10.73 5.08A10.43 10.43 0 0 1 12 5c7.18 0 12 7 12 7a13.16 13.16 0 0 1-1.67 2.68"></path><path d="M6.61 6.61A13.526 13.526 0 0 0 2 12s3 7 10 7a9.74 9.74 0 0 0 5.39-1.61"></path><line x1="2" x2="22" y1="2" y2="22"></line></svg>'),cf=oe('<div class="model-card svelte-1y8kcgz"><div class="card-header svelte-1y8kcgz"><div class="model-id-input svelte-1y8kcgz"><input type="text" placeholder="Ê®°ÂûãID (Â¶Ç gpt-4o)" aria-label="Ê®°ÂûãID" class="svelte-1y8kcgz"/></div> <div class="card-actions svelte-1y8kcgz"><button title="ÊµãËØïÊ®°ÂûãËøûÊé•"><!></button> <button class="icon-btn svelte-1y8kcgz" title="Â§çÂà∂ÈÖçÁΩÆ"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg></button> <button class="icon-btn danger svelte-1y8kcgz" title="Âà†Èô§Ê®°Âûã"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"></path><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path></svg></button></div></div> <div class="card-body svelte-1y8kcgz"><div class="field-group svelte-1y8kcgz"><label class="svelte-1y8kcgz">ÊòæÁ§∫Ê†áÁ≠æ</label> <input type="text" placeholder="Ëá™ÂÆö‰πâÊòæÁ§∫ÂêçÁß∞" class="svelte-1y8kcgz"/></div> <div class="field-group svelte-1y8kcgz"><label class="svelte-1y8kcgz">Endpoint</label> <input type="text" placeholder="https://api.openai.com/v1" class="svelte-1y8kcgz"/></div> <div class="field-group svelte-1y8kcgz"><label class="svelte-1y8kcgz">API Key</label> <div class="api-key-input-wrapper svelte-1y8kcgz"><input placeholder="sk-..." class="svelte-1y8kcgz"/> <button type="button" class="password-toggle-btn svelte-1y8kcgz"><!></button></div></div> <div class="field-group svelte-1y8kcgz"><label class="svelte-1y8kcgz">Context Window</label> <input type="number" min="1" class="svelte-1y8kcgz"/></div></div> <div class="card-footer svelte-1y8kcgz"><span class="label svelte-1y8kcgz">ËÉΩÂäõ:</span> <div class="checkbox-group svelte-1y8kcgz"><label class="svelte-1y8kcgz"><div role="button" tabindex="0"><input type="checkbox" class="svelte-1y8kcgz"/></div> ÊµÅÂºè</label> <label class="svelte-1y8kcgz"><div role="button" tabindex="0"><input type="checkbox" class="svelte-1y8kcgz"/></div> ÂáΩÊï∞</label> <label class="svelte-1y8kcgz"><div role="button" tabindex="0"><input type="checkbox" class="svelte-1y8kcgz"/></div> ËßÜËßâ</label> <label class="svelte-1y8kcgz"><div role="button" tabindex="0"><input type="checkbox" class="svelte-1y8kcgz"/></div> ÁîüÂõæ</label></div></div></div>'),uf=oe('<section class="settings-group svelte-1y8kcgz"><div class="setting-item svelte-1y8kcgz"><div class="setting-item-info svelte-1y8kcgz"><div class="setting-item-name svelte-1y8kcgz">ÈªòËÆ§ÊñáÊú¨Ê®°Âûã</div> <div class="setting-item-description svelte-1y8kcgz">Áî®‰∫é‰∏ÄËà¨ÂØπËØùÂíåÊñáÊú¨ÁîüÊàêÁöÑÈªòËÆ§Ê®°Âûã„ÄÇ</div></div> <div class="setting-item-control svelte-1y8kcgz"><select class="svelte-1y8kcgz"></select></div></div> <div class="setting-item svelte-1y8kcgz"><div class="setting-item-info svelte-1y8kcgz"><div class="setting-item-name svelte-1y8kcgz">ÂõæÂÉèÊ®°Âûã</div> <div class="setting-item-description svelte-1y8kcgz">Áî®‰∫éÂõæÂÉèÁîüÊàêÁöÑÊ®°ÂûãÔºàÂèØÈÄâÔºâ„ÄÇÈúÄÂú®Ê®°ÂûãÂç°Áâá‰∏≠ÂºÄÂêØ"ÁîüÂõæ"ËÉΩÂäõ„ÄÇ</div></div> <div class="setting-item-control svelte-1y8kcgz"><select class="svelte-1y8kcgz"><option>Êú™ÈÄâÊã©</option><!></select></div></div> <div class="setting-item vertical svelte-1y8kcgz"><div class="setting-item-info svelte-1y8kcgz"><div class="setting-item-name svelte-1y8kcgz">ÂÖ®Â±ÄÁ≥ªÁªüÊèêÁ§∫</div> <div class="setting-item-description svelte-1y8kcgz">ÊâÄÊúâÂØπËØùÈÉΩ‰ºöÊê∫Â∏¶ÁöÑÁ≥ªÁªüÁ∫ßÊåá‰ª§ÔºàSystem PromptÔºâ„ÄÇ</div></div> <div class="setting-item-control full-width svelte-1y8kcgz"><div class="textarea-wrapper svelte-1y8kcgz"><textarea rows="4" class="svelte-1y8kcgz"></textarea> <div class="counter svelte-1y8kcgz"> </div></div></div></div></section> <section class="settings-group svelte-1y8kcgz"><div class="group-header svelte-1y8kcgz"><h3 class="svelte-1y8kcgz">Ê®°ÂûãÂàóË°®</h3> <button>Êñ∞Â¢ûÊ®°Âûã</button></div> <div class="models-grid svelte-1y8kcgz"></div></section>',1),df=oe('<section class="settings-group svelte-1y8kcgz"><h3 class="section-title svelte-1y8kcgz">ÈÄöÁî®Ë°å‰∏∫</h3> <div class="setting-item svelte-1y8kcgz"><div class="setting-item-info svelte-1y8kcgz"><div class="setting-item-name svelte-1y8kcgz">Â±ïÂºÄÂµåÂ•óÂºïÁî®</div> <div class="setting-item-description svelte-1y8kcgz">ÂºÄÂêØÂêéÔºåÁõ∏ÂÖ≥ÂëΩ‰ª§ÈªòËÆ§Ëá™Âä®Â±ïÂºÄ [[ÂºïÁî®]] ÁöÑÂÜÖÂÆπ„ÄÇ</div></div> <div class="setting-item-control svelte-1y8kcgz"><div role="button" tabindex="0"><input type="checkbox" class="svelte-1y8kcgz"/></div></div></div> <div class="setting-item svelte-1y8kcgz"><div class="setting-item-info svelte-1y8kcgz"><div class="setting-item-name svelte-1y8kcgz">‰∏ä‰∏ãÊñáÊà™Êñ≠ÊèêÈÜí</div> <div class="setting-item-description svelte-1y8kcgz">ÂΩì‰∏ä‰∏ãÊñáË∂ÖËøáÊ®°ÂûãÈôêÂà∂Ë¢´Ë£ÅÂâ™Êó∂ÔºåÊòæÁ§∫ÊèêÁ§∫‰ø°ÊÅØ„ÄÇ</div></div> <div class="setting-item-control svelte-1y8kcgz"><div role="button" tabindex="0"><input type="checkbox" class="svelte-1y8kcgz"/></div></div></div></section> <section class="settings-group svelte-1y8kcgz"><h3 class="section-title svelte-1y8kcgz">Canvas Âø´Êç∑Âä®‰ΩúÊ†è</h3> <div class="setting-item-description svelte-1y8kcgz" style="margin-bottom: 12px;">ÈÄâÊã©Áõ¥Êé•ÊòæÁ§∫Âú®Âç°Áâá‰∏äÊñπËèúÂçïÊ†èÁöÑÊåâÈíÆ„ÄÇÊú™ÈÄâ‰∏≠ÁöÑÊåâÈíÆÂ∞ÜÊî∂Á∫≥Ëá≥"Êõ¥Â§öÊìç‰Ωú"ËèúÂçï‰∏≠„ÄÇ</div> <!></section> <section class="settings-group svelte-1y8kcgz"><h3 class="section-title svelte-1y8kcgz">ËäÇÁÇπÂ∞∫ÂØ∏ÈÖçÁΩÆ</h3> <div class="setting-item-description svelte-1y8kcgz" style="margin-bottom: 12px;">ÈÖçÁΩÆ Canvas ËäÇÁÇπÁöÑÈªòËÆ§Â∞∫ÂØ∏„ÄÇÂèØ‰ª•ÈÄöËøáÈ¢ÑËßàÂå∫ÂüüÊãñÊãΩË∞ÉÊï¥„ÄÇ</div> <!> <div class="node-size-grid svelte-1y8kcgz"><div class="ns-group svelte-1y8kcgz"><h4 class="ns-group-title svelte-1y8kcgz">User ÈªòËÆ§Â∞∫ÂØ∏</h4> <div class="ns-row svelte-1y8kcgz"><div class="input-group svelte-1y8kcgz"><label for="u-width" class="svelte-1y8kcgz">ÂÆΩÂ∫¶</label> <input id="u-width" type="number" class="svelte-1y8kcgz"/></div> <div class="input-group svelte-1y8kcgz"><label for="u-height" class="svelte-1y8kcgz">È´òÂ∫¶</label> <input id="u-height" type="number" class="svelte-1y8kcgz"/></div></div></div> <div class="ns-group svelte-1y8kcgz"><h4 class="ns-group-title svelte-1y8kcgz">Assistant ÈªòËÆ§Â∞∫ÂØ∏</h4> <div class="ns-row svelte-1y8kcgz"><div class="input-group svelte-1y8kcgz"><label for="a-width" class="svelte-1y8kcgz">ÂÆΩÂ∫¶</label> <input id="a-width" type="number" class="svelte-1y8kcgz"/></div> <div class="input-group svelte-1y8kcgz"><label for="a-height" class="svelte-1y8kcgz">È´òÂ∫¶</label> <input id="a-height" type="number" class="svelte-1y8kcgz"/></div></div></div></div></section>',1),ff=oe('<div class="setting-item svelte-1y8kcgz"><div class="setting-item-info svelte-1y8kcgz"><div class="setting-item-name svelte-1y8kcgz">Êó•ÂøóÁïôÂ≠òÊù°Êï∞</div> <div class="setting-item-description svelte-1y8kcgz">ÊúÄÂ§ö‰øùÁïôÂ§öÂ∞ëÊù°ÂéÜÂè≤ËÆ∞ÂΩïÔºà1-200Ôºâ„ÄÇ</div></div> <div class="setting-item-control svelte-1y8kcgz"><input type="number" min="1" max="200" class="svelte-1y8kcgz"/></div></div> <div class="setting-item svelte-1y8kcgz"><div class="setting-item-info svelte-1y8kcgz"><div class="setting-item-name svelte-1y8kcgz">Êó•ÂøóÊìç‰Ωú</div></div> <div class="setting-item-control svelte-1y8kcgz"><button>Êü•ÁúãÊó•Âøó</button> <button style="margin-left: 8px;">Ê∏ÖÁ©∫</button></div></div>',1),hf=oe('<section class="settings-group svelte-1y8kcgz"><div class="setting-item svelte-1y8kcgz"><div class="setting-item-info svelte-1y8kcgz"><div class="setting-item-name svelte-1y8kcgz">ÂêØÁî®Ë∞ÉËØïÊó•Âøó</div> <div class="setting-item-description svelte-1y8kcgz">ËÆ∞ÂΩïÊúÄËøëÁöÑ‰∫§‰∫íÊëòË¶ÅÔºåÁî®‰∫éÊéíÊü•ÈóÆÈ¢ò„ÄÇ</div></div> <div class="setting-item-control svelte-1y8kcgz"><div role="button" tabindex="0"><input type="checkbox" class="svelte-1y8kcgz"/></div></div></div> <!></section>'),pf=oe("<li> </li>"),gf=oe('<section class="settings-group error-panel svelte-1y8kcgz"><h3 class="error-title svelte-1y8kcgz">ÈÖçÁΩÆÊ†°È™åÈîôËØØ</h3> <ul class="svelte-1y8kcgz"></ul></section>'),mf=oe('<div class="caret-settings svelte-1y8kcgz"><header class="settings-nav svelte-1y8kcgz"><div class="tabs svelte-1y8kcgz"><button>Ê®°ÂûãÈÖçÁΩÆ</button> <button>‰∫§‰∫í‰∏éË°å‰∏∫</button> <button>Ë∞ÉËØï‰∏éÊó•Âøó</button></div> <div class="header-actions svelte-1y8kcgz"><!></div></header> <div class="settings-container"><!> <!> <!> <!></div></div>');function vf(n,e){Vs(e,!0);function t(){}function s(b){return{models:b.models.map(E=>({...E})),defaultModelId:b.defaultModelId,imageModelId:b.imageModelId,systemPrompt:b.systemPrompt,expandNestedRefs:b.expandNestedRefs,warnOnContextTrim:b.warnOnContextTrim,debugLog:{...b.debugLog},quickActions:{...b.quickActions},nodeSize:{...b.nodeSize}}}const r=Ba(e,"initialSettings",3,K),i=Ba(e,"onChange",3,t);let a=Me("models"),o=Me(kt(Qs(()=>s(r()))));const l=mr(()=>W(p(o)));let c=Me(kt({})),h=Me(kt({})),f=null;function u(){f&&clearTimeout(f),f=setTimeout(async()=>{p(l).length===0&&await i()(s(p(o))),f=null},500)}async function d(){await i()(s(p(o)))}const g=mr(()=>p(o).models.map((b,E)=>({model:b,index:E}))),_=mr(()=>p(o).models.filter(b=>b.imageGeneration));function m(b){const E=new Set(p(o).models.map(B=>B.id));let $=b,z=1;for(;E.has($);)$=`${b}-${z}`,z+=1;return $}function v(b){const E=s(p(o));b(E),y(E),ue(o,E,!0)}function y(b){if(b.models.length===0)return;const E=b.models.map($=>$.id);if(E.includes(b.defaultModelId)||(b.defaultModelId=E[0]),b.imageModelId){const $=b.models.find(z=>z.id===b.imageModelId);(!$||!$.imageGeneration)&&(b.imageModelId="")}}async function A(){v(b=>{b.models.push({...Os,id:m("model"),label:"",apiKey:""})}),await d()}async function k(b){v(E=>{const $=E.models[b];E.models.push({...$,id:m(`${$.id}-copy`)})}),await d()}async function R(b){confirm(`Á°ÆËÆ§Âà†Èô§Ê®°Âûã ${p(o).models[b].id}Ôºü`)&&(v(E=>{E.models.splice(b,1),E.models.length===0&&E.models.push({...Os,id:m("model"),label:"",apiKey:""})}),await d())}function I(b,E){const $=E.trim(),z=p(o).models[b].id;if($!==z&&$){if(p(o).models.some((B,V)=>V!==b&&B.id===$)){new te.Notice("Ê®°Âûã ID Â∑≤Â≠òÂú®");return}v(B=>{B.models[b].id=$,B.defaultModelId===z&&(B.defaultModelId=$),B.imageModelId===z&&(B.imageModelId=$)})}}function M(b,E,$){v(z=>{z.models[b]={...z.models[b],[E]:$}})}function C(b,E){const $=Number.parseInt(E,10);M(b,"contextTokens",Number.isFinite($)?$:0)}async function T(b){if(!e.plugin?.aiService){new te.Notice("AI ÊúçÂä°Êú™ÂàùÂßãÂåñ");return}const E=p(o).models[b];if(!E.endpoint.trim()||!E.apiKey.trim()){new te.Notice("ËØ∑ÂÖàÂ°´ÂÜô endpoint Âíå API key");return}p(c)[b]="loading",ue(c,{...p(c)},!0);try{const $=await e.plugin.aiService.testModel(E);p(c)[b]=$.success?"success":"error",ue(c,{...p(c)},!0),new te.Notice($.message,$.success?3e3:5e3)}catch($){p(c)[b]="error",ue(c,{...p(c)},!0),new te.Notice(`ÊµãËØïÂ§±Ë¥•Ôºö${$ instanceof Error?$.message:"Êú™Áü•ÈîôËØØ"}`)}}function O(b){p(h)[b]=!p(h)[b],ue(h,{...p(h)},!0)}function W(b){const E=[],$=new Set;if(b.models.length===0&&E.push("Ëá≥Â∞ëÈúÄË¶Å‰∏Ä‰∏™Ê®°Âûã„ÄÇ"),b.models.forEach((B,V)=>{const he=B.id||`Ê®°Âûã${V+1}`;if(B.id.trim()?$.has(B.id)?E.push(`Ê®°Âûã ID ÈáçÂ§çÔºö${B.id}`):$.add(B.id):E.push(`Ê®°Âûã ${V+1}ÔºöÊ®°Âûã ID ‰∏çËÉΩ‰∏∫Á©∫`),!B.endpoint.trim())E.push(`Ê®°Âûã ${he}ÔºöEndpoint ‰∏çËÉΩ‰∏∫Á©∫`);else try{new URL(B.endpoint)}catch{E.push(`Ê®°Âûã ${he}ÔºöEndpoint ‰∏çÊòØÊúâÊïà URL`)}B.apiKey.trim()||E.push(`Ê®°Âûã ${he}ÔºöAPI key ‰∏çËÉΩ‰∏∫Á©∫`),(!Number.isInteger(B.contextTokens)||B.contextTokens<=0)&&E.push(`Ê®°Âûã ${he}Ôºö‰∏ä‰∏ãÊñáÁ™óÂè£ÈúÄ‰∏∫Ê≠£Êï¥Êï∞`)}),b.defaultModelId&&!$.has(b.defaultModelId)&&E.push("ÈªòËÆ§ÊñáÊú¨Ê®°ÂûãÊú™ÊåáÂêëÂ∑≤Â≠òÂú®ÁöÑÊ®°Âûã„ÄÇ"),b.imageModelId)if(!$.has(b.imageModelId))E.push("ÂõæÂÉèÊ®°ÂûãÊú™ÊåáÂêëÂ∑≤Â≠òÂú®ÁöÑÊ®°Âûã„ÄÇ");else{const B=b.models.find(V=>V.id===b.imageModelId);B&&!B.imageGeneration&&E.push("ÂõæÂÉèÊ®°ÂûãÂøÖÈ°ªÊîØÊåÅÂõæÂÉèÁîüÊàêËÉΩÂäõ„ÄÇ")}b.systemPrompt.length>4e3&&E.push("ÂÖ®Â±ÄÁ≥ªÁªüÊèêÁ§∫ÈïøÂ∫¶Ë∂ÖÂá∫ 4000 ÈôêÂà∂„ÄÇ"),(!Number.isInteger(b.debugLog.limit)||b.debugLog.limit<1||b.debugLog.limit>200)&&E.push("Ë∞ÉËØïÊó•ÂøóÁïôÂ≠ò‰∏äÈôêÈúÄÂú® 1-200 ‰πãÈó¥„ÄÇ");const{nodeSize:z}=b;return(!Number.isInteger(z.userWidth)||z.userWidth<50||z.userWidth>2e3)&&E.push("User ËäÇÁÇπÂÆΩÂ∫¶ÈúÄÂú® 50-2000 ‰πãÈó¥„ÄÇ"),(!Number.isInteger(z.userHeight)||z.userHeight<50||z.userHeight>2e3)&&E.push("User ËäÇÁÇπÈ´òÂ∫¶ÈúÄÂú® 50-2000 ‰πãÈó¥„ÄÇ"),(!Number.isInteger(z.assistantWidth)||z.assistantWidth<50||z.assistantWidth>2e3)&&E.push("Assistant ËäÇÁÇπÂÆΩÂ∫¶ÈúÄÂú® 50-2000 ‰πãÈó¥„ÄÇ"),(!Number.isInteger(z.assistantHeight)||z.assistantHeight<50||z.assistantHeight>2e3)&&E.push("Assistant ËäÇÁÇπÈ´òÂ∫¶ÈúÄÂú® 50-2000 ‰πãÈó¥„ÄÇ"),E}var Ce=mf(),Ne=w(Ce),as=w(Ne),Vt=w(as);Vt.__click=()=>ue(a,"models");var fr=x(Vt,2);fr.__click=()=>ue(a,"behavior");var ea=x(fr,2);ea.__click=()=>ue(a,"debug");var kc=x(as,2),Cc=w(kc);{var Ec=b=>{var E=Qd();q(b,E)},Sc=b=>{var E=Zd(),$=x(w(E));we(()=>xt($,` ${p(l).length??""} ‰∏™ÈîôËØØ`)),q(b,E)};Ie(Cc,b=>{p(l).length===0?b(Ec):b(Sc,!1)})}var Ac=x(Ne,2),ta=w(Ac);{var Rc=b=>{var E=uf(),$=Lt(E),z=w($),B=x(w(z),2),V=w(B);V.__change=async ee=>{v(Y=>Y.defaultModelId=ee.currentTarget.value),await d()},Dt(V,21,()=>p(o).models,ee=>ee.id,(ee,Y)=>{var F=ef(),H=w(F),Oe={};we(()=>{xt(H,p(Y).label?`${p(Y).id}Ôºà${p(Y).label}Ôºâ`:p(Y).id),Oe!==(Oe=p(Y).id)&&(F.value=(F.__value=p(Y).id)??"")}),q(ee,F)});var he;Fa(V);var it=x(z,2),Cn=x(w(it),2),ie=w(Cn);ie.__change=async ee=>{v(Y=>Y.imageModelId=ee.currentTarget.value),await d()};var We=w(ie);We.value=We.__value="";var Mt=x(We);Dt(Mt,17,()=>p(_),ee=>ee.id,(ee,Y)=>{var F=tf(),H=w(F),Oe={};we(()=>{xt(H,p(Y).label?`${p(Y).id}Ôºà${p(Y).label}Ôºâ`:p(Y).id),Oe!==(Oe=p(Y).id)&&(F.value=(F.__value=p(Y).id)??"")}),q(ee,F)});var Tt;Fa(ie);var mt=x(it,2),En=x(w(mt),2),Sn=w(En),Ve=w(Sn);Ve.__input=ee=>v(Y=>Y.systemPrompt=ee.currentTarget.value);var An=x(Ve,2),at=w(An),Rn=x($,2),Pn=w(Rn),In=x(w(Pn),2);In.__click=A;var hr=x(Pn,2);Dt(hr,21,()=>p(g),({model:ee,index:Y})=>ee.id,(ee,Y)=>{let F=()=>p(Y).model,H=()=>p(Y).index;var Oe=cf(),os=w(Oe),Jt=w(os),G=w(Jt);G.__input=S=>{I(H(),S.currentTarget.value)};var le=x(Jt,2),Ee=w(le);Ee.__click=()=>T(H());var Nc=w(Ee);{var Oc=S=>{var vt=nf();q(S,vt)},$c=S=>{var vt=zs(),qc=Lt(vt);{var Xc=Qt=>{var gs=sf();q(Qt,gs)},Gc=Qt=>{var gs=zs(),Yc=Lt(gs);{var Vc=Zt=>{var gr=rf();q(Zt,gr)},Jc=Zt=>{var gr=af();q(Zt,gr)};Ie(Yc,Zt=>{p(c)[H()]==="error"?Zt(Vc):Zt(Jc,!1)},!0)}q(Qt,gs)};Ie(qc,Qt=>{p(c)[H()]==="success"?Qt(Xc):Qt(Gc,!1)},!0)}q(S,vt)};Ie(Nc,S=>{p(c)[H()]==="loading"?S(Oc):S($c,!1)})}var ra=x(Ee,2);ra.__click=()=>k(H());var Lc=x(ra,2);Lc.__click=()=>R(H());var ia=x(os,2),aa=w(ia),oa=w(aa),ls=x(oa,2);ls.__input=S=>M(H(),"label",S.currentTarget.value);var la=x(aa,2),ca=w(la),cs=x(ca,2);cs.__input=S=>M(H(),"endpoint",S.currentTarget.value.trim());var ua=x(la,2),da=w(ua),Fc=x(da,2),Kt=w(Fc);Kt.__input=S=>M(H(),"apiKey",S.currentTarget.value.trim());var pr=x(Kt,2);pr.__click=()=>O(H());var Dc=w(pr);{var zc=S=>{var vt=of();q(S,vt)},Bc=S=>{var vt=lf();q(S,vt)};Ie(Dc,S=>{p(h)[H()]?S(zc):S(Bc,!1)})}var Hc=x(ua,2),fa=w(Hc),us=x(fa,2);us.__input=S=>C(H(),S.currentTarget.value);var Wc=x(ia,2),Uc=x(w(Wc),2),ha=w(Uc),ds=w(ha);let pa;ds.__click=S=>{S.stopPropagation(),F().streaming=!F().streaming,d()},ds.__keydown=S=>{(S.key==="Enter"||S.key===" ")&&(S.preventDefault(),S.stopPropagation(),F().streaming=!F().streaming,d())};var ga=w(ds);ga.__change=d;var ma=x(ha,2),fs=w(ma);let va;fs.__click=S=>{S.stopPropagation(),F().functionCalling=!F().functionCalling,d()},fs.__keydown=S=>{(S.key==="Enter"||S.key===" ")&&(S.preventDefault(),S.stopPropagation(),F().functionCalling=!F().functionCalling,d())};var _a=w(fs);_a.__change=d;var ya=x(ma,2),hs=w(ya);let wa;hs.__click=S=>{S.stopPropagation(),F().vision=!F().vision,d()},hs.__keydown=S=>{(S.key==="Enter"||S.key===" ")&&(S.preventDefault(),S.stopPropagation(),F().vision=!F().vision,d())};var ba=w(hs);ba.__change=d;var jc=x(ya,2),ps=w(jc);let xa;ps.__click=S=>{S.stopPropagation(),F().imageGeneration=!F().imageGeneration,d()},ps.__keydown=S=>{(S.key==="Enter"||S.key===" ")&&(S.preventDefault(),S.stopPropagation(),F().imageGeneration=!F().imageGeneration,d())};var ka=w(ps);ka.__change=d,we(S=>{je(G,F().id),$e(Ee,1,`icon-btn test-btn ${p(c)[H()]==="loading"?"loading":""} ${p(c)[H()]==="success"?"success":""} ${p(c)[H()]==="error"?"error":""}`,"svelte-1y8kcgz"),Ee.disabled=S,Le(oa,"for",`model-${H()}-label`),Le(ls,"id",`model-${H()}-label`),je(ls,F().label),Le(ca,"for",`model-${H()}-endpoint`),Le(cs,"id",`model-${H()}-endpoint`),je(cs,F().endpoint),Le(da,"for",`model-${H()}-api-key`),Le(Kt,"id",`model-${H()}-api-key`),Le(Kt,"type",p(h)[H()]?"text":"password"),je(Kt,F().apiKey),Le(pr,"title",p(h)[H()]?"ÈöêËóèÂØÜÁ†Å":"ÊòæÁ§∫ÂØÜÁ†Å"),Le(fa,"for",`model-${H()}-context`),Le(us,"id",`model-${H()}-context`),je(us,F().contextTokens),pa=$e(ds,1,"checkbox-container",null,pa,{"is-enabled":F().streaming}),va=$e(fs,1,"checkbox-container",null,va,{"is-enabled":F().functionCalling}),wa=$e(hs,1,"checkbox-container",null,wa,{"is-enabled":F().vision}),xa=$e(ps,1,"checkbox-container",null,xa,{"is-enabled":F().imageGeneration})},[()=>p(c)[H()]==="loading"||!F().endpoint.trim()||!F().apiKey.trim()]),Ue("blur",G,u),Ue("blur",ls,u),Ue("blur",cs,u),Ue("blur",Kt,u),Ue("blur",us,u),Nt(ga,()=>F().streaming,S=>F().streaming=S),Nt(_a,()=>F().functionCalling,S=>F().functionCalling=S),Nt(ba,()=>F().vision,S=>F().vision=S),Nt(ka,()=>F().imageGeneration,S=>F().imageGeneration=S),q(ee,Oe)}),we(()=>{he!==(he=p(o).defaultModelId)&&(V.value=(V.__value=p(o).defaultModelId)??"",zr(V,p(o).defaultModelId)),Tt!==(Tt=p(o).imageModelId)&&(ie.value=(ie.__value=p(o).imageModelId)??"",zr(ie,p(o).imageModelId)),je(Ve,p(o).systemPrompt),xt(at,`${p(o).systemPrompt.length??""}/4000`)}),Ue("blur",Ve,u),q(b,E)};Ie(ta,b=>{p(a)==="models"&&b(Rc)})}var na=x(ta,2);{var Pc=b=>{var E=df(),$=Lt(E),z=x(w($),2),B=x(w(z),2),V=w(B);let he;V.__click=()=>{p(o).expandNestedRefs=!p(o).expandNestedRefs,d()},V.__keydown=G=>{(G.key==="Enter"||G.key===" ")&&(G.preventDefault(),p(o).expandNestedRefs=!p(o).expandNestedRefs,d())};var it=w(V);it.__change=d;var Cn=x(z,2),ie=x(w(Cn),2),We=w(ie);let Mt;We.__click=()=>{p(o).warnOnContextTrim=!p(o).warnOnContextTrim,d()},We.__keydown=G=>{(G.key==="Enter"||G.key===" ")&&(G.preventDefault(),p(o).warnOnContextTrim=!p(o).warnOnContextTrim,d())};var Tt=w(We);Tt.__change=d;var mt=x($,2),En=x(w(mt),4);Vd(En,{get value(){return p(o).quickActions},onChange:async G=>{v(le=>{le.quickActions=G}),await d()}});var Sn=x(mt,2),Ve=x(w(Sn),4);Kd(Ve,{get value(){return p(o).nodeSize},onChange:async G=>{v(le=>{le.nodeSize=G}),await d()}});var An=x(Ve,2),at=w(An),Rn=x(w(at),2),Pn=w(Rn),In=x(w(Pn),2);In.__input=G=>{const le=Number.parseInt(G.currentTarget.value,10);Number.isNaN(le)||v(Ee=>{Ee.nodeSize.userWidth=le})};var hr=x(Pn,2),ee=x(w(hr),2);ee.__input=G=>{const le=Number.parseInt(G.currentTarget.value,10);Number.isNaN(le)||v(Ee=>{Ee.nodeSize.userHeight=le})};var Y=x(at,2),F=x(w(Y),2),H=w(F),Oe=x(w(H),2);Oe.__input=G=>{const le=Number.parseInt(G.currentTarget.value,10);Number.isNaN(le)||v(Ee=>{Ee.nodeSize.assistantWidth=le})};var os=x(H,2),Jt=x(w(os),2);Jt.__input=G=>{const le=Number.parseInt(G.currentTarget.value,10);Number.isNaN(le)||v(Ee=>{Ee.nodeSize.assistantHeight=le})},we(()=>{he=$e(V,1,"checkbox-container",null,he,{"is-enabled":p(o).expandNestedRefs}),Mt=$e(We,1,"checkbox-container",null,Mt,{"is-enabled":p(o).warnOnContextTrim}),je(In,p(o).nodeSize.userWidth),je(ee,p(o).nodeSize.userHeight),je(Oe,p(o).nodeSize.assistantWidth),je(Jt,p(o).nodeSize.assistantHeight)}),Nt(it,()=>p(o).expandNestedRefs,G=>p(o).expandNestedRefs=G),Nt(Tt,()=>p(o).warnOnContextTrim,G=>p(o).warnOnContextTrim=G),Ue("blur",In,u),Ue("blur",ee,u),Ue("blur",Oe,u),Ue("blur",Jt,u),q(b,E)};Ie(na,b=>{p(a)==="behavior"&&b(Pc)})}var sa=x(na,2);{var Ic=b=>{var E=hf(),$=w(E),z=x(w($),2),B=w(z);let V;B.__click=()=>{p(o).debugLog.enabled=!p(o).debugLog.enabled,d()},B.__keydown=ie=>{(ie.key==="Enter"||ie.key===" ")&&(ie.preventDefault(),p(o).debugLog.enabled=!p(o).debugLog.enabled,d())};var he=w(B);he.__change=d;var it=x($,2);{var Cn=ie=>{var We=ff(),Mt=Lt(We),Tt=x(w(Mt),2),mt=w(Tt);mt.__input=at=>v(Rn=>Rn.debugLog.limit=Number.parseInt(at.currentTarget.value,10)||0);var En=x(Mt,2),Sn=x(w(En),2),Ve=w(Sn);Ve.__click=async()=>{const at=e.plugin?.debugLogger?.getEntries()??[];new te.Notice(at.length===0?"ÊöÇÊó†Êó•Âøó":at.join(`
`),5e3)};var An=x(Ve,2);An.__click=async()=>{await e.plugin?.debugLogger?.clear(),new te.Notice("Êó•ÂøóÂ∑≤Ê∏ÖÁ©∫")},we(()=>je(mt,p(o).debugLog.limit)),Ue("blur",mt,u),q(ie,We)};Ie(it,ie=>{p(o).debugLog.enabled&&ie(Cn)})}we(()=>V=$e(B,1,"checkbox-container",null,V,{"is-enabled":p(o).debugLog.enabled})),Nt(he,()=>p(o).debugLog.enabled,ie=>p(o).debugLog.enabled=ie),q(b,E)};Ie(sa,b=>{p(a)==="debug"&&b(Ic)})}var Mc=x(sa,2);{var Tc=b=>{var E=gf(),$=x(w(E),2);Dt($,21,()=>p(l),Ss,(z,B,V)=>{var he=pf(),it=w(he);we(()=>xt(it,`${V+1}. ${p(B)??""}`)),q(z,he)}),q(b,E)};Ie(Mc,b=>{p(l).length>0&&b(Tc)})}we(()=>{$e(Vt,1,`tab ${p(a)==="models"?"active":""}`,"svelte-1y8kcgz"),$e(fr,1,`tab ${p(a)==="behavior"?"active":""}`,"svelte-1y8kcgz"),$e(ea,1,`tab ${p(a)==="debug"?"active":""}`,"svelte-1y8kcgz")}),q(n,Ce),Js()}gi(["click","change","input","keydown"]);class _f extends te.PluginSettingTab{constructor(e,t){super(e,t),this.plugin=t}display(){const{containerEl:e}=this;e.empty(),this.component&&(Na(this.component),this.component=void 0),this.component=ud(vf,{target:e,props:{initialSettings:this.plugin.settings,plugin:this.plugin,onChange:async t=>{this.plugin.settings=t,await this.plugin.saveSettings()}}})}hide(){this.component&&(Na(this.component),this.component=void 0)}}const Wr="RFC3986",Ur={RFC1738:n=>String(n).replace(/%20/g,"+"),RFC3986:n=>String(n)},yf="RFC1738",wf=Array.isArray,Je=(()=>{const n=[];for(let e=0;e<256;++e)n.push("%"+((e<16?"0":"")+e.toString(16)).toUpperCase());return n})(),wr=1024,bf=(n,e,t,s,r)=>{if(n.length===0)return n;let i=n;if(typeof n=="symbol"?i=Symbol.prototype.toString.call(n):typeof n!="string"&&(i=String(n)),t==="iso-8859-1")return escape(i).replace(/%u[0-9a-f]{4}/gi,function(o){return"%26%23"+parseInt(o.slice(2),16)+"%3B"});let a="";for(let o=0;o<i.length;o+=wr){const l=i.length>=wr?i.slice(o,o+wr):i,c=[];for(let h=0;h<l.length;++h){let f=l.charCodeAt(h);if(f===45||f===46||f===95||f===126||f>=48&&f<=57||f>=65&&f<=90||f>=97&&f<=122||r===yf&&(f===40||f===41)){c[c.length]=l.charAt(h);continue}if(f<128){c[c.length]=Je[f];continue}if(f<2048){c[c.length]=Je[192|f>>6]+Je[128|f&63];continue}if(f<55296||f>=57344){c[c.length]=Je[224|f>>12]+Je[128|f>>6&63]+Je[128|f&63];continue}h+=1,f=65536+((f&1023)<<10|l.charCodeAt(h)&1023),c[c.length]=Je[240|f>>18]+Je[128|f>>12&63]+Je[128|f>>6&63]+Je[128|f&63]}a+=c.join("")}return a};function xf(n){return!n||typeof n!="object"?!1:!!(n.constructor&&n.constructor.isBuffer&&n.constructor.isBuffer(n))}function Ga(n,e){if(wf(n)){const t=[];for(let s=0;s<n.length;s+=1)t.push(e(n[s]));return t}return e(n)}const kf=Object.prototype.hasOwnProperty,tl={brackets(n){return String(n)+"[]"},comma:"comma",indices(n,e){return String(n)+"["+e+"]"},repeat(n){return String(n)}},Qe=Array.isArray,Cf=Array.prototype.push,nl=function(n,e){Cf.apply(n,Qe(e)?e:[e])},Ef=Date.prototype.toISOString,se={addQueryPrefix:!1,allowDots:!1,allowEmptyArrays:!1,arrayFormat:"indices",charset:"utf-8",charsetSentinel:!1,delimiter:"&",encode:!0,encodeDotInKeys:!1,encoder:bf,encodeValuesOnly:!1,format:Wr,formatter:Ur[Wr],indices:!1,serializeDate(n){return Ef.call(n)},skipNulls:!1,strictNullHandling:!1};function Sf(n){return typeof n=="string"||typeof n=="number"||typeof n=="boolean"||typeof n=="symbol"||typeof n=="bigint"}const br={};function sl(n,e,t,s,r,i,a,o,l,c,h,f,u,d,g,_,m,v){let y=n,A=v,k=0,R=!1;for(;(A=A.get(br))!==void 0&&!R;){const O=A.get(n);if(k+=1,typeof O<"u"){if(O===k)throw new RangeError("Cyclic object value");R=!0}typeof A.get(br)>"u"&&(k=0)}if(typeof c=="function"?y=c(e,y):y instanceof Date?y=u?.(y):t==="comma"&&Qe(y)&&(y=Ga(y,function(O){return O instanceof Date?u?.(O):O})),y===null){if(i)return l&&!_?l(e,se.encoder,m,"key",d):e;y=""}if(Sf(y)||xf(y)){if(l){const O=_?e:l(e,se.encoder,m,"key",d);return[g?.(O)+"="+g?.(l(y,se.encoder,m,"value",d))]}return[g?.(e)+"="+g?.(String(y))]}const I=[];if(typeof y>"u")return I;let M;if(t==="comma"&&Qe(y))_&&l&&(y=Ga(y,l)),M=[{value:y.length>0?y.join(",")||null:void 0}];else if(Qe(c))M=c;else{const O=Object.keys(y);M=h?O.sort(h):O}const C=o?String(e).replace(/\./g,"%2E"):String(e),T=s&&Qe(y)&&y.length===1?C+"[]":C;if(r&&Qe(y)&&y.length===0)return T+"[]";for(let O=0;O<M.length;++O){const W=M[O],Ce=typeof W=="object"&&typeof W.value<"u"?W.value:y[W];if(a&&Ce===null)continue;const Ne=f&&o?W.replace(/\./g,"%2E"):W,as=Qe(y)?typeof t=="function"?t(T,Ne):T:T+(f?"."+Ne:"["+Ne+"]");v.set(n,k);const Vt=new WeakMap;Vt.set(br,v),nl(I,sl(Ce,as,t,s,r,i,a,o,t==="comma"&&_&&Qe(y)?null:l,c,h,f,u,d,g,_,m,Vt))}return I}function Af(n=se){if(typeof n.allowEmptyArrays<"u"&&typeof n.allowEmptyArrays!="boolean")throw new TypeError("`allowEmptyArrays` option can only be `true` or `false`, when provided");if(typeof n.encodeDotInKeys<"u"&&typeof n.encodeDotInKeys!="boolean")throw new TypeError("`encodeDotInKeys` option can only be `true` or `false`, when provided");if(n.encoder!==null&&typeof n.encoder<"u"&&typeof n.encoder!="function")throw new TypeError("Encoder has to be a function.");const e=n.charset||se.charset;if(typeof n.charset<"u"&&n.charset!=="utf-8"&&n.charset!=="iso-8859-1")throw new TypeError("The charset option must be either utf-8, iso-8859-1, or undefined");let t=Wr;if(typeof n.format<"u"){if(!kf.call(Ur,n.format))throw new TypeError("Unknown format option provided.");t=n.format}const s=Ur[t];let r=se.filter;(typeof n.filter=="function"||Qe(n.filter))&&(r=n.filter);let i;if(n.arrayFormat&&n.arrayFormat in tl?i=n.arrayFormat:"indices"in n?i=n.indices?"indices":"repeat":i=se.arrayFormat,"commaRoundTrip"in n&&typeof n.commaRoundTrip!="boolean")throw new TypeError("`commaRoundTrip` must be a boolean, or absent");const a=typeof n.allowDots>"u"?n.encodeDotInKeys?!0:se.allowDots:!!n.allowDots;return{addQueryPrefix:typeof n.addQueryPrefix=="boolean"?n.addQueryPrefix:se.addQueryPrefix,allowDots:a,allowEmptyArrays:typeof n.allowEmptyArrays=="boolean"?!!n.allowEmptyArrays:se.allowEmptyArrays,arrayFormat:i,charset:e,charsetSentinel:typeof n.charsetSentinel=="boolean"?n.charsetSentinel:se.charsetSentinel,commaRoundTrip:!!n.commaRoundTrip,delimiter:typeof n.delimiter>"u"?se.delimiter:n.delimiter,encode:typeof n.encode=="boolean"?n.encode:se.encode,encodeDotInKeys:typeof n.encodeDotInKeys=="boolean"?n.encodeDotInKeys:se.encodeDotInKeys,encoder:typeof n.encoder=="function"?n.encoder:se.encoder,encodeValuesOnly:typeof n.encodeValuesOnly=="boolean"?n.encodeValuesOnly:se.encodeValuesOnly,filter:r,format:t,formatter:s,serializeDate:typeof n.serializeDate=="function"?n.serializeDate:se.serializeDate,skipNulls:typeof n.skipNulls=="boolean"?n.skipNulls:se.skipNulls,sort:typeof n.sort=="function"?n.sort:null,strictNullHandling:typeof n.strictNullHandling=="boolean"?n.strictNullHandling:se.strictNullHandling}}function Rf(n,e={}){let t=n;const s=Af(e);let r,i;typeof s.filter=="function"?(i=s.filter,t=i("",t)):Qe(s.filter)&&(i=s.filter,r=i);const a=[];if(typeof t!="object"||t===null)return"";const o=tl[s.arrayFormat],l=o==="comma"&&s.commaRoundTrip;r||(r=Object.keys(t)),s.sort&&r.sort(s.sort);const c=new WeakMap;for(let u=0;u<r.length;++u){const d=r[u];s.skipNulls&&t[d]===null||nl(a,sl(t[d],d,o,l,s.allowEmptyArrays,s.strictNullHandling,s.skipNulls,s.encodeDotInKeys,s.encode?s.encoder:null,s.filter,s.sort,s.allowDots,s.serializeDate,s.format,s.formatter,s.encodeValuesOnly,s.charset,c))}const h=a.join(s.delimiter);let f=s.addQueryPrefix===!0?"?":"";return s.charsetSentinel&&(s.charset==="iso-8859-1"?f+="utf8=%26%2310003%3B&":f+="utf8=%E2%9C%93&"),h.length>0?f+h:""}const an="4.104.0";let Ya=!1,Un,rl,il,jr,al,ol,ll,cl,ul;function Pf(n,e={auto:!1}){if(Ya)throw new Error(`you must \`import 'openai/shims/${n.kind}'\` before importing anything else from openai`);if(Un)throw new Error(`can't \`import 'openai/shims/${n.kind}'\` after \`import 'openai/shims/${Un}'\``);Ya=e.auto,Un=n.kind,rl=n.fetch,il=n.FormData,jr=n.File,al=n.ReadableStream,ol=n.getMultipartRequestOptions,ll=n.getDefaultAgent,cl=n.fileFromPath,ul=n.isFsReadStream}class If{constructor(e){this.body=e}get[Symbol.toStringTag](){return"MultipartBody"}}function Mf({manuallyImported:n}={}){const e=n?"You may need to use polyfills":"Add one of these imports before your first `import ‚Ä¶ from 'openai'`:\n- `import 'openai/shims/node'` (if you're running on Node)\n- `import 'openai/shims/web'` (otherwise)\n";let t,s,r,i;try{t=fetch,s=Request,r=Response,i=Headers}catch(a){throw new Error(`this environment is missing the following Web Fetch API type: ${a.message}. ${e}`)}return{kind:"web",fetch:t,Request:s,Response:r,Headers:i,FormData:typeof FormData<"u"?FormData:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'FormData' is undefined. ${e}`)}},Blob:typeof Blob<"u"?Blob:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'Blob' is undefined. ${e}`)}},File:typeof File<"u"?File:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'File' is undefined. ${e}`)}},ReadableStream:typeof ReadableStream<"u"?ReadableStream:class{constructor(){throw new Error(`streaming isn't supported in this environment yet as 'ReadableStream' is undefined. ${e}`)}},getMultipartRequestOptions:async(a,o)=>({...o,body:new If(a)}),getDefaultAgent:a=>{},fileFromPath:()=>{throw new Error("The `fileFromPath` function is only supported in Node. See the README for more details: https://www.github.com/openai/openai-node#file-uploads")},isFsReadStream:a=>!1}}const dl=()=>{Un||Pf(Mf(),{auto:!0})};dl();class N extends Error{}class fe extends N{constructor(e,t,s,r){super(`${fe.makeMessage(e,t,s)}`),this.status=e,this.headers=r,this.request_id=r?.["x-request-id"],this.error=t;const i=t;this.code=i?.code,this.param=i?.param,this.type=i?.type}static makeMessage(e,t,s){const r=t?.message?typeof t.message=="string"?t.message:JSON.stringify(t.message):t?JSON.stringify(t):s;return e&&r?`${e} ${r}`:e?`${e} status code (no body)`:r||"(no status code or body)"}static generate(e,t,s,r){if(!e||!r)return new Zs({message:s,cause:Xr(t)});const i=t?.error;return e===400?new fl(e,i,s,r):e===401?new hl(e,i,s,r):e===403?new pl(e,i,s,r):e===404?new gl(e,i,s,r):e===409?new ml(e,i,s,r):e===422?new vl(e,i,s,r):e===429?new _l(e,i,s,r):e>=500?new yl(e,i,s,r):new fe(e,i,s,r)}}class Be extends fe{constructor({message:e}={}){super(void 0,void 0,e||"Request was aborted.",void 0)}}class Zs extends fe{constructor({message:e,cause:t}){super(void 0,void 0,e||"Connection error.",void 0),t&&(this.cause=t)}}class vi extends Zs{constructor({message:e}={}){super({message:e??"Request timed out."})}}class fl extends fe{}class hl extends fe{}class pl extends fe{}class gl extends fe{}class ml extends fe{}class vl extends fe{}class _l extends fe{}class yl extends fe{}class wl extends N{constructor(){super("Could not parse response content as the length limit was reached")}}class bl extends N{constructor(){super("Could not parse response content as the request was rejected by the content filter")}}var vs=function(n,e,t,s,r){if(s==="m")throw new TypeError("Private method is not writable");if(s==="a"&&!r)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?n!==e||!r:!e.has(n))throw new TypeError("Cannot write private member to an object whose class did not declare it");return s==="a"?r.call(n,t):r?r.value=t:e.set(n,t),t},$t=function(n,e,t,s){if(t==="a"&&!s)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?n!==e||!s:!e.has(n))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?s:t==="a"?s.call(n):s?s.value:e.get(n)},Ae;class er{constructor(){Ae.set(this,void 0),this.buffer=new Uint8Array,vs(this,Ae,null,"f")}decode(e){if(e==null)return[];const t=e instanceof ArrayBuffer?new Uint8Array(e):typeof e=="string"?new TextEncoder().encode(e):e;let s=new Uint8Array(this.buffer.length+t.length);s.set(this.buffer),s.set(t,this.buffer.length),this.buffer=s;const r=[];let i;for(;(i=Tf(this.buffer,$t(this,Ae,"f")))!=null;){if(i.carriage&&$t(this,Ae,"f")==null){vs(this,Ae,i.index,"f");continue}if($t(this,Ae,"f")!=null&&(i.index!==$t(this,Ae,"f")+1||i.carriage)){r.push(this.decodeText(this.buffer.slice(0,$t(this,Ae,"f")-1))),this.buffer=this.buffer.slice($t(this,Ae,"f")),vs(this,Ae,null,"f");continue}const a=$t(this,Ae,"f")!==null?i.preceding-1:i.preceding,o=this.decodeText(this.buffer.slice(0,a));r.push(o),this.buffer=this.buffer.slice(i.index),vs(this,Ae,null,"f")}return r}decodeText(e){if(e==null)return"";if(typeof e=="string")return e;if(typeof Buffer<"u"){if(e instanceof Buffer)return e.toString();if(e instanceof Uint8Array)return Buffer.from(e).toString();throw new N(`Unexpected: received non-Uint8Array (${e.constructor.name}) stream chunk in an environment with a global "Buffer" defined, which this library assumes to be Node. Please report this error.`)}if(typeof TextDecoder<"u"){if(e instanceof Uint8Array||e instanceof ArrayBuffer)return this.textDecoder??(this.textDecoder=new TextDecoder("utf8")),this.textDecoder.decode(e);throw new N(`Unexpected: received non-Uint8Array/ArrayBuffer (${e.constructor.name}) in a web platform. Please report this error.`)}throw new N("Unexpected: neither Buffer nor TextDecoder are available as globals. Please report this error.")}flush(){return this.buffer.length?this.decode(`
`):[]}}Ae=new WeakMap;er.NEWLINE_CHARS=new Set([`
`,"\r"]);er.NEWLINE_REGEXP=/\r\n|[\n\r]/g;function Tf(n,e){for(let r=e??0;r<n.length;r++){if(n[r]===10)return{preceding:r,index:r+1,carriage:!1};if(n[r]===13)return{preceding:r,index:r+1,carriage:!0}}return null}function Nf(n){for(let s=0;s<n.length-1;s++){if(n[s]===10&&n[s+1]===10||n[s]===13&&n[s+1]===13)return s+2;if(n[s]===13&&n[s+1]===10&&s+3<n.length&&n[s+2]===13&&n[s+3]===10)return s+4}return-1}function xl(n){if(n[Symbol.asyncIterator])return n;const e=n.getReader();return{async next(){try{const t=await e.read();return t?.done&&e.releaseLock(),t}catch(t){throw e.releaseLock(),t}},async return(){const t=e.cancel();return e.releaseLock(),await t,{done:!0,value:void 0}},[Symbol.asyncIterator](){return this}}}class nt{constructor(e,t){this.iterator=e,this.controller=t}static fromSSEResponse(e,t){let s=!1;async function*r(){if(s)throw new Error("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");s=!0;let i=!1;try{for await(const a of Of(e,t))if(!i){if(a.data.startsWith("[DONE]")){i=!0;continue}if(a.event===null||a.event.startsWith("response.")||a.event.startsWith("transcript.")){let o;try{o=JSON.parse(a.data)}catch(l){throw console.error("Could not parse message into JSON:",a.data),console.error("From chunk:",a.raw),l}if(o&&o.error)throw new fe(void 0,o.error,void 0,Pl(e.headers));yield o}else{let o;try{o=JSON.parse(a.data)}catch(l){throw console.error("Could not parse message into JSON:",a.data),console.error("From chunk:",a.raw),l}if(a.event=="error")throw new fe(void 0,o.error,o.message,void 0);yield{event:a.event,data:o}}}i=!0}catch(a){if(a instanceof Error&&a.name==="AbortError")return;throw a}finally{i||t.abort()}}return new nt(r,t)}static fromReadableStream(e,t){let s=!1;async function*r(){const a=new er,o=xl(e);for await(const l of o)for(const c of a.decode(l))yield c;for(const l of a.flush())yield l}async function*i(){if(s)throw new Error("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");s=!0;let a=!1;try{for await(const o of r())a||o&&(yield JSON.parse(o));a=!0}catch(o){if(o instanceof Error&&o.name==="AbortError")return;throw o}finally{a||t.abort()}}return new nt(i,t)}[Symbol.asyncIterator](){return this.iterator()}tee(){const e=[],t=[],s=this.iterator(),r=i=>({next:()=>{if(i.length===0){const a=s.next();e.push(a),t.push(a)}return i.shift()}});return[new nt(()=>r(e),this.controller),new nt(()=>r(t),this.controller)]}toReadableStream(){const e=this;let t;const s=new TextEncoder;return new al({async start(){t=e[Symbol.asyncIterator]()},async pull(r){try{const{value:i,done:a}=await t.next();if(a)return r.close();const o=s.encode(JSON.stringify(i)+`
`);r.enqueue(o)}catch(i){r.error(i)}},async cancel(){await t.return?.()}})}}async function*Of(n,e){if(!n.body)throw e.abort(),new N("Attempted to iterate over a response with no body");const t=new Lf,s=new er,r=xl(n.body);for await(const i of $f(r))for(const a of s.decode(i)){const o=t.decode(a);o&&(yield o)}for(const i of s.flush()){const a=t.decode(i);a&&(yield a)}}async function*$f(n){let e=new Uint8Array;for await(const t of n){if(t==null)continue;const s=t instanceof ArrayBuffer?new Uint8Array(t):typeof t=="string"?new TextEncoder().encode(t):t;let r=new Uint8Array(e.length+s.length);r.set(e),r.set(s,e.length),e=r;let i;for(;(i=Nf(e))!==-1;)yield e.slice(0,i),e=e.slice(i)}e.length>0&&(yield e)}class Lf{constructor(){this.event=null,this.data=[],this.chunks=[]}decode(e){if(e.endsWith("\r")&&(e=e.substring(0,e.length-1)),!e){if(!this.event&&!this.data.length)return null;const i={event:this.event,data:this.data.join(`
`),raw:this.chunks};return this.event=null,this.data=[],this.chunks=[],i}if(this.chunks.push(e),e.startsWith(":"))return null;let[t,s,r]=Ff(e,":");return r.startsWith(" ")&&(r=r.substring(1)),t==="event"?this.event=r:t==="data"&&this.data.push(r),null}}function Ff(n,e){const t=n.indexOf(e);return t!==-1?[n.substring(0,t),e,n.substring(t+e.length)]:[n,"",""]}const kl=n=>n!=null&&typeof n=="object"&&typeof n.url=="string"&&typeof n.blob=="function",Cl=n=>n!=null&&typeof n=="object"&&typeof n.name=="string"&&typeof n.lastModified=="number"&&tr(n),tr=n=>n!=null&&typeof n=="object"&&typeof n.size=="number"&&typeof n.type=="string"&&typeof n.text=="function"&&typeof n.slice=="function"&&typeof n.arrayBuffer=="function",Df=n=>Cl(n)||kl(n)||ul(n);async function El(n,e,t){if(n=await n,Cl(n))return n;if(kl(n)){const r=await n.blob();e||(e=new URL(n.url).pathname.split(/[\\/]/).pop()??"unknown_file");const i=tr(r)?[await r.arrayBuffer()]:[r];return new jr(i,e,t)}const s=await zf(n);if(e||(e=Hf(n)??"unknown_file"),!t?.type){const r=s[0]?.type;typeof r=="string"&&(t={...t,type:r})}return new jr(s,e,t)}async function zf(n){let e=[];if(typeof n=="string"||ArrayBuffer.isView(n)||n instanceof ArrayBuffer)e.push(n);else if(tr(n))e.push(await n.arrayBuffer());else if(Wf(n))for await(const t of n)e.push(t);else throw new Error(`Unexpected data type: ${typeof n}; constructor: ${n?.constructor?.name}; props: ${Bf(n)}`);return e}function Bf(n){return`[${Object.getOwnPropertyNames(n).map(t=>`"${t}"`).join(", ")}]`}function Hf(n){return xr(n.name)||xr(n.filename)||xr(n.path)?.split(/[\\/]/).pop()}const xr=n=>{if(typeof n=="string")return n;if(typeof Buffer<"u"&&n instanceof Buffer)return String(n)},Wf=n=>n!=null&&typeof n=="object"&&typeof n[Symbol.asyncIterator]=="function",Va=n=>n&&typeof n=="object"&&n.body&&n[Symbol.toStringTag]==="MultipartBody",Gt=async n=>{const e=await Uf(n.body);return ol(e,n)},Uf=async n=>{const e=new il;return await Promise.all(Object.entries(n||{}).map(([t,s])=>qr(e,t,s))),e},qr=async(n,e,t)=>{if(t!==void 0){if(t==null)throw new TypeError(`Received null for "${e}"; to pass null in FormData, you must use the string 'null'`);if(typeof t=="string"||typeof t=="number"||typeof t=="boolean")n.append(e,String(t));else if(Df(t)){const s=await El(t);n.append(e,s)}else if(Array.isArray(t))await Promise.all(t.map(s=>qr(n,e+"[]",s)));else if(typeof t=="object")await Promise.all(Object.entries(t).map(([s,r])=>qr(n,`${e}[${s}]`,r)));else throw new TypeError(`Invalid value given to form, expected a string, number, boolean, object, Array, File or Blob but got ${t} instead`)}};var jf=function(n,e,t,s,r){if(s==="m")throw new TypeError("Private method is not writable");if(s==="a"&&!r)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?n!==e||!r:!e.has(n))throw new TypeError("Cannot write private member to an object whose class did not declare it");return s==="a"?r.call(n,t):r?r.value=t:e.set(n,t),t},qf=function(n,e,t,s){if(t==="a"&&!s)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?n!==e||!s:!e.has(n))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?s:t==="a"?s.call(n):s?s.value:e.get(n)},_s;dl();async function Sl(n){const{response:e}=n;if(n.options.stream)return Rt("response",e.status,e.url,e.headers,e.body),n.options.__streamClass?n.options.__streamClass.fromSSEResponse(e,n.controller):nt.fromSSEResponse(e,n.controller);if(e.status===204)return null;if(n.options.__binaryResponse)return e;const s=e.headers.get("content-type")?.split(";")[0]?.trim();if(s?.includes("application/json")||s?.endsWith("+json")){const a=await e.json();return Rt("response",e.status,e.url,e.headers,a),Al(a,e)}const i=await e.text();return Rt("response",e.status,e.url,e.headers,i),i}function Al(n,e){return!n||typeof n!="object"||Array.isArray(n)?n:Object.defineProperty(n,"_request_id",{value:e.headers.get("x-request-id"),enumerable:!1})}class nr extends Promise{constructor(e,t=Sl){super(s=>{s(null)}),this.responsePromise=e,this.parseResponse=t}_thenUnwrap(e){return new nr(this.responsePromise,async t=>Al(e(await this.parseResponse(t),t),t.response))}asResponse(){return this.responsePromise.then(e=>e.response)}async withResponse(){const[e,t]=await Promise.all([this.parse(),this.asResponse()]);return{data:e,response:t,request_id:t.headers.get("x-request-id")}}parse(){return this.parsedPromise||(this.parsedPromise=this.responsePromise.then(this.parseResponse)),this.parsedPromise}then(e,t){return this.parse().then(e,t)}catch(e){return this.parse().catch(e)}finally(e){return this.parse().finally(e)}}class Xf{constructor({baseURL:e,maxRetries:t=2,timeout:s=6e5,httpAgent:r,fetch:i}){this.baseURL=e,this.maxRetries=kr("maxRetries",t),this.timeout=kr("timeout",s),this.httpAgent=r,this.fetch=i??rl}authHeaders(e){return{}}defaultHeaders(e){return{Accept:"application/json","Content-Type":"application/json","User-Agent":this.getUserAgent(),...Kf(),...this.authHeaders(e)}}validateHeaders(e,t){}defaultIdempotencyKey(){return`stainless-node-retry-${th()}`}get(e,t){return this.methodRequest("get",e,t)}post(e,t){return this.methodRequest("post",e,t)}patch(e,t){return this.methodRequest("patch",e,t)}put(e,t){return this.methodRequest("put",e,t)}delete(e,t){return this.methodRequest("delete",e,t)}methodRequest(e,t,s){return this.request(Promise.resolve(s).then(async r=>{const i=r&&tr(r?.body)?new DataView(await r.body.arrayBuffer()):r?.body instanceof DataView?r.body:r?.body instanceof ArrayBuffer?new DataView(r.body):r&&ArrayBuffer.isView(r?.body)?new DataView(r.body.buffer):r?.body;return{method:e,path:t,...r,body:i}}))}getAPIList(e,t,s){return this.requestAPIList(t,{method:"get",path:e,...s})}calculateContentLength(e){if(typeof e=="string"){if(typeof Buffer<"u")return Buffer.byteLength(e,"utf8").toString();if(typeof TextEncoder<"u")return new TextEncoder().encode(e).length.toString()}else if(ArrayBuffer.isView(e))return e.byteLength.toString();return null}buildRequest(e,{retryCount:t=0}={}){const s={...e},{method:r,path:i,query:a,headers:o={}}=s,l=ArrayBuffer.isView(s.body)||s.__binaryRequest&&typeof s.body=="string"?s.body:Va(s.body)?s.body.body:s.body?JSON.stringify(s.body,null,2):null,c=this.calculateContentLength(l),h=this.buildURL(i,a);"timeout"in s&&kr("timeout",s.timeout),s.timeout=s.timeout??this.timeout;const f=s.httpAgent??this.httpAgent??ll(h),u=s.timeout+1e3;typeof f?.options?.timeout=="number"&&u>(f.options.timeout??0)&&(f.options.timeout=u),this.idempotencyHeader&&r!=="get"&&(e.idempotencyKey||(e.idempotencyKey=this.defaultIdempotencyKey()),o[this.idempotencyHeader]=e.idempotencyKey);const d=this.buildHeaders({options:s,headers:o,contentLength:c,retryCount:t});return{req:{method:r,...l&&{body:l},headers:d,...f&&{agent:f},signal:s.signal??null},url:h,timeout:s.timeout}}buildHeaders({options:e,headers:t,contentLength:s,retryCount:r}){const i={};s&&(i["content-length"]=s);const a=this.defaultHeaders(e);return Za(i,a),Za(i,t),Va(e.body)&&Un!=="node"&&delete i["content-type"],ws(a,"x-stainless-retry-count")===void 0&&ws(t,"x-stainless-retry-count")===void 0&&(i["x-stainless-retry-count"]=String(r)),ws(a,"x-stainless-timeout")===void 0&&ws(t,"x-stainless-timeout")===void 0&&e.timeout&&(i["x-stainless-timeout"]=String(Math.trunc(e.timeout/1e3))),this.validateHeaders(i,t),i}async prepareOptions(e){}async prepareRequest(e,{url:t,options:s}){}parseHeaders(e){return e?Symbol.iterator in e?Object.fromEntries(Array.from(e).map(t=>[...t])):{...e}:{}}makeStatusError(e,t,s,r){return fe.generate(e,t,s,r)}request(e,t=null){return new nr(this.makeRequest(e,t))}async makeRequest(e,t){const s=await e,r=s.maxRetries??this.maxRetries;t==null&&(t=r),await this.prepareOptions(s);const{req:i,url:a,timeout:o}=this.buildRequest(s,{retryCount:r-t});if(await this.prepareRequest(i,{url:a,options:s}),Rt("request",a,s,i.headers),s.signal?.aborted)throw new Be;const l=new AbortController,c=await this.fetchWithTimeout(a,i,o,l).catch(Xr);if(c instanceof Error){if(s.signal?.aborted)throw new Be;if(t)return this.retryRequest(s,t);throw c.name==="AbortError"?new vi:new Zs({cause:c})}const h=Pl(c.headers);if(!c.ok){if(t&&this.shouldRetry(c)){const m=`retrying, ${t} attempts remaining`;return Rt(`response (error; ${m})`,c.status,a,h),this.retryRequest(s,t,h)}const f=await c.text().catch(m=>Xr(m).message),u=Qf(f),d=u?void 0:f;throw Rt(`response (error; ${t?"(error; no more retries left)":"(error; not retryable)"})`,c.status,a,h,d),this.makeStatusError(c.status,u,d,h)}return{response:c,options:s,controller:l}}requestAPIList(e,t){const s=this.makeRequest(t,null);return new Gf(this,s,e)}buildURL(e,t){const s=eh(e)?new URL(e):new URL(this.baseURL+(this.baseURL.endsWith("/")&&e.startsWith("/")?e.slice(1):e)),r=this.defaultQuery();return Il(r)||(t={...r,...t}),typeof t=="object"&&t&&!Array.isArray(t)&&(s.search=this.stringifyQuery(t)),s.toString()}stringifyQuery(e){return Object.entries(e).filter(([t,s])=>typeof s<"u").map(([t,s])=>{if(typeof s=="string"||typeof s=="number"||typeof s=="boolean")return`${encodeURIComponent(t)}=${encodeURIComponent(s)}`;if(s===null)return`${encodeURIComponent(t)}=`;throw new N(`Cannot stringify type ${typeof s}; Expected string, number, boolean, or null. If you need to pass nested query parameters, you can manually encode them, e.g. { query: { 'foo[key1]': value1, 'foo[key2]': value2 } }, and please open a GitHub issue requesting better support for your use case.`)}).join("&")}async fetchWithTimeout(e,t,s,r){const{signal:i,...a}=t||{};i&&i.addEventListener("abort",()=>r.abort());const o=setTimeout(()=>r.abort(),s),l={signal:r.signal,...a};return l.method&&(l.method=l.method.toUpperCase()),this.fetch.call(void 0,e,l).finally(()=>{clearTimeout(o)})}shouldRetry(e){const t=e.headers.get("x-should-retry");return t==="true"?!0:t==="false"?!1:e.status===408||e.status===409||e.status===429||e.status>=500}async retryRequest(e,t,s){let r;const i=s?.["retry-after-ms"];if(i){const o=parseFloat(i);Number.isNaN(o)||(r=o)}const a=s?.["retry-after"];if(a&&!r){const o=parseFloat(a);Number.isNaN(o)?r=Date.parse(a)-Date.now():r=o*1e3}if(!(r&&0<=r&&r<60*1e3)){const o=e.maxRetries??this.maxRetries;r=this.calculateDefaultRetryTimeoutMillis(t,o)}return await Zn(r),this.makeRequest(e,t-1)}calculateDefaultRetryTimeoutMillis(e,t){const i=t-e,a=Math.min(.5*Math.pow(2,i),8),o=1-Math.random()*.25;return a*o*1e3}getUserAgent(){return`${this.constructor.name}/JS ${an}`}}class Rl{constructor(e,t,s,r){_s.set(this,void 0),jf(this,_s,e,"f"),this.options=r,this.response=t,this.body=s}hasNextPage(){return this.getPaginatedItems().length?this.nextPageInfo()!=null:!1}async getNextPage(){const e=this.nextPageInfo();if(!e)throw new N("No next page expected; please check `.hasNextPage()` before calling `.getNextPage()`.");const t={...this.options};if("params"in e&&typeof t.query=="object")t.query={...t.query,...e.params};else if("url"in e){const s=[...Object.entries(t.query||{}),...e.url.searchParams.entries()];for(const[r,i]of s)e.url.searchParams.set(r,i);t.query=void 0,t.path=e.url.toString()}return await qf(this,_s,"f").requestAPIList(this.constructor,t)}async*iterPages(){let e=this;for(yield e;e.hasNextPage();)e=await e.getNextPage(),yield e}async*[(_s=new WeakMap,Symbol.asyncIterator)](){for await(const e of this.iterPages())for(const t of e.getPaginatedItems())yield t}}class Gf extends nr{constructor(e,t,s){super(t,async r=>new s(e,r.response,await Sl(r),r.options))}async*[Symbol.asyncIterator](){const e=await this;for await(const t of e)yield t}}const Pl=n=>new Proxy(Object.fromEntries(n.entries()),{get(e,t){const s=t.toString();return e[s.toLowerCase()]||e[s]}}),Yf={method:!0,path:!0,query:!0,body:!0,headers:!0,maxRetries:!0,stream:!0,timeout:!0,httpAgent:!0,signal:!0,idempotencyKey:!0,__metadata:!0,__binaryRequest:!0,__binaryResponse:!0,__streamClass:!0},Z=n=>typeof n=="object"&&n!==null&&!Il(n)&&Object.keys(n).every(e=>Ml(Yf,e)),Vf=()=>{if(typeof Deno<"u"&&Deno.build!=null)return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":an,"X-Stainless-OS":Ka(Deno.build.os),"X-Stainless-Arch":Ja(Deno.build.arch),"X-Stainless-Runtime":"deno","X-Stainless-Runtime-Version":typeof Deno.version=="string"?Deno.version:Deno.version?.deno??"unknown"};if(typeof EdgeRuntime<"u")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":an,"X-Stainless-OS":"Unknown","X-Stainless-Arch":`other:${EdgeRuntime}`,"X-Stainless-Runtime":"edge","X-Stainless-Runtime-Version":process.version};if(Object.prototype.toString.call(typeof process<"u"?process:0)==="[object process]")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":an,"X-Stainless-OS":Ka(process.platform),"X-Stainless-Arch":Ja(process.arch),"X-Stainless-Runtime":"node","X-Stainless-Runtime-Version":process.version};const n=Jf();return n?{"X-Stainless-Lang":"js","X-Stainless-Package-Version":an,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":`browser:${n.browser}`,"X-Stainless-Runtime-Version":n.version}:{"X-Stainless-Lang":"js","X-Stainless-Package-Version":an,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":"unknown","X-Stainless-Runtime-Version":"unknown"}};function Jf(){if(typeof navigator>"u"||!navigator)return null;const n=[{key:"edge",pattern:/Edge(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/MSIE(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/Trident(?:.*rv\:(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"chrome",pattern:/Chrome(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"firefox",pattern:/Firefox(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"safari",pattern:/(?:Version\W+(\d+)\.(\d+)(?:\.(\d+))?)?(?:\W+Mobile\S*)?\W+Safari/}];for(const{key:e,pattern:t}of n){const s=t.exec(navigator.userAgent);if(s){const r=s[1]||0,i=s[2]||0,a=s[3]||0;return{browser:e,version:`${r}.${i}.${a}`}}}return null}const Ja=n=>n==="x32"?"x32":n==="x86_64"||n==="x64"?"x64":n==="arm"?"arm":n==="aarch64"||n==="arm64"?"arm64":n?`other:${n}`:"unknown",Ka=n=>(n=n.toLowerCase(),n.includes("ios")?"iOS":n==="android"?"Android":n==="darwin"?"MacOS":n==="win32"?"Windows":n==="freebsd"?"FreeBSD":n==="openbsd"?"OpenBSD":n==="linux"?"Linux":n?`Other:${n}`:"Unknown");let Qa;const Kf=()=>Qa??(Qa=Vf()),Qf=n=>{try{return JSON.parse(n)}catch{return}},Zf=/^[a-z][a-z0-9+.-]*:/i,eh=n=>Zf.test(n),Zn=n=>new Promise(e=>setTimeout(e,n)),kr=(n,e)=>{if(typeof e!="number"||!Number.isInteger(e))throw new N(`${n} must be an integer`);if(e<0)throw new N(`${n} must be a positive integer`);return e},Xr=n=>{if(n instanceof Error)return n;if(typeof n=="object"&&n!==null)try{return new Error(JSON.stringify(n))}catch{}return new Error(n)},ys=n=>{if(typeof process<"u")return process.env?.[n]?.trim()??void 0;if(typeof Deno<"u")return Deno.env?.get?.(n)?.trim()};function Il(n){if(!n)return!0;for(const e in n)return!1;return!0}function Ml(n,e){return Object.prototype.hasOwnProperty.call(n,e)}function Za(n,e){for(const t in e){if(!Ml(e,t))continue;const s=t.toLowerCase();if(!s)continue;const r=e[t];r===null?delete n[s]:r!==void 0&&(n[s]=r)}}const eo=new Set(["authorization","api-key"]);function Rt(n,...e){if(typeof process<"u"&&process?.env?.DEBUG==="true"){const t=e.map(s=>{if(!s)return s;if(s.headers){const i={...s,headers:{...s.headers}};for(const a in s.headers)eo.has(a.toLowerCase())&&(i.headers[a]="REDACTED");return i}let r=null;for(const i in s)eo.has(i.toLowerCase())&&(r??(r={...s}),r[i]="REDACTED");return r??s});console.log(`OpenAI:DEBUG:${n}`,...t)}}const th=()=>"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,n=>{const e=Math.random()*16|0;return(n==="x"?e:e&3|8).toString(16)}),nh=()=>typeof window<"u"&&typeof window.document<"u"&&typeof navigator<"u",sh=n=>typeof n?.get=="function",ws=(n,e)=>{const t=e.toLowerCase();if(sh(n)){const s=e[0]?.toUpperCase()+e.substring(1).replace(/([^\w])(\w)/g,(r,i,a)=>i+a.toUpperCase());for(const r of[e,t,e.toUpperCase(),s]){const i=n.get(r);if(i)return i}}for(const[s,r]of Object.entries(n))if(s.toLowerCase()===t)return Array.isArray(r)?(r.length<=1||console.warn(`Received ${r.length} entries for the ${e} header, using the first entry.`),r[0]):r},rh=n=>{if(typeof Buffer<"u"){const e=Buffer.from(n,"base64");return Array.from(new Float32Array(e.buffer,e.byteOffset,e.length/Float32Array.BYTES_PER_ELEMENT))}else{const e=atob(n),t=e.length,s=new Uint8Array(t);for(let r=0;r<t;r++)s[r]=e.charCodeAt(r);return Array.from(new Float32Array(s.buffer))}};function Cr(n){return n!=null&&typeof n=="object"&&!Array.isArray(n)}class sr extends Rl{constructor(e,t,s,r){super(e,t,s,r),this.data=s.data||[],this.object=s.object}getPaginatedItems(){return this.data??[]}nextPageParams(){return null}nextPageInfo(){return null}}class re extends Rl{constructor(e,t,s,r){super(e,t,s,r),this.data=s.data||[],this.has_more=s.has_more||!1}getPaginatedItems(){return this.data??[]}hasNextPage(){return this.has_more===!1?!1:super.hasNextPage()}nextPageParams(){const e=this.nextPageInfo();if(!e)return null;if("params"in e)return e.params;const t=Object.fromEntries(e.url.searchParams);return Object.keys(t).length?t:null}nextPageInfo(){const e=this.getPaginatedItems();if(!e.length)return null;const t=e[e.length-1]?.id;return t?{params:{after:t}}:null}}class L{constructor(e){this._client=e}}let Tl=class extends L{list(e,t={},s){return Z(t)?this.list(e,{},t):this._client.getAPIList(`/chat/completions/${e}/messages`,ih,{query:t,...s})}},rr=class extends L{constructor(){super(...arguments),this.messages=new Tl(this._client)}create(e,t){return this._client.post("/chat/completions",{body:e,...t,stream:e.stream??!1})}retrieve(e,t){return this._client.get(`/chat/completions/${e}`,t)}update(e,t,s){return this._client.post(`/chat/completions/${e}`,{body:t,...s})}list(e={},t){return Z(e)?this.list({},e):this._client.getAPIList("/chat/completions",ir,{query:e,...t})}del(e,t){return this._client.delete(`/chat/completions/${e}`,t)}};class ir extends re{}class ih extends re{}rr.ChatCompletionsPage=ir;rr.Messages=Tl;let ar=class extends L{constructor(){super(...arguments),this.completions=new rr(this._client)}};ar.Completions=rr;ar.ChatCompletionsPage=ir;class Nl extends L{create(e,t){return this._client.post("/audio/speech",{body:e,...t,headers:{Accept:"application/octet-stream",...t?.headers},__binaryResponse:!0})}}class Ol extends L{create(e,t){return this._client.post("/audio/transcriptions",Gt({body:e,...t,stream:e.stream??!1,__metadata:{model:e.model}}))}}class $l extends L{create(e,t){return this._client.post("/audio/translations",Gt({body:e,...t,__metadata:{model:e.model}}))}}class es extends L{constructor(){super(...arguments),this.transcriptions=new Ol(this._client),this.translations=new $l(this._client),this.speech=new Nl(this._client)}}es.Transcriptions=Ol;es.Translations=$l;es.Speech=Nl;class _i extends L{create(e,t){return this._client.post("/batches",{body:e,...t})}retrieve(e,t){return this._client.get(`/batches/${e}`,t)}list(e={},t){return Z(e)?this.list({},e):this._client.getAPIList("/batches",yi,{query:e,...t})}cancel(e,t){return this._client.post(`/batches/${e}/cancel`,t)}}class yi extends re{}_i.BatchesPage=yi;var qe=function(n,e,t,s,r){if(s==="m")throw new TypeError("Private method is not writable");if(s==="a"&&!r)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?n!==e||!r:!e.has(n))throw new TypeError("Cannot write private member to an object whose class did not declare it");return s==="a"?r.call(n,t):r?r.value=t:e.set(n,t),t},J=function(n,e,t,s){if(t==="a"&&!s)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?n!==e||!s:!e.has(n))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?s:t==="a"?s.call(n):s?s.value:e.get(n)},Gr,Rs,Ps,On,$n,Is,Ln,lt,Fn,Hs,Ws,on,Ll;class wi{constructor(){Gr.add(this),this.controller=new AbortController,Rs.set(this,void 0),Ps.set(this,()=>{}),On.set(this,()=>{}),$n.set(this,void 0),Is.set(this,()=>{}),Ln.set(this,()=>{}),lt.set(this,{}),Fn.set(this,!1),Hs.set(this,!1),Ws.set(this,!1),on.set(this,!1),qe(this,Rs,new Promise((e,t)=>{qe(this,Ps,e,"f"),qe(this,On,t,"f")}),"f"),qe(this,$n,new Promise((e,t)=>{qe(this,Is,e,"f"),qe(this,Ln,t,"f")}),"f"),J(this,Rs,"f").catch(()=>{}),J(this,$n,"f").catch(()=>{})}_run(e){setTimeout(()=>{e().then(()=>{this._emitFinal(),this._emit("end")},J(this,Gr,"m",Ll).bind(this))},0)}_connected(){this.ended||(J(this,Ps,"f").call(this),this._emit("connect"))}get ended(){return J(this,Fn,"f")}get errored(){return J(this,Hs,"f")}get aborted(){return J(this,Ws,"f")}abort(){this.controller.abort()}on(e,t){return(J(this,lt,"f")[e]||(J(this,lt,"f")[e]=[])).push({listener:t}),this}off(e,t){const s=J(this,lt,"f")[e];if(!s)return this;const r=s.findIndex(i=>i.listener===t);return r>=0&&s.splice(r,1),this}once(e,t){return(J(this,lt,"f")[e]||(J(this,lt,"f")[e]=[])).push({listener:t,once:!0}),this}emitted(e){return new Promise((t,s)=>{qe(this,on,!0,"f"),e!=="error"&&this.once("error",s),this.once(e,t)})}async done(){qe(this,on,!0,"f"),await J(this,$n,"f")}_emit(e,...t){if(J(this,Fn,"f"))return;e==="end"&&(qe(this,Fn,!0,"f"),J(this,Is,"f").call(this));const s=J(this,lt,"f")[e];if(s&&(J(this,lt,"f")[e]=s.filter(r=>!r.once),s.forEach(({listener:r})=>r(...t))),e==="abort"){const r=t[0];!J(this,on,"f")&&!s?.length&&Promise.reject(r),J(this,On,"f").call(this,r),J(this,Ln,"f").call(this,r),this._emit("end");return}if(e==="error"){const r=t[0];!J(this,on,"f")&&!s?.length&&Promise.reject(r),J(this,On,"f").call(this,r),J(this,Ln,"f").call(this,r),this._emit("end")}}_emitFinal(){}}Rs=new WeakMap,Ps=new WeakMap,On=new WeakMap,$n=new WeakMap,Is=new WeakMap,Ln=new WeakMap,lt=new WeakMap,Fn=new WeakMap,Hs=new WeakMap,Ws=new WeakMap,on=new WeakMap,Gr=new WeakSet,Ll=function(e){if(qe(this,Hs,!0,"f"),e instanceof Error&&e.name==="AbortError"&&(e=new Be),e instanceof Be)return qe(this,Ws,!0,"f"),this._emit("abort",e);if(e instanceof N)return this._emit("error",e);if(e instanceof Error){const t=new N(e.message);return t.cause=e,this._emit("error",t)}return this._emit("error",new N(String(e)))};var P=function(n,e,t,s){if(t==="a"&&!s)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?n!==e||!s:!e.has(n))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?s:t==="a"?s.call(n):s?s.value:e.get(n)},Se=function(n,e,t,s,r){if(s==="m")throw new TypeError("Private method is not writable");if(s==="a"&&!r)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?n!==e||!r:!e.has(n))throw new TypeError("Cannot write private member to an object whose class did not declare it");return s==="a"?r.call(n,t):r?r.value=t:e.set(n,t),t},ce,Yr,Ze,Ms,Xe,zt,un,Ft,Us,Pe,Ts,Ns,jn,Dn,zn,to,no,so,ro,io,ao,oo;class Ge extends wi{constructor(){super(...arguments),ce.add(this),Yr.set(this,[]),Ze.set(this,{}),Ms.set(this,{}),Xe.set(this,void 0),zt.set(this,void 0),un.set(this,void 0),Ft.set(this,void 0),Us.set(this,void 0),Pe.set(this,void 0),Ts.set(this,void 0),Ns.set(this,void 0),jn.set(this,void 0)}[(Yr=new WeakMap,Ze=new WeakMap,Ms=new WeakMap,Xe=new WeakMap,zt=new WeakMap,un=new WeakMap,Ft=new WeakMap,Us=new WeakMap,Pe=new WeakMap,Ts=new WeakMap,Ns=new WeakMap,jn=new WeakMap,ce=new WeakSet,Symbol.asyncIterator)](){const e=[],t=[];let s=!1;return this.on("event",r=>{const i=t.shift();i?i.resolve(r):e.push(r)}),this.on("end",()=>{s=!0;for(const r of t)r.resolve(void 0);t.length=0}),this.on("abort",r=>{s=!0;for(const i of t)i.reject(r);t.length=0}),this.on("error",r=>{s=!0;for(const i of t)i.reject(r);t.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:s?{value:void 0,done:!0}:new Promise((i,a)=>t.push({resolve:i,reject:a})).then(i=>i?{value:i,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}static fromReadableStream(e){const t=new Ge;return t._run(()=>t._fromReadableStream(e)),t}async _fromReadableStream(e,t){const s=t?.signal;s&&(s.aborted&&this.controller.abort(),s.addEventListener("abort",()=>this.controller.abort())),this._connected();const r=nt.fromReadableStream(e,this.controller);for await(const i of r)P(this,ce,"m",Dn).call(this,i);if(r.controller.signal?.aborted)throw new Be;return this._addRun(P(this,ce,"m",zn).call(this))}toReadableStream(){return new nt(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}static createToolAssistantStream(e,t,s,r,i){const a=new Ge;return a._run(()=>a._runToolAssistantStream(e,t,s,r,{...i,headers:{...i?.headers,"X-Stainless-Helper-Method":"stream"}})),a}async _createToolAssistantStream(e,t,s,r,i){const a=i?.signal;a&&(a.aborted&&this.controller.abort(),a.addEventListener("abort",()=>this.controller.abort()));const o={...r,stream:!0},l=await e.submitToolOutputs(t,s,o,{...i,signal:this.controller.signal});this._connected();for await(const c of l)P(this,ce,"m",Dn).call(this,c);if(l.controller.signal?.aborted)throw new Be;return this._addRun(P(this,ce,"m",zn).call(this))}static createThreadAssistantStream(e,t,s){const r=new Ge;return r._run(()=>r._threadAssistantStream(e,t,{...s,headers:{...s?.headers,"X-Stainless-Helper-Method":"stream"}})),r}static createAssistantStream(e,t,s,r){const i=new Ge;return i._run(()=>i._runAssistantStream(e,t,s,{...r,headers:{...r?.headers,"X-Stainless-Helper-Method":"stream"}})),i}currentEvent(){return P(this,Ts,"f")}currentRun(){return P(this,Ns,"f")}currentMessageSnapshot(){return P(this,Xe,"f")}currentRunStepSnapshot(){return P(this,jn,"f")}async finalRunSteps(){return await this.done(),Object.values(P(this,Ze,"f"))}async finalMessages(){return await this.done(),Object.values(P(this,Ms,"f"))}async finalRun(){if(await this.done(),!P(this,zt,"f"))throw Error("Final run was not received.");return P(this,zt,"f")}async _createThreadAssistantStream(e,t,s){const r=s?.signal;r&&(r.aborted&&this.controller.abort(),r.addEventListener("abort",()=>this.controller.abort()));const i={...t,stream:!0},a=await e.createAndRun(i,{...s,signal:this.controller.signal});this._connected();for await(const o of a)P(this,ce,"m",Dn).call(this,o);if(a.controller.signal?.aborted)throw new Be;return this._addRun(P(this,ce,"m",zn).call(this))}async _createAssistantStream(e,t,s,r){const i=r?.signal;i&&(i.aborted&&this.controller.abort(),i.addEventListener("abort",()=>this.controller.abort()));const a={...s,stream:!0},o=await e.create(t,a,{...r,signal:this.controller.signal});this._connected();for await(const l of o)P(this,ce,"m",Dn).call(this,l);if(o.controller.signal?.aborted)throw new Be;return this._addRun(P(this,ce,"m",zn).call(this))}static accumulateDelta(e,t){for(const[s,r]of Object.entries(t)){if(!e.hasOwnProperty(s)){e[s]=r;continue}let i=e[s];if(i==null){e[s]=r;continue}if(s==="index"||s==="type"){e[s]=r;continue}if(typeof i=="string"&&typeof r=="string")i+=r;else if(typeof i=="number"&&typeof r=="number")i+=r;else if(Cr(i)&&Cr(r))i=this.accumulateDelta(i,r);else if(Array.isArray(i)&&Array.isArray(r)){if(i.every(a=>typeof a=="string"||typeof a=="number")){i.push(...r);continue}for(const a of r){if(!Cr(a))throw new Error(`Expected array delta entry to be an object but got: ${a}`);const o=a.index;if(o==null)throw console.error(a),new Error("Expected array delta entry to have an `index` property");if(typeof o!="number")throw new Error(`Expected array delta entry \`index\` property to be a number but got ${o}`);const l=i[o];l==null?i.push(a):i[o]=this.accumulateDelta(l,a)}continue}else throw Error(`Unhandled record type: ${s}, deltaValue: ${r}, accValue: ${i}`);e[s]=i}return e}_addRun(e){return e}async _threadAssistantStream(e,t,s){return await this._createThreadAssistantStream(t,e,s)}async _runAssistantStream(e,t,s,r){return await this._createAssistantStream(t,e,s,r)}async _runToolAssistantStream(e,t,s,r,i){return await this._createToolAssistantStream(s,e,t,r,i)}}Dn=function(e){if(!this.ended)switch(Se(this,Ts,e,"f"),P(this,ce,"m",so).call(this,e),e.event){case"thread.created":break;case"thread.run.created":case"thread.run.queued":case"thread.run.in_progress":case"thread.run.requires_action":case"thread.run.completed":case"thread.run.incomplete":case"thread.run.failed":case"thread.run.cancelling":case"thread.run.cancelled":case"thread.run.expired":P(this,ce,"m",oo).call(this,e);break;case"thread.run.step.created":case"thread.run.step.in_progress":case"thread.run.step.delta":case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":P(this,ce,"m",no).call(this,e);break;case"thread.message.created":case"thread.message.in_progress":case"thread.message.delta":case"thread.message.completed":case"thread.message.incomplete":P(this,ce,"m",to).call(this,e);break;case"error":throw new Error("Encountered an error event in event processing - errors should be processed earlier")}},zn=function(){if(this.ended)throw new N("stream has ended, this shouldn't happen");if(!P(this,zt,"f"))throw Error("Final run has not been received");return P(this,zt,"f")},to=function(e){const[t,s]=P(this,ce,"m",io).call(this,e,P(this,Xe,"f"));Se(this,Xe,t,"f"),P(this,Ms,"f")[t.id]=t;for(const r of s){const i=t.content[r.index];i?.type=="text"&&this._emit("textCreated",i.text)}switch(e.event){case"thread.message.created":this._emit("messageCreated",e.data);break;case"thread.message.in_progress":break;case"thread.message.delta":if(this._emit("messageDelta",e.data.delta,t),e.data.delta.content)for(const r of e.data.delta.content){if(r.type=="text"&&r.text){let i=r.text,a=t.content[r.index];if(a&&a.type=="text")this._emit("textDelta",i,a.text);else throw Error("The snapshot associated with this text delta is not text or missing")}if(r.index!=P(this,un,"f")){if(P(this,Ft,"f"))switch(P(this,Ft,"f").type){case"text":this._emit("textDone",P(this,Ft,"f").text,P(this,Xe,"f"));break;case"image_file":this._emit("imageFileDone",P(this,Ft,"f").image_file,P(this,Xe,"f"));break}Se(this,un,r.index,"f")}Se(this,Ft,t.content[r.index],"f")}break;case"thread.message.completed":case"thread.message.incomplete":if(P(this,un,"f")!==void 0){const r=e.data.content[P(this,un,"f")];if(r)switch(r.type){case"image_file":this._emit("imageFileDone",r.image_file,P(this,Xe,"f"));break;case"text":this._emit("textDone",r.text,P(this,Xe,"f"));break}}P(this,Xe,"f")&&this._emit("messageDone",e.data),Se(this,Xe,void 0,"f")}},no=function(e){const t=P(this,ce,"m",ro).call(this,e);switch(Se(this,jn,t,"f"),e.event){case"thread.run.step.created":this._emit("runStepCreated",e.data);break;case"thread.run.step.delta":const s=e.data.delta;if(s.step_details&&s.step_details.type=="tool_calls"&&s.step_details.tool_calls&&t.step_details.type=="tool_calls")for(const i of s.step_details.tool_calls)i.index==P(this,Us,"f")?this._emit("toolCallDelta",i,t.step_details.tool_calls[i.index]):(P(this,Pe,"f")&&this._emit("toolCallDone",P(this,Pe,"f")),Se(this,Us,i.index,"f"),Se(this,Pe,t.step_details.tool_calls[i.index],"f"),P(this,Pe,"f")&&this._emit("toolCallCreated",P(this,Pe,"f")));this._emit("runStepDelta",e.data.delta,t);break;case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":Se(this,jn,void 0,"f"),e.data.step_details.type=="tool_calls"&&P(this,Pe,"f")&&(this._emit("toolCallDone",P(this,Pe,"f")),Se(this,Pe,void 0,"f")),this._emit("runStepDone",e.data,t);break}},so=function(e){P(this,Yr,"f").push(e),this._emit("event",e)},ro=function(e){switch(e.event){case"thread.run.step.created":return P(this,Ze,"f")[e.data.id]=e.data,e.data;case"thread.run.step.delta":let t=P(this,Ze,"f")[e.data.id];if(!t)throw Error("Received a RunStepDelta before creation of a snapshot");let s=e.data;if(s.delta){const r=Ge.accumulateDelta(t,s.delta);P(this,Ze,"f")[e.data.id]=r}return P(this,Ze,"f")[e.data.id];case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":case"thread.run.step.in_progress":P(this,Ze,"f")[e.data.id]=e.data;break}if(P(this,Ze,"f")[e.data.id])return P(this,Ze,"f")[e.data.id];throw new Error("No snapshot available")},io=function(e,t){let s=[];switch(e.event){case"thread.message.created":return[e.data,s];case"thread.message.delta":if(!t)throw Error("Received a delta with no existing snapshot (there should be one from message creation)");let r=e.data;if(r.delta.content)for(const i of r.delta.content)if(i.index in t.content){let a=t.content[i.index];t.content[i.index]=P(this,ce,"m",ao).call(this,i,a)}else t.content[i.index]=i,s.push(i);return[t,s];case"thread.message.in_progress":case"thread.message.completed":case"thread.message.incomplete":if(t)return[t,s];throw Error("Received thread message event with no existing snapshot")}throw Error("Tried to accumulate a non-message event")},ao=function(e,t){return Ge.accumulateDelta(t,e)},oo=function(e){switch(Se(this,Ns,e.data,"f"),e.event){case"thread.run.created":break;case"thread.run.queued":break;case"thread.run.in_progress":break;case"thread.run.requires_action":case"thread.run.cancelled":case"thread.run.failed":case"thread.run.completed":case"thread.run.expired":Se(this,zt,e.data,"f"),P(this,Pe,"f")&&(this._emit("toolCallDone",P(this,Pe,"f")),Se(this,Pe,void 0,"f"));break}};class bi extends L{create(e,t){return this._client.post("/assistants",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}retrieve(e,t){return this._client.get(`/assistants/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}update(e,t,s){return this._client.post(`/assistants/${e}`,{body:t,...s,headers:{"OpenAI-Beta":"assistants=v2",...s?.headers}})}list(e={},t){return Z(e)?this.list({},e):this._client.getAPIList("/assistants",xi,{query:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}del(e,t){return this._client.delete(`/assistants/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}}class xi extends re{}bi.AssistantsPage=xi;function lo(n){return typeof n.parse=="function"}const dn=n=>n?.role==="assistant",Fl=n=>n?.role==="function",Dl=n=>n?.role==="tool";function ki(n){return n?.$brand==="auto-parseable-response-format"}function ts(n){return n?.$brand==="auto-parseable-tool"}function ah(n,e){return!e||!zl(e)?{...n,choices:n.choices.map(t=>({...t,message:{...t.message,parsed:null,...t.message.tool_calls?{tool_calls:t.message.tool_calls}:void 0}}))}:Ci(n,e)}function Ci(n,e){const t=n.choices.map(s=>{if(s.finish_reason==="length")throw new wl;if(s.finish_reason==="content_filter")throw new bl;return{...s,message:{...s.message,...s.message.tool_calls?{tool_calls:s.message.tool_calls?.map(r=>lh(e,r))??void 0}:void 0,parsed:s.message.content&&!s.message.refusal?oh(e,s.message.content):null}}});return{...n,choices:t}}function oh(n,e){return n.response_format?.type!=="json_schema"?null:n.response_format?.type==="json_schema"?"$parseRaw"in n.response_format?n.response_format.$parseRaw(e):JSON.parse(e):null}function lh(n,e){const t=n.tools?.find(s=>s.function?.name===e.function.name);return{...e,function:{...e.function,parsed_arguments:ts(t)?t.$parseRaw(e.function.arguments):t?.function.strict?JSON.parse(e.function.arguments):null}}}function ch(n,e){if(!n)return!1;const t=n.tools?.find(s=>s.function?.name===e.function.name);return ts(t)||t?.function.strict||!1}function zl(n){return ki(n.response_format)?!0:n.tools?.some(e=>ts(e)||e.type==="function"&&e.function.strict===!0)??!1}function uh(n){for(const e of n??[]){if(e.type!=="function")throw new N(`Currently only \`function\` tool types support auto-parsing; Received \`${e.type}\``);if(e.function.strict!==!0)throw new N(`The \`${e.function.name}\` tool is not marked with \`strict: true\`. Only strict function tools can be auto-parsed`)}}var ye=function(n,e,t,s){if(t==="a"&&!s)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?n!==e||!s:!e.has(n))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?s:t==="a"?s.call(n):s?s.value:e.get(n)},pe,Vr,js,Jr,Kr,Qr,Bl,Zr;const co=10;class Hl extends wi{constructor(){super(...arguments),pe.add(this),this._chatCompletions=[],this.messages=[]}_addChatCompletion(e){this._chatCompletions.push(e),this._emit("chatCompletion",e);const t=e.choices[0]?.message;return t&&this._addMessage(t),e}_addMessage(e,t=!0){if("content"in e||(e.content=null),this.messages.push(e),t){if(this._emit("message",e),(Fl(e)||Dl(e))&&e.content)this._emit("functionCallResult",e.content);else if(dn(e)&&e.function_call)this._emit("functionCall",e.function_call);else if(dn(e)&&e.tool_calls)for(const s of e.tool_calls)s.type==="function"&&this._emit("functionCall",s.function)}}async finalChatCompletion(){await this.done();const e=this._chatCompletions[this._chatCompletions.length-1];if(!e)throw new N("stream ended without producing a ChatCompletion");return e}async finalContent(){return await this.done(),ye(this,pe,"m",Vr).call(this)}async finalMessage(){return await this.done(),ye(this,pe,"m",js).call(this)}async finalFunctionCall(){return await this.done(),ye(this,pe,"m",Jr).call(this)}async finalFunctionCallResult(){return await this.done(),ye(this,pe,"m",Kr).call(this)}async totalUsage(){return await this.done(),ye(this,pe,"m",Qr).call(this)}allChatCompletions(){return[...this._chatCompletions]}_emitFinal(){const e=this._chatCompletions[this._chatCompletions.length-1];e&&this._emit("finalChatCompletion",e);const t=ye(this,pe,"m",js).call(this);t&&this._emit("finalMessage",t);const s=ye(this,pe,"m",Vr).call(this);s&&this._emit("finalContent",s);const r=ye(this,pe,"m",Jr).call(this);r&&this._emit("finalFunctionCall",r);const i=ye(this,pe,"m",Kr).call(this);i!=null&&this._emit("finalFunctionCallResult",i),this._chatCompletions.some(a=>a.usage)&&this._emit("totalUsage",ye(this,pe,"m",Qr).call(this))}async _createChatCompletion(e,t,s){const r=s?.signal;r&&(r.aborted&&this.controller.abort(),r.addEventListener("abort",()=>this.controller.abort())),ye(this,pe,"m",Bl).call(this,t);const i=await e.chat.completions.create({...t,stream:!1},{...s,signal:this.controller.signal});return this._connected(),this._addChatCompletion(Ci(i,t))}async _runChatCompletion(e,t,s){for(const r of t.messages)this._addMessage(r,!1);return await this._createChatCompletion(e,t,s)}async _runFunctions(e,t,s){const r="function",{function_call:i="auto",stream:a,...o}=t,l=typeof i!="string"&&i?.name,{maxChatCompletions:c=co}=s||{},h={};for(const u of t.functions)h[u.name||u.function.name]=u;const f=t.functions.map(u=>({name:u.name||u.function.name,parameters:u.parameters,description:u.description}));for(const u of t.messages)this._addMessage(u,!1);for(let u=0;u<c;++u){const g=(await this._createChatCompletion(e,{...o,function_call:i,functions:f,messages:[...this.messages]},s)).choices[0]?.message;if(!g)throw new N("missing message in ChatCompletion response");if(!g.function_call)return;const{name:_,arguments:m}=g.function_call,v=h[_];if(v){if(l&&l!==_){const R=`Invalid function_call: ${JSON.stringify(_)}. ${JSON.stringify(l)} requested. Please try again`;this._addMessage({role:r,name:_,content:R});continue}}else{const R=`Invalid function_call: ${JSON.stringify(_)}. Available options are: ${f.map(I=>JSON.stringify(I.name)).join(", ")}. Please try again`;this._addMessage({role:r,name:_,content:R});continue}let y;try{y=lo(v)?await v.parse(m):m}catch(R){this._addMessage({role:r,name:_,content:R instanceof Error?R.message:String(R)});continue}const A=await v.function(y,this),k=ye(this,pe,"m",Zr).call(this,A);if(this._addMessage({role:r,name:_,content:k}),l)return}}async _runTools(e,t,s){const r="tool",{tool_choice:i="auto",stream:a,...o}=t,l=typeof i!="string"&&i?.function?.name,{maxChatCompletions:c=co}=s||{},h=t.tools.map(d=>{if(ts(d)){if(!d.$callback)throw new N("Tool given to `.runTools()` that does not have an associated function");return{type:"function",function:{function:d.$callback,name:d.function.name,description:d.function.description||"",parameters:d.function.parameters,parse:d.$parseRaw,strict:!0}}}return d}),f={};for(const d of h)d.type==="function"&&(f[d.function.name||d.function.function.name]=d.function);const u="tools"in t?h.map(d=>d.type==="function"?{type:"function",function:{name:d.function.name||d.function.function.name,parameters:d.function.parameters,description:d.function.description,strict:d.function.strict}}:d):void 0;for(const d of t.messages)this._addMessage(d,!1);for(let d=0;d<c;++d){const _=(await this._createChatCompletion(e,{...o,tool_choice:i,tools:u,messages:[...this.messages]},s)).choices[0]?.message;if(!_)throw new N("missing message in ChatCompletion response");if(!_.tool_calls?.length)return;for(const m of _.tool_calls){if(m.type!=="function")continue;const v=m.id,{name:y,arguments:A}=m.function,k=f[y];if(k){if(l&&l!==y){const C=`Invalid tool_call: ${JSON.stringify(y)}. ${JSON.stringify(l)} requested. Please try again`;this._addMessage({role:r,tool_call_id:v,content:C});continue}}else{const C=`Invalid tool_call: ${JSON.stringify(y)}. Available options are: ${Object.keys(f).map(T=>JSON.stringify(T)).join(", ")}. Please try again`;this._addMessage({role:r,tool_call_id:v,content:C});continue}let R;try{R=lo(k)?await k.parse(A):A}catch(C){const T=C instanceof Error?C.message:String(C);this._addMessage({role:r,tool_call_id:v,content:T});continue}const I=await k.function(R,this),M=ye(this,pe,"m",Zr).call(this,I);if(this._addMessage({role:r,tool_call_id:v,content:M}),l)return}}}}pe=new WeakSet,Vr=function(){return ye(this,pe,"m",js).call(this).content??null},js=function(){let e=this.messages.length;for(;e-- >0;){const t=this.messages[e];if(dn(t)){const{function_call:s,...r}=t,i={...r,content:t.content??null,refusal:t.refusal??null};return s&&(i.function_call=s),i}}throw new N("stream ended without producing a ChatCompletionMessage with role=assistant")},Jr=function(){for(let e=this.messages.length-1;e>=0;e--){const t=this.messages[e];if(dn(t)&&t?.function_call)return t.function_call;if(dn(t)&&t?.tool_calls?.length)return t.tool_calls.at(-1)?.function}},Kr=function(){for(let e=this.messages.length-1;e>=0;e--){const t=this.messages[e];if(Fl(t)&&t.content!=null||Dl(t)&&t.content!=null&&typeof t.content=="string"&&this.messages.some(s=>s.role==="assistant"&&s.tool_calls?.some(r=>r.type==="function"&&r.id===t.tool_call_id)))return t.content}},Qr=function(){const e={completion_tokens:0,prompt_tokens:0,total_tokens:0};for(const{usage:t}of this._chatCompletions)t&&(e.completion_tokens+=t.completion_tokens,e.prompt_tokens+=t.prompt_tokens,e.total_tokens+=t.total_tokens);return e},Bl=function(e){if(e.n!=null&&e.n>1)throw new N("ChatCompletion convenience helpers only support n=1 at this time. To use n>1, please use chat.completions.create() directly.")},Zr=function(e){return typeof e=="string"?e:e===void 0?"undefined":JSON.stringify(e)};class Yn extends Hl{static runFunctions(e,t,s){const r=new Yn,i={...s,headers:{...s?.headers,"X-Stainless-Helper-Method":"runFunctions"}};return r._run(()=>r._runFunctions(e,t,i)),r}static runTools(e,t,s){const r=new Yn,i={...s,headers:{...s?.headers,"X-Stainless-Helper-Method":"runTools"}};return r._run(()=>r._runTools(e,t,i)),r}_addMessage(e,t=!0){super._addMessage(e,t),dn(e)&&e.content&&this._emit("content",e.content)}}const Wl=1,Ul=2,jl=4,ql=8,Xl=16,Gl=32,Yl=64,Vl=128,Jl=256,Kl=Vl|Jl,Ql=Xl|Gl|Kl|Yl,Zl=Wl|Ul|Ql,ec=jl|ql,dh=Zl|ec,ae={STR:Wl,NUM:Ul,ARR:jl,OBJ:ql,NULL:Xl,BOOL:Gl,NAN:Yl,INFINITY:Vl,MINUS_INFINITY:Jl,INF:Kl,SPECIAL:Ql,ATOM:Zl,COLLECTION:ec,ALL:dh};class fh extends Error{}class hh extends Error{}function ph(n,e=ae.ALL){if(typeof n!="string")throw new TypeError(`expecting str, got ${typeof n}`);if(!n.trim())throw new Error(`${n} is empty`);return gh(n.trim(),e)}const gh=(n,e)=>{const t=n.length;let s=0;const r=u=>{throw new fh(`${u} at position ${s}`)},i=u=>{throw new hh(`${u} at position ${s}`)},a=()=>(f(),s>=t&&r("Unexpected end of input"),n[s]==='"'?o():n[s]==="{"?l():n[s]==="["?c():n.substring(s,s+4)==="null"||ae.NULL&e&&t-s<4&&"null".startsWith(n.substring(s))?(s+=4,null):n.substring(s,s+4)==="true"||ae.BOOL&e&&t-s<4&&"true".startsWith(n.substring(s))?(s+=4,!0):n.substring(s,s+5)==="false"||ae.BOOL&e&&t-s<5&&"false".startsWith(n.substring(s))?(s+=5,!1):n.substring(s,s+8)==="Infinity"||ae.INFINITY&e&&t-s<8&&"Infinity".startsWith(n.substring(s))?(s+=8,1/0):n.substring(s,s+9)==="-Infinity"||ae.MINUS_INFINITY&e&&1<t-s&&t-s<9&&"-Infinity".startsWith(n.substring(s))?(s+=9,-1/0):n.substring(s,s+3)==="NaN"||ae.NAN&e&&t-s<3&&"NaN".startsWith(n.substring(s))?(s+=3,NaN):h()),o=()=>{const u=s;let d=!1;for(s++;s<t&&(n[s]!=='"'||d&&n[s-1]==="\\");)d=n[s]==="\\"?!d:!1,s++;if(n.charAt(s)=='"')try{return JSON.parse(n.substring(u,++s-Number(d)))}catch(g){i(String(g))}else if(ae.STR&e)try{return JSON.parse(n.substring(u,s-Number(d))+'"')}catch{return JSON.parse(n.substring(u,n.lastIndexOf("\\"))+'"')}r("Unterminated string literal")},l=()=>{s++,f();const u={};try{for(;n[s]!=="}";){if(f(),s>=t&&ae.OBJ&e)return u;const d=o();f(),s++;try{const g=a();Object.defineProperty(u,d,{value:g,writable:!0,enumerable:!0,configurable:!0})}catch(g){if(ae.OBJ&e)return u;throw g}f(),n[s]===","&&s++}}catch{if(ae.OBJ&e)return u;r("Expected '}' at end of object")}return s++,u},c=()=>{s++;const u=[];try{for(;n[s]!=="]";)u.push(a()),f(),n[s]===","&&s++}catch{if(ae.ARR&e)return u;r("Expected ']' at end of array")}return s++,u},h=()=>{if(s===0){n==="-"&&ae.NUM&e&&r("Not sure what '-' is");try{return JSON.parse(n)}catch(d){if(ae.NUM&e)try{return n[n.length-1]==="."?JSON.parse(n.substring(0,n.lastIndexOf("."))):JSON.parse(n.substring(0,n.lastIndexOf("e")))}catch{}i(String(d))}}const u=s;for(n[s]==="-"&&s++;n[s]&&!",]}".includes(n[s]);)s++;s==t&&!(ae.NUM&e)&&r("Unterminated number literal");try{return JSON.parse(n.substring(u,s))}catch{n.substring(u,s)==="-"&&ae.NUM&e&&r("Not sure what '-' is");try{return JSON.parse(n.substring(u,n.lastIndexOf("e")))}catch(g){i(String(g))}}},f=()=>{for(;s<t&&` 
\r	`.includes(n[s]);)s++};return a()},uo=n=>ph(n,ae.ALL^ae.NUM);var tn=function(n,e,t,s,r){if(s==="m")throw new TypeError("Private method is not writable");if(s==="a"&&!r)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?n!==e||!r:!e.has(n))throw new TypeError("Cannot write private member to an object whose class did not declare it");return s==="a"?r.call(n,t):r?r.value=t:e.set(n,t),t},j=function(n,e,t,s){if(t==="a"&&!s)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?n!==e||!s:!e.has(n))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?s:t==="a"?s.call(n):s?s.value:e.get(n)},ne,ot,nn,yt,Er,bs,Sr,Ar,Rr,xs,Pr,fo;class Vn extends Hl{constructor(e){super(),ne.add(this),ot.set(this,void 0),nn.set(this,void 0),yt.set(this,void 0),tn(this,ot,e,"f"),tn(this,nn,[],"f")}get currentChatCompletionSnapshot(){return j(this,yt,"f")}static fromReadableStream(e){const t=new Vn(null);return t._run(()=>t._fromReadableStream(e)),t}static createChatCompletion(e,t,s){const r=new Vn(t);return r._run(()=>r._runChatCompletion(e,{...t,stream:!0},{...s,headers:{...s?.headers,"X-Stainless-Helper-Method":"stream"}})),r}async _createChatCompletion(e,t,s){super._createChatCompletion;const r=s?.signal;r&&(r.aborted&&this.controller.abort(),r.addEventListener("abort",()=>this.controller.abort())),j(this,ne,"m",Er).call(this);const i=await e.chat.completions.create({...t,stream:!0},{...s,signal:this.controller.signal});this._connected();for await(const a of i)j(this,ne,"m",Sr).call(this,a);if(i.controller.signal?.aborted)throw new Be;return this._addChatCompletion(j(this,ne,"m",xs).call(this))}async _fromReadableStream(e,t){const s=t?.signal;s&&(s.aborted&&this.controller.abort(),s.addEventListener("abort",()=>this.controller.abort())),j(this,ne,"m",Er).call(this),this._connected();const r=nt.fromReadableStream(e,this.controller);let i;for await(const a of r)i&&i!==a.id&&this._addChatCompletion(j(this,ne,"m",xs).call(this)),j(this,ne,"m",Sr).call(this,a),i=a.id;if(r.controller.signal?.aborted)throw new Be;return this._addChatCompletion(j(this,ne,"m",xs).call(this))}[(ot=new WeakMap,nn=new WeakMap,yt=new WeakMap,ne=new WeakSet,Er=function(){this.ended||tn(this,yt,void 0,"f")},bs=function(t){let s=j(this,nn,"f")[t.index];return s||(s={content_done:!1,refusal_done:!1,logprobs_content_done:!1,logprobs_refusal_done:!1,done_tool_calls:new Set,current_tool_call_index:null},j(this,nn,"f")[t.index]=s,s)},Sr=function(t){if(this.ended)return;const s=j(this,ne,"m",fo).call(this,t);this._emit("chunk",t,s);for(const r of t.choices){const i=s.choices[r.index];r.delta.content!=null&&i.message?.role==="assistant"&&i.message?.content&&(this._emit("content",r.delta.content,i.message.content),this._emit("content.delta",{delta:r.delta.content,snapshot:i.message.content,parsed:i.message.parsed})),r.delta.refusal!=null&&i.message?.role==="assistant"&&i.message?.refusal&&this._emit("refusal.delta",{delta:r.delta.refusal,snapshot:i.message.refusal}),r.logprobs?.content!=null&&i.message?.role==="assistant"&&this._emit("logprobs.content.delta",{content:r.logprobs?.content,snapshot:i.logprobs?.content??[]}),r.logprobs?.refusal!=null&&i.message?.role==="assistant"&&this._emit("logprobs.refusal.delta",{refusal:r.logprobs?.refusal,snapshot:i.logprobs?.refusal??[]});const a=j(this,ne,"m",bs).call(this,i);i.finish_reason&&(j(this,ne,"m",Rr).call(this,i),a.current_tool_call_index!=null&&j(this,ne,"m",Ar).call(this,i,a.current_tool_call_index));for(const o of r.delta.tool_calls??[])a.current_tool_call_index!==o.index&&(j(this,ne,"m",Rr).call(this,i),a.current_tool_call_index!=null&&j(this,ne,"m",Ar).call(this,i,a.current_tool_call_index)),a.current_tool_call_index=o.index;for(const o of r.delta.tool_calls??[]){const l=i.message.tool_calls?.[o.index];l?.type&&(l?.type==="function"?this._emit("tool_calls.function.arguments.delta",{name:l.function?.name,index:o.index,arguments:l.function.arguments,parsed_arguments:l.function.parsed_arguments,arguments_delta:o.function?.arguments??""}):(l?.type,void 0))}}},Ar=function(t,s){if(j(this,ne,"m",bs).call(this,t).done_tool_calls.has(s))return;const i=t.message.tool_calls?.[s];if(!i)throw new Error("no tool call snapshot");if(!i.type)throw new Error("tool call snapshot missing `type`");if(i.type==="function"){const a=j(this,ot,"f")?.tools?.find(o=>o.type==="function"&&o.function.name===i.function.name);this._emit("tool_calls.function.arguments.done",{name:i.function.name,index:s,arguments:i.function.arguments,parsed_arguments:ts(a)?a.$parseRaw(i.function.arguments):a?.function.strict?JSON.parse(i.function.arguments):null})}else i.type},Rr=function(t){const s=j(this,ne,"m",bs).call(this,t);if(t.message.content&&!s.content_done){s.content_done=!0;const r=j(this,ne,"m",Pr).call(this);this._emit("content.done",{content:t.message.content,parsed:r?r.$parseRaw(t.message.content):null})}t.message.refusal&&!s.refusal_done&&(s.refusal_done=!0,this._emit("refusal.done",{refusal:t.message.refusal})),t.logprobs?.content&&!s.logprobs_content_done&&(s.logprobs_content_done=!0,this._emit("logprobs.content.done",{content:t.logprobs.content})),t.logprobs?.refusal&&!s.logprobs_refusal_done&&(s.logprobs_refusal_done=!0,this._emit("logprobs.refusal.done",{refusal:t.logprobs.refusal}))},xs=function(){if(this.ended)throw new N("stream has ended, this shouldn't happen");const t=j(this,yt,"f");if(!t)throw new N("request ended without sending any chunks");return tn(this,yt,void 0,"f"),tn(this,nn,[],"f"),mh(t,j(this,ot,"f"))},Pr=function(){const t=j(this,ot,"f")?.response_format;return ki(t)?t:null},fo=function(t){var s,r,i,a;let o=j(this,yt,"f");const{choices:l,...c}=t;o?Object.assign(o,c):o=tn(this,yt,{...c,choices:[]},"f");for(const{delta:h,finish_reason:f,index:u,logprobs:d=null,...g}of t.choices){let _=o.choices[u];if(_||(_=o.choices[u]={finish_reason:f,index:u,message:{},logprobs:d,...g}),d)if(!_.logprobs)_.logprobs=Object.assign({},d);else{const{content:I,refusal:M,...C}=d;Object.assign(_.logprobs,C),I&&((s=_.logprobs).content??(s.content=[]),_.logprobs.content.push(...I)),M&&((r=_.logprobs).refusal??(r.refusal=[]),_.logprobs.refusal.push(...M))}if(f&&(_.finish_reason=f,j(this,ot,"f")&&zl(j(this,ot,"f")))){if(f==="length")throw new wl;if(f==="content_filter")throw new bl}if(Object.assign(_,g),!h)continue;const{content:m,refusal:v,function_call:y,role:A,tool_calls:k,...R}=h;if(Object.assign(_.message,R),v&&(_.message.refusal=(_.message.refusal||"")+v),A&&(_.message.role=A),y&&(_.message.function_call?(y.name&&(_.message.function_call.name=y.name),y.arguments&&((i=_.message.function_call).arguments??(i.arguments=""),_.message.function_call.arguments+=y.arguments)):_.message.function_call=y),m&&(_.message.content=(_.message.content||"")+m,!_.message.refusal&&j(this,ne,"m",Pr).call(this)&&(_.message.parsed=uo(_.message.content))),k){_.message.tool_calls||(_.message.tool_calls=[]);for(const{index:I,id:M,type:C,function:T,...O}of k){const W=(a=_.message.tool_calls)[I]??(a[I]={});Object.assign(W,O),M&&(W.id=M),C&&(W.type=C),T&&(W.function??(W.function={name:T.name??"",arguments:""})),T?.name&&(W.function.name=T.name),T?.arguments&&(W.function.arguments+=T.arguments,ch(j(this,ot,"f"),W)&&(W.function.parsed_arguments=uo(W.function.arguments)))}}}return o},Symbol.asyncIterator)](){const e=[],t=[];let s=!1;return this.on("chunk",r=>{const i=t.shift();i?i.resolve(r):e.push(r)}),this.on("end",()=>{s=!0;for(const r of t)r.resolve(void 0);t.length=0}),this.on("abort",r=>{s=!0;for(const i of t)i.reject(r);t.length=0}),this.on("error",r=>{s=!0;for(const i of t)i.reject(r);t.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:s?{value:void 0,done:!0}:new Promise((i,a)=>t.push({resolve:i,reject:a})).then(i=>i?{value:i,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}toReadableStream(){return new nt(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}}function mh(n,e){const{id:t,choices:s,created:r,model:i,system_fingerprint:a,...o}=n,l={...o,id:t,choices:s.map(({message:c,finish_reason:h,index:f,logprobs:u,...d})=>{if(!h)throw new N(`missing finish_reason for choice ${f}`);const{content:g=null,function_call:_,tool_calls:m,...v}=c,y=c.role;if(!y)throw new N(`missing role for choice ${f}`);if(_){const{arguments:A,name:k}=_;if(A==null)throw new N(`missing function_call.arguments for choice ${f}`);if(!k)throw new N(`missing function_call.name for choice ${f}`);return{...d,message:{content:g,function_call:{arguments:A,name:k},role:y,refusal:c.refusal??null},finish_reason:h,index:f,logprobs:u}}return m?{...d,index:f,finish_reason:h,logprobs:u,message:{...v,role:y,content:g,refusal:c.refusal??null,tool_calls:m.map((A,k)=>{const{function:R,type:I,id:M,...C}=A,{arguments:T,name:O,...W}=R||{};if(M==null)throw new N(`missing choices[${f}].tool_calls[${k}].id
${ks(n)}`);if(I==null)throw new N(`missing choices[${f}].tool_calls[${k}].type
${ks(n)}`);if(O==null)throw new N(`missing choices[${f}].tool_calls[${k}].function.name
${ks(n)}`);if(T==null)throw new N(`missing choices[${f}].tool_calls[${k}].function.arguments
${ks(n)}`);return{...C,id:M,type:I,function:{...W,name:O,arguments:T}}})}}:{...d,message:{...v,content:g,role:y,refusal:c.refusal??null},finish_reason:h,index:f,logprobs:u}}),created:r,model:i,object:"chat.completion",...a?{system_fingerprint:a}:{}};return ah(l,e)}function ks(n){return JSON.stringify(n)}class fn extends Vn{static fromReadableStream(e){const t=new fn(null);return t._run(()=>t._fromReadableStream(e)),t}static runFunctions(e,t,s){const r=new fn(null),i={...s,headers:{...s?.headers,"X-Stainless-Helper-Method":"runFunctions"}};return r._run(()=>r._runFunctions(e,t,i)),r}static runTools(e,t,s){const r=new fn(t),i={...s,headers:{...s?.headers,"X-Stainless-Helper-Method":"runTools"}};return r._run(()=>r._runTools(e,t,i)),r}}let tc=class extends L{parse(e,t){return uh(e.tools),this._client.chat.completions.create(e,{...t,headers:{...t?.headers,"X-Stainless-Helper-Method":"beta.chat.completions.parse"}})._thenUnwrap(s=>Ci(s,e))}runFunctions(e,t){return e.stream?fn.runFunctions(this._client,e,t):Yn.runFunctions(this._client,e,t)}runTools(e,t){return e.stream?fn.runTools(this._client,e,t):Yn.runTools(this._client,e,t)}stream(e,t){return Vn.createChatCompletion(this._client,e,t)}};class ei extends L{constructor(){super(...arguments),this.completions=new tc(this._client)}}(function(n){n.Completions=tc})(ei||(ei={}));class nc extends L{create(e,t){return this._client.post("/realtime/sessions",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}}class sc extends L{create(e,t){return this._client.post("/realtime/transcription_sessions",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}}class or extends L{constructor(){super(...arguments),this.sessions=new nc(this._client),this.transcriptionSessions=new sc(this._client)}}or.Sessions=nc;or.TranscriptionSessions=sc;class Ei extends L{create(e,t,s){return this._client.post(`/threads/${e}/messages`,{body:t,...s,headers:{"OpenAI-Beta":"assistants=v2",...s?.headers}})}retrieve(e,t,s){return this._client.get(`/threads/${e}/messages/${t}`,{...s,headers:{"OpenAI-Beta":"assistants=v2",...s?.headers}})}update(e,t,s,r){return this._client.post(`/threads/${e}/messages/${t}`,{body:s,...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}list(e,t={},s){return Z(t)?this.list(e,{},t):this._client.getAPIList(`/threads/${e}/messages`,Si,{query:t,...s,headers:{"OpenAI-Beta":"assistants=v2",...s?.headers}})}del(e,t,s){return this._client.delete(`/threads/${e}/messages/${t}`,{...s,headers:{"OpenAI-Beta":"assistants=v2",...s?.headers}})}}class Si extends re{}Ei.MessagesPage=Si;class Ai extends L{retrieve(e,t,s,r={},i){return Z(r)?this.retrieve(e,t,s,{},r):this._client.get(`/threads/${e}/runs/${t}/steps/${s}`,{query:r,...i,headers:{"OpenAI-Beta":"assistants=v2",...i?.headers}})}list(e,t,s={},r){return Z(s)?this.list(e,t,{},s):this._client.getAPIList(`/threads/${e}/runs/${t}/steps`,Ri,{query:s,...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}}class Ri extends re{}Ai.RunStepsPage=Ri;let ns=class extends L{constructor(){super(...arguments),this.steps=new Ai(this._client)}create(e,t,s){const{include:r,...i}=t;return this._client.post(`/threads/${e}/runs`,{query:{include:r},body:i,...s,headers:{"OpenAI-Beta":"assistants=v2",...s?.headers},stream:t.stream??!1})}retrieve(e,t,s){return this._client.get(`/threads/${e}/runs/${t}`,{...s,headers:{"OpenAI-Beta":"assistants=v2",...s?.headers}})}update(e,t,s,r){return this._client.post(`/threads/${e}/runs/${t}`,{body:s,...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}list(e,t={},s){return Z(t)?this.list(e,{},t):this._client.getAPIList(`/threads/${e}/runs`,Pi,{query:t,...s,headers:{"OpenAI-Beta":"assistants=v2",...s?.headers}})}cancel(e,t,s){return this._client.post(`/threads/${e}/runs/${t}/cancel`,{...s,headers:{"OpenAI-Beta":"assistants=v2",...s?.headers}})}async createAndPoll(e,t,s){const r=await this.create(e,t,s);return await this.poll(e,r.id,s)}createAndStream(e,t,s){return Ge.createAssistantStream(e,this._client.beta.threads.runs,t,s)}async poll(e,t,s){const r={...s?.headers,"X-Stainless-Poll-Helper":"true"};for(s?.pollIntervalMs&&(r["X-Stainless-Custom-Poll-Interval"]=s.pollIntervalMs.toString());;){const{data:i,response:a}=await this.retrieve(e,t,{...s,headers:{...s?.headers,...r}}).withResponse();switch(i.status){case"queued":case"in_progress":case"cancelling":let o=5e3;if(s?.pollIntervalMs)o=s.pollIntervalMs;else{const l=a.headers.get("openai-poll-after-ms");if(l){const c=parseInt(l);isNaN(c)||(o=c)}}await Zn(o);break;case"requires_action":case"incomplete":case"cancelled":case"completed":case"failed":case"expired":return i}}}stream(e,t,s){return Ge.createAssistantStream(e,this._client.beta.threads.runs,t,s)}submitToolOutputs(e,t,s,r){return this._client.post(`/threads/${e}/runs/${t}/submit_tool_outputs`,{body:s,...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers},stream:s.stream??!1})}async submitToolOutputsAndPoll(e,t,s,r){const i=await this.submitToolOutputs(e,t,s,r);return await this.poll(e,i.id,r)}submitToolOutputsStream(e,t,s,r){return Ge.createToolAssistantStream(e,t,this._client.beta.threads.runs,s,r)}};class Pi extends re{}ns.RunsPage=Pi;ns.Steps=Ai;ns.RunStepsPage=Ri;class bn extends L{constructor(){super(...arguments),this.runs=new ns(this._client),this.messages=new Ei(this._client)}create(e={},t){return Z(e)?this.create({},e):this._client.post("/threads",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}retrieve(e,t){return this._client.get(`/threads/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}update(e,t,s){return this._client.post(`/threads/${e}`,{body:t,...s,headers:{"OpenAI-Beta":"assistants=v2",...s?.headers}})}del(e,t){return this._client.delete(`/threads/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}createAndRun(e,t){return this._client.post("/threads/runs",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers},stream:e.stream??!1})}async createAndRunPoll(e,t){const s=await this.createAndRun(e,t);return await this.runs.poll(s.thread_id,s.id,t)}createAndRunStream(e,t){return Ge.createThreadAssistantStream(e,this._client.beta.threads,t)}}bn.Runs=ns;bn.RunsPage=Pi;bn.Messages=Ei;bn.MessagesPage=Si;class xn extends L{constructor(){super(...arguments),this.realtime=new or(this._client),this.chat=new ei(this._client),this.assistants=new bi(this._client),this.threads=new bn(this._client)}}xn.Realtime=or;xn.Assistants=bi;xn.AssistantsPage=xi;xn.Threads=bn;class rc extends L{create(e,t){return this._client.post("/completions",{body:e,...t,stream:e.stream??!1})}}class ic extends L{retrieve(e,t,s){return this._client.get(`/containers/${e}/files/${t}/content`,{...s,headers:{Accept:"application/binary",...s?.headers},__binaryResponse:!0})}}let lr=class extends L{constructor(){super(...arguments),this.content=new ic(this._client)}create(e,t,s){return this._client.post(`/containers/${e}/files`,Gt({body:t,...s}))}retrieve(e,t,s){return this._client.get(`/containers/${e}/files/${t}`,s)}list(e,t={},s){return Z(t)?this.list(e,{},t):this._client.getAPIList(`/containers/${e}/files`,Ii,{query:t,...s})}del(e,t,s){return this._client.delete(`/containers/${e}/files/${t}`,{...s,headers:{Accept:"*/*",...s?.headers}})}};class Ii extends re{}lr.FileListResponsesPage=Ii;lr.Content=ic;class ss extends L{constructor(){super(...arguments),this.files=new lr(this._client)}create(e,t){return this._client.post("/containers",{body:e,...t})}retrieve(e,t){return this._client.get(`/containers/${e}`,t)}list(e={},t){return Z(e)?this.list({},e):this._client.getAPIList("/containers",Mi,{query:e,...t})}del(e,t){return this._client.delete(`/containers/${e}`,{...t,headers:{Accept:"*/*",...t?.headers}})}}class Mi extends re{}ss.ContainerListResponsesPage=Mi;ss.Files=lr;ss.FileListResponsesPage=Ii;class ac extends L{create(e,t){const s=!!e.encoding_format;let r=s?e.encoding_format:"base64";s&&Rt("Request","User defined encoding_format:",e.encoding_format);const i=this._client.post("/embeddings",{body:{...e,encoding_format:r},...t});return s?i:(Rt("response","Decoding base64 embeddings to float32 array"),i._thenUnwrap(a=>(a&&a.data&&a.data.forEach(o=>{const l=o.embedding;o.embedding=rh(l)}),a)))}}class Ti extends L{retrieve(e,t,s,r){return this._client.get(`/evals/${e}/runs/${t}/output_items/${s}`,r)}list(e,t,s={},r){return Z(s)?this.list(e,t,{},s):this._client.getAPIList(`/evals/${e}/runs/${t}/output_items`,Ni,{query:s,...r})}}class Ni extends re{}Ti.OutputItemListResponsesPage=Ni;class rs extends L{constructor(){super(...arguments),this.outputItems=new Ti(this._client)}create(e,t,s){return this._client.post(`/evals/${e}/runs`,{body:t,...s})}retrieve(e,t,s){return this._client.get(`/evals/${e}/runs/${t}`,s)}list(e,t={},s){return Z(t)?this.list(e,{},t):this._client.getAPIList(`/evals/${e}/runs`,Oi,{query:t,...s})}del(e,t,s){return this._client.delete(`/evals/${e}/runs/${t}`,s)}cancel(e,t,s){return this._client.post(`/evals/${e}/runs/${t}`,s)}}class Oi extends re{}rs.RunListResponsesPage=Oi;rs.OutputItems=Ti;rs.OutputItemListResponsesPage=Ni;class is extends L{constructor(){super(...arguments),this.runs=new rs(this._client)}create(e,t){return this._client.post("/evals",{body:e,...t})}retrieve(e,t){return this._client.get(`/evals/${e}`,t)}update(e,t,s){return this._client.post(`/evals/${e}`,{body:t,...s})}list(e={},t){return Z(e)?this.list({},e):this._client.getAPIList("/evals",$i,{query:e,...t})}del(e,t){return this._client.delete(`/evals/${e}`,t)}}class $i extends re{}is.EvalListResponsesPage=$i;is.Runs=rs;is.RunListResponsesPage=Oi;let Li=class extends L{create(e,t){return this._client.post("/files",Gt({body:e,...t}))}retrieve(e,t){return this._client.get(`/files/${e}`,t)}list(e={},t){return Z(e)?this.list({},e):this._client.getAPIList("/files",Fi,{query:e,...t})}del(e,t){return this._client.delete(`/files/${e}`,t)}content(e,t){return this._client.get(`/files/${e}/content`,{...t,headers:{Accept:"application/binary",...t?.headers},__binaryResponse:!0})}retrieveContent(e,t){return this._client.get(`/files/${e}/content`,t)}async waitForProcessing(e,{pollInterval:t=5e3,maxWait:s=1800*1e3}={}){const r=new Set(["processed","error","deleted"]),i=Date.now();let a=await this.retrieve(e);for(;!a.status||!r.has(a.status);)if(await Zn(t),a=await this.retrieve(e),Date.now()-i>s)throw new vi({message:`Giving up on waiting for file ${e} to finish processing after ${s} milliseconds.`});return a}};class Fi extends re{}Li.FileObjectsPage=Fi;class oc extends L{}let lc=class extends L{run(e,t){return this._client.post("/fine_tuning/alpha/graders/run",{body:e,...t})}validate(e,t){return this._client.post("/fine_tuning/alpha/graders/validate",{body:e,...t})}};class Di extends L{constructor(){super(...arguments),this.graders=new lc(this._client)}}Di.Graders=lc;class zi extends L{create(e,t,s){return this._client.getAPIList(`/fine_tuning/checkpoints/${e}/permissions`,Bi,{body:t,method:"post",...s})}retrieve(e,t={},s){return Z(t)?this.retrieve(e,{},t):this._client.get(`/fine_tuning/checkpoints/${e}/permissions`,{query:t,...s})}del(e,t,s){return this._client.delete(`/fine_tuning/checkpoints/${e}/permissions/${t}`,s)}}class Bi extends sr{}zi.PermissionCreateResponsesPage=Bi;let cr=class extends L{constructor(){super(...arguments),this.permissions=new zi(this._client)}};cr.Permissions=zi;cr.PermissionCreateResponsesPage=Bi;class Hi extends L{list(e,t={},s){return Z(t)?this.list(e,{},t):this._client.getAPIList(`/fine_tuning/jobs/${e}/checkpoints`,Wi,{query:t,...s})}}class Wi extends re{}Hi.FineTuningJobCheckpointsPage=Wi;class kn extends L{constructor(){super(...arguments),this.checkpoints=new Hi(this._client)}create(e,t){return this._client.post("/fine_tuning/jobs",{body:e,...t})}retrieve(e,t){return this._client.get(`/fine_tuning/jobs/${e}`,t)}list(e={},t){return Z(e)?this.list({},e):this._client.getAPIList("/fine_tuning/jobs",Ui,{query:e,...t})}cancel(e,t){return this._client.post(`/fine_tuning/jobs/${e}/cancel`,t)}listEvents(e,t={},s){return Z(t)?this.listEvents(e,{},t):this._client.getAPIList(`/fine_tuning/jobs/${e}/events`,ji,{query:t,...s})}pause(e,t){return this._client.post(`/fine_tuning/jobs/${e}/pause`,t)}resume(e,t){return this._client.post(`/fine_tuning/jobs/${e}/resume`,t)}}class Ui extends re{}class ji extends re{}kn.FineTuningJobsPage=Ui;kn.FineTuningJobEventsPage=ji;kn.Checkpoints=Hi;kn.FineTuningJobCheckpointsPage=Wi;class Pt extends L{constructor(){super(...arguments),this.methods=new oc(this._client),this.jobs=new kn(this._client),this.checkpoints=new cr(this._client),this.alpha=new Di(this._client)}}Pt.Methods=oc;Pt.Jobs=kn;Pt.FineTuningJobsPage=Ui;Pt.FineTuningJobEventsPage=ji;Pt.Checkpoints=cr;Pt.Alpha=Di;class cc extends L{}class qi extends L{constructor(){super(...arguments),this.graderModels=new cc(this._client)}}qi.GraderModels=cc;class uc extends L{createVariation(e,t){return this._client.post("/images/variations",Gt({body:e,...t}))}edit(e,t){return this._client.post("/images/edits",Gt({body:e,...t}))}generate(e,t){return this._client.post("/images/generations",{body:e,...t})}}class Xi extends L{retrieve(e,t){return this._client.get(`/models/${e}`,t)}list(e){return this._client.getAPIList("/models",Gi,e)}del(e,t){return this._client.delete(`/models/${e}`,t)}}class Gi extends sr{}Xi.ModelsPage=Gi;class dc extends L{create(e,t){return this._client.post("/moderations",{body:e,...t})}}function vh(n,e){return!e||!yh(e)?{...n,output_parsed:null,output:n.output.map(t=>t.type==="function_call"?{...t,parsed_arguments:null}:t.type==="message"?{...t,content:t.content.map(s=>({...s,parsed:null}))}:t)}:fc(n,e)}function fc(n,e){const t=n.output.map(r=>{if(r.type==="function_call")return{...r,parsed_arguments:xh(e,r)};if(r.type==="message"){const i=r.content.map(a=>a.type==="output_text"?{...a,parsed:_h(e,a.text)}:a);return{...r,content:i}}return r}),s=Object.assign({},n,{output:t});return Object.getOwnPropertyDescriptor(n,"output_text")||hc(s),Object.defineProperty(s,"output_parsed",{enumerable:!0,get(){for(const r of s.output)if(r.type==="message"){for(const i of r.content)if(i.type==="output_text"&&i.parsed!==null)return i.parsed}return null}}),s}function _h(n,e){return n.text?.format?.type!=="json_schema"?null:"$parseRaw"in n.text?.format?(n.text?.format).$parseRaw(e):JSON.parse(e)}function yh(n){return!!ki(n.text?.format)}function wh(n){return n?.$brand==="auto-parseable-tool"}function bh(n,e){return n.find(t=>t.type==="function"&&t.name===e)}function xh(n,e){const t=bh(n.tools??[],e.name);return{...e,...e,parsed_arguments:wh(t)?t.$parseRaw(e.arguments):t?.strict?JSON.parse(e.arguments):null}}function hc(n){const e=[];for(const t of n.output)if(t.type==="message")for(const s of t.content)s.type==="output_text"&&e.push(s.text);n.output_text=e.join("")}class pc extends L{list(e,t={},s){return Z(t)?this.list(e,{},t):this._client.getAPIList(`/responses/${e}/input_items`,Ch,{query:t,...s})}}var sn=function(n,e,t,s,r){if(s==="m")throw new TypeError("Private method is not writable");if(s==="a"&&!r)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?n!==e||!r:!e.has(n))throw new TypeError("Cannot write private member to an object whose class did not declare it");return s==="a"?r.call(n,t):r?r.value=t:e.set(n,t),t},wt=function(n,e,t,s){if(t==="a"&&!s)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?n!==e||!s:!e.has(n))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?s:t==="a"?s.call(n):s?s.value:e.get(n)},rn,Cs,bt,Es,ho,po,go,mo;class Yi extends wi{constructor(e){super(),rn.add(this),Cs.set(this,void 0),bt.set(this,void 0),Es.set(this,void 0),sn(this,Cs,e,"f")}static createResponse(e,t,s){const r=new Yi(t);return r._run(()=>r._createOrRetrieveResponse(e,t,{...s,headers:{...s?.headers,"X-Stainless-Helper-Method":"stream"}})),r}async _createOrRetrieveResponse(e,t,s){const r=s?.signal;r&&(r.aborted&&this.controller.abort(),r.addEventListener("abort",()=>this.controller.abort())),wt(this,rn,"m",ho).call(this);let i,a=null;"response_id"in t?(i=await e.responses.retrieve(t.response_id,{stream:!0},{...s,signal:this.controller.signal,stream:!0}),a=t.starting_after??null):i=await e.responses.create({...t,stream:!0},{...s,signal:this.controller.signal}),this._connected();for await(const o of i)wt(this,rn,"m",po).call(this,o,a);if(i.controller.signal?.aborted)throw new Be;return wt(this,rn,"m",go).call(this)}[(Cs=new WeakMap,bt=new WeakMap,Es=new WeakMap,rn=new WeakSet,ho=function(){this.ended||sn(this,bt,void 0,"f")},po=function(t,s){if(this.ended)return;const r=(a,o)=>{(s==null||o.sequence_number>s)&&this._emit(a,o)},i=wt(this,rn,"m",mo).call(this,t);switch(r("event",t),t.type){case"response.output_text.delta":{const a=i.output[t.output_index];if(!a)throw new N(`missing output at index ${t.output_index}`);if(a.type==="message"){const o=a.content[t.content_index];if(!o)throw new N(`missing content at index ${t.content_index}`);if(o.type!=="output_text")throw new N(`expected content to be 'output_text', got ${o.type}`);r("response.output_text.delta",{...t,snapshot:o.text})}break}case"response.function_call_arguments.delta":{const a=i.output[t.output_index];if(!a)throw new N(`missing output at index ${t.output_index}`);a.type==="function_call"&&r("response.function_call_arguments.delta",{...t,snapshot:a.arguments});break}default:r(t.type,t);break}},go=function(){if(this.ended)throw new N("stream has ended, this shouldn't happen");const t=wt(this,bt,"f");if(!t)throw new N("request ended without sending any events");sn(this,bt,void 0,"f");const s=kh(t,wt(this,Cs,"f"));return sn(this,Es,s,"f"),s},mo=function(t){let s=wt(this,bt,"f");if(!s){if(t.type!=="response.created")throw new N(`When snapshot hasn't been set yet, expected 'response.created' event, got ${t.type}`);return s=sn(this,bt,t.response,"f"),s}switch(t.type){case"response.output_item.added":{s.output.push(t.item);break}case"response.content_part.added":{const r=s.output[t.output_index];if(!r)throw new N(`missing output at index ${t.output_index}`);r.type==="message"&&r.content.push(t.part);break}case"response.output_text.delta":{const r=s.output[t.output_index];if(!r)throw new N(`missing output at index ${t.output_index}`);if(r.type==="message"){const i=r.content[t.content_index];if(!i)throw new N(`missing content at index ${t.content_index}`);if(i.type!=="output_text")throw new N(`expected content to be 'output_text', got ${i.type}`);i.text+=t.delta}break}case"response.function_call_arguments.delta":{const r=s.output[t.output_index];if(!r)throw new N(`missing output at index ${t.output_index}`);r.type==="function_call"&&(r.arguments+=t.delta);break}case"response.completed":{sn(this,bt,t.response,"f");break}}return s},Symbol.asyncIterator)](){const e=[],t=[];let s=!1;return this.on("event",r=>{const i=t.shift();i?i.resolve(r):e.push(r)}),this.on("end",()=>{s=!0;for(const r of t)r.resolve(void 0);t.length=0}),this.on("abort",r=>{s=!0;for(const i of t)i.reject(r);t.length=0}),this.on("error",r=>{s=!0;for(const i of t)i.reject(r);t.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:s?{value:void 0,done:!0}:new Promise((i,a)=>t.push({resolve:i,reject:a})).then(i=>i?{value:i,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}async finalResponse(){await this.done();const e=wt(this,Es,"f");if(!e)throw new N("stream ended without producing a ChatCompletion");return e}}function kh(n,e){return vh(n,e)}class Vi extends L{constructor(){super(...arguments),this.inputItems=new pc(this._client)}create(e,t){return this._client.post("/responses",{body:e,...t,stream:e.stream??!1})._thenUnwrap(s=>("object"in s&&s.object==="response"&&hc(s),s))}retrieve(e,t={},s){return this._client.get(`/responses/${e}`,{query:t,...s,stream:t?.stream??!1})}del(e,t){return this._client.delete(`/responses/${e}`,{...t,headers:{Accept:"*/*",...t?.headers}})}parse(e,t){return this._client.responses.create(e,t)._thenUnwrap(s=>fc(s,e))}stream(e,t){return Yi.createResponse(this._client,e,t)}cancel(e,t){return this._client.post(`/responses/${e}/cancel`,{...t,headers:{Accept:"*/*",...t?.headers}})}}class Ch extends re{}Vi.InputItems=pc;class gc extends L{create(e,t,s){return this._client.post(`/uploads/${e}/parts`,Gt({body:t,...s}))}}class Ji extends L{constructor(){super(...arguments),this.parts=new gc(this._client)}create(e,t){return this._client.post("/uploads",{body:e,...t})}cancel(e,t){return this._client.post(`/uploads/${e}/cancel`,t)}complete(e,t,s){return this._client.post(`/uploads/${e}/complete`,{body:t,...s})}}Ji.Parts=gc;const Eh=async n=>{const e=await Promise.allSettled(n),t=e.filter(r=>r.status==="rejected");if(t.length){for(const r of t)console.error(r.reason);throw new Error(`${t.length} promise(s) failed - see the above errors`)}const s=[];for(const r of e)r.status==="fulfilled"&&s.push(r.value);return s};class ur extends L{create(e,t,s){return this._client.post(`/vector_stores/${e}/files`,{body:t,...s,headers:{"OpenAI-Beta":"assistants=v2",...s?.headers}})}retrieve(e,t,s){return this._client.get(`/vector_stores/${e}/files/${t}`,{...s,headers:{"OpenAI-Beta":"assistants=v2",...s?.headers}})}update(e,t,s,r){return this._client.post(`/vector_stores/${e}/files/${t}`,{body:s,...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}list(e,t={},s){return Z(t)?this.list(e,{},t):this._client.getAPIList(`/vector_stores/${e}/files`,dr,{query:t,...s,headers:{"OpenAI-Beta":"assistants=v2",...s?.headers}})}del(e,t,s){return this._client.delete(`/vector_stores/${e}/files/${t}`,{...s,headers:{"OpenAI-Beta":"assistants=v2",...s?.headers}})}async createAndPoll(e,t,s){const r=await this.create(e,t,s);return await this.poll(e,r.id,s)}async poll(e,t,s){const r={...s?.headers,"X-Stainless-Poll-Helper":"true"};for(s?.pollIntervalMs&&(r["X-Stainless-Custom-Poll-Interval"]=s.pollIntervalMs.toString());;){const i=await this.retrieve(e,t,{...s,headers:r}).withResponse(),a=i.data;switch(a.status){case"in_progress":let o=5e3;if(s?.pollIntervalMs)o=s.pollIntervalMs;else{const l=i.response.headers.get("openai-poll-after-ms");if(l){const c=parseInt(l);isNaN(c)||(o=c)}}await Zn(o);break;case"failed":case"completed":return a}}}async upload(e,t,s){const r=await this._client.files.create({file:t,purpose:"assistants"},s);return this.create(e,{file_id:r.id},s)}async uploadAndPoll(e,t,s){const r=await this.upload(e,t,s);return await this.poll(e,r.id,s)}content(e,t,s){return this._client.getAPIList(`/vector_stores/${e}/files/${t}/content`,Ki,{...s,headers:{"OpenAI-Beta":"assistants=v2",...s?.headers}})}}class dr extends re{}class Ki extends sr{}ur.VectorStoreFilesPage=dr;ur.FileContentResponsesPage=Ki;class mc extends L{create(e,t,s){return this._client.post(`/vector_stores/${e}/file_batches`,{body:t,...s,headers:{"OpenAI-Beta":"assistants=v2",...s?.headers}})}retrieve(e,t,s){return this._client.get(`/vector_stores/${e}/file_batches/${t}`,{...s,headers:{"OpenAI-Beta":"assistants=v2",...s?.headers}})}cancel(e,t,s){return this._client.post(`/vector_stores/${e}/file_batches/${t}/cancel`,{...s,headers:{"OpenAI-Beta":"assistants=v2",...s?.headers}})}async createAndPoll(e,t,s){const r=await this.create(e,t);return await this.poll(e,r.id,s)}listFiles(e,t,s={},r){return Z(s)?this.listFiles(e,t,{},s):this._client.getAPIList(`/vector_stores/${e}/file_batches/${t}/files`,dr,{query:s,...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}async poll(e,t,s){const r={...s?.headers,"X-Stainless-Poll-Helper":"true"};for(s?.pollIntervalMs&&(r["X-Stainless-Custom-Poll-Interval"]=s.pollIntervalMs.toString());;){const{data:i,response:a}=await this.retrieve(e,t,{...s,headers:r}).withResponse();switch(i.status){case"in_progress":let o=5e3;if(s?.pollIntervalMs)o=s.pollIntervalMs;else{const l=a.headers.get("openai-poll-after-ms");if(l){const c=parseInt(l);isNaN(c)||(o=c)}}await Zn(o);break;case"failed":case"cancelled":case"completed":return i}}}async uploadAndPoll(e,{files:t,fileIds:s=[]},r){if(t==null||t.length==0)throw new Error("No `files` provided to process. If you've already uploaded files you should use `.createAndPoll()` instead");const i=r?.maxConcurrency??5,a=Math.min(i,t.length),o=this._client,l=t.values(),c=[...s];async function h(u){for(let d of u){const g=await o.files.create({file:d,purpose:"assistants"},r);c.push(g.id)}}const f=Array(a).fill(l).map(h);return await Eh(f),await this.createAndPoll(e,{file_ids:c})}}class It extends L{constructor(){super(...arguments),this.files=new ur(this._client),this.fileBatches=new mc(this._client)}create(e,t){return this._client.post("/vector_stores",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}retrieve(e,t){return this._client.get(`/vector_stores/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}update(e,t,s){return this._client.post(`/vector_stores/${e}`,{body:t,...s,headers:{"OpenAI-Beta":"assistants=v2",...s?.headers}})}list(e={},t){return Z(e)?this.list({},e):this._client.getAPIList("/vector_stores",Qi,{query:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}del(e,t){return this._client.delete(`/vector_stores/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}search(e,t,s){return this._client.getAPIList(`/vector_stores/${e}/search`,Zi,{body:t,method:"post",...s,headers:{"OpenAI-Beta":"assistants=v2",...s?.headers}})}}class Qi extends re{}class Zi extends sr{}It.VectorStoresPage=Qi;It.VectorStoreSearchResponsesPage=Zi;It.Files=ur;It.VectorStoreFilesPage=dr;It.FileContentResponsesPage=Ki;It.FileBatches=mc;var vc;class D extends Xf{constructor({baseURL:e=ys("OPENAI_BASE_URL"),apiKey:t=ys("OPENAI_API_KEY"),organization:s=ys("OPENAI_ORG_ID")??null,project:r=ys("OPENAI_PROJECT_ID")??null,...i}={}){if(t===void 0)throw new N("The OPENAI_API_KEY environment variable is missing or empty; either provide it, or instantiate the OpenAI client with an apiKey option, like new OpenAI({ apiKey: 'My API Key' }).");const a={apiKey:t,organization:s,project:r,...i,baseURL:e||"https://api.openai.com/v1"};if(!a.dangerouslyAllowBrowser&&nh())throw new N(`It looks like you're running in a browser-like environment.

This is disabled by default, as it risks exposing your secret API credentials to attackers.
If you understand the risks and have appropriate mitigations in place,
you can set the \`dangerouslyAllowBrowser\` option to \`true\`, e.g.,

new OpenAI({ apiKey, dangerouslyAllowBrowser: true });

https://help.openai.com/en/articles/5112595-best-practices-for-api-key-safety
`);super({baseURL:a.baseURL,timeout:a.timeout??6e5,httpAgent:a.httpAgent,maxRetries:a.maxRetries,fetch:a.fetch}),this.completions=new rc(this),this.chat=new ar(this),this.embeddings=new ac(this),this.files=new Li(this),this.images=new uc(this),this.audio=new es(this),this.moderations=new dc(this),this.models=new Xi(this),this.fineTuning=new Pt(this),this.graders=new qi(this),this.vectorStores=new It(this),this.beta=new xn(this),this.batches=new _i(this),this.uploads=new Ji(this),this.responses=new Vi(this),this.evals=new is(this),this.containers=new ss(this),this._options=a,this.apiKey=t,this.organization=s,this.project=r}defaultQuery(){return this._options.defaultQuery}defaultHeaders(e){return{...super.defaultHeaders(e),"OpenAI-Organization":this.organization,"OpenAI-Project":this.project,...this._options.defaultHeaders}}authHeaders(e){return{Authorization:`Bearer ${this.apiKey}`}}stringifyQuery(e){return Rf(e,{arrayFormat:"brackets"})}}vc=D;D.OpenAI=vc;D.DEFAULT_TIMEOUT=6e5;D.OpenAIError=N;D.APIError=fe;D.APIConnectionError=Zs;D.APIConnectionTimeoutError=vi;D.APIUserAbortError=Be;D.NotFoundError=gl;D.ConflictError=ml;D.RateLimitError=_l;D.BadRequestError=fl;D.AuthenticationError=hl;D.InternalServerError=yl;D.PermissionDeniedError=pl;D.UnprocessableEntityError=vl;D.toFile=El;D.fileFromPath=cl;D.Completions=rc;D.Chat=ar;D.ChatCompletionsPage=ir;D.Embeddings=ac;D.Files=Li;D.FileObjectsPage=Fi;D.Images=uc;D.Audio=es;D.Moderations=dc;D.Models=Xi;D.ModelsPage=Gi;D.FineTuning=Pt;D.Graders=qi;D.VectorStores=It;D.VectorStoresPage=Qi;D.VectorStoreSearchResponsesPage=Zi;D.Beta=xn;D.Batches=_i;D.BatchesPage=yi;D.Uploads=Ji;D.Responses=Vi;D.Evals=is;D.EvalListResponsesPage=$i;D.Containers=ss;D.ContainerListResponsesPage=Mi;class vo{constructor(e){this.client=new D({apiKey:e.apiKey,baseURL:e.endpoint,dangerouslyAllowBrowser:!0,fetch})}async chat(e){const s=(await this.client.chat.completions.create({...e,stream:!1})).choices?.[0]?.message?.content;return this.extractContent(s)}async streamChat(e,t){const s=await this.client.chat.completions.create({...e,stream:!0});let r="",i=!1,a=!1;for await(const o of s){const l=o.choices?.[0]?.delta;if(!l)continue;const c=l.reasoning_content,h=this.extractContent(c);h&&(i=!0,t(h,"",!1));const f=l.content,u=this.extractContent(f);u&&(i&&!a&&(a=!0),r+=u,t("",u,a))}return r}extractContent(e){if(!e)return"";if(typeof e=="string")return e;if(Array.isArray(e))return e.map(t=>this.extractPartText(t)).join("");if(typeof e=="object"&&"text"in e){const t=e.text;if(typeof t=="string")return t;if(t&&typeof t=="object"&&"value"in t){const s=t.value;return typeof s=="string"?s:""}}return""}extractPartText(e){if(!e)return"";if(typeof e=="string")return e;if(typeof e=="object"&&"text"in e){const t=e.text;if(typeof t=="string")return t;if(t&&typeof t=="object"&&"value"in t){const s=t.value;return typeof s=="string"?s:""}}return""}}function Sh(n,e){const t=Math.max(e,0)*4;if(t===0)return{trimmedMessages:n,trimmed:!1};let s=0;const r=[];for(let o=n.length-1;o>=0;o-=1){const l=n[o],c=l.content.length;if(s+c>t&&r.length>0)break;r.push(l),s+=c}const i=r.reverse(),a=i.length!==n.length;return{trimmedMessages:i,trimmed:a}}class Ah{constructor(e){this.plugin=e}async testModel(e){if(!e.endpoint.trim()||!e.apiKey.trim())return{success:!1,message:"Ê®°ÂûãÈÖçÁΩÆ‰∏çÂÆåÊï¥Ôºöendpoint Êàñ API key ‰∏∫Á©∫"};try{return await new vo(e).chat({model:e.id,messages:[{role:"user",content:"test"}],maxTokens:10}),{success:!0,message:"Ê®°ÂûãËøûÊé•ÊàêÂäü"}}catch(t){return{success:!1,message:`Ê®°ÂûãËøûÊé•Â§±Ë¥•Ôºö${this.formatError(t)}`}}}async requestChat(e){const t=this.getModelConfig(e.modelId);if(!t)return this.notify("Êú™ÊâæÂà∞ÂèØÁî®Ê®°ÂûãÔºåËØ∑Âú®ËÆæÁΩÆ‰∏≠ÈÖçÁΩÆÈªòËÆ§ÊñáÊú¨Ê®°Âûã"),"";if(!t.endpoint.trim()||!t.apiKey.trim())return this.notify("Ê®°ÂûãÁº∫Â∞ë endpoint Êàñ API keyÔºåÊó†Ê≥ïÂèëÈÄÅËØ∑Ê±Ç"),"";if(e.messages.length===0)return this.notify("Ê≤°ÊúâÂèØÂèëÈÄÅÁöÑÊ∂àÊÅØ"),"";const s=new vo(t),{trimmedMessages:r,trimmed:i}=Sh(e.messages,t.contextTokens);i&&this.plugin.settings.warnOnContextTrim&&this.notify("‰∏ä‰∏ãÊñáËøáÈïøÔºåÂ∑≤Êà™Êñ≠ËæÉÊó©ÁöÑÊ∂àÊÅØ");const a={model:t.id,messages:r,maxTokens:e.maxTokens,signal:e.signal};try{const o=e.stream?await s.streamChat(a,e.onToken??((l,c,h)=>{})):await s.chat(a);return this.plugin.debugLogger.log(`chat:${t.id} success len=${o.length}`),o}catch(o){const l=this.formatError(o);throw this.notify(`AI ËØ∑Ê±ÇÂ§±Ë¥•Ôºö${l}`),this.plugin.debugLogger.error(`chat:${t.id} failed: ${l}`),o}}getModelConfig(e){const t=e??this.plugin.settings.defaultModelId;return this.plugin.settings.models.find(r=>r.id===t)??null??null}notify(e){new te.Notice(e)}formatError(e){return e instanceof Error?e.stack?`${e.message}
${e.stack}`:e.message:"Êú™Áü•ÈîôËØØ"}}function Rh(n,e){const t=new Set,s=new Set;if(!n||!Array.isArray(n.edges)||!Array.isArray(n.nodes))return{nodeIds:t,edgeIds:s};const r=new Map,i=new Map;n.edges.forEach(o=>{if(o?.toNode&&o?.fromNode&&o.id){const l=r.get(o.toNode)??[];l.push(o.id),r.set(o.toNode,l),i.set(o.id,{fromNode:o.fromNode,toNode:o.toNode})}});const a=o=>{if(t.has(o))return;t.add(o);const l=r.get(o);l&&l.forEach(c=>{s.add(c);const h=i.get(c);h&&a(h.fromNode)})};return a(e),{nodeIds:t,edgeIds:s}}function Ph(n,e){const t=document.styleSheets;for(let s of t)try{for(let r of s.cssRules)if(r.selectorText===`.${n}`){r.style.setProperty("--canvas-color",e);break}}catch{}}class Ih{constructor(){this.highlightedNodeIds=new Set,this.highlightedEdgeIds=new Set,setTimeout(()=>{Ph("cai-lineage-highlight",this.getAccentColor()??"")},1e3)}getAccentColor(){const e=getComputedStyle(document.body),t=e.getPropertyValue("--accent-h").trim(),s=e.getPropertyValue("--accent-s").trim();if(!t||!s)return e.getPropertyValue("--interactive-accent").trim()||null;const r="85%",i=document.createElement("canvas");i.width=i.height=1;const a=i.getContext("2d");a.fillStyle=`hsl(${t}, ${s}, ${r})`,a.fillRect(0,0,1,1);const[o,l,c]=a?.getImageData(0,0,1,1).data??[0,0,0];return`${o},${l},${c}`}highlightLineage(e,t){this.clearHighlight(e,t),t.nodeIds.forEach(s=>{const r=e.nodes.get(s);r&&ft(r)&&(r?.nodeEl?.classList.add("cai-lineage-highlight"),this.highlightedNodeIds.add(s))}),t.edgeIds.forEach(s=>{const r=e.edges?.get(s);if(!r)return;const i=r.from?.node;!i||!ft(i)||(r?.lineGroupEl?.classList.add("cai-lineage-highlight"),this.highlightedEdgeIds.add(s))}),e.requestFrame?.()}clearHighlight(e,t){this.highlightedNodeIds.forEach(s=>{if(t?.nodeIds?.has(s))return;const r=e?.nodes?.get(s);r&&r?.nodeEl?.classList.remove("cai-lineage-highlight"),this.highlightedNodeIds.delete(s)}),this.highlightedEdgeIds.forEach(s=>{if(t?.edgeIds?.has(s))return;const r=e?.edges?.get(s);r&&r?.lineGroupEl?.classList.remove("cai-lineage-highlight"),this.highlightedEdgeIds.delete(s)}),e?.requestFrame?.()}}function _c(n,e){const t=Object.keys(e).map(s=>Mh(n,s,e[s]));return t.length===1?t[0]:function(){t.forEach(s=>s())}}function Mh(n,e,t){const s=n[e],r=n.hasOwnProperty(e),i=r?s:function(){return Object.getPrototypeOf(n)[e].apply(this,arguments)};let a=t(i);return s&&Object.setPrototypeOf(a,s),Object.setPrototypeOf(o,a),n[e]=o,l;function o(...c){return a===i&&n[e]===o&&l(),a.apply(this,c)}function l(){n[e]===o&&(r?n[e]=i:delete n[e]),a!==i&&(a=i,Object.setPrototypeOf(o,s||Function))}}function Th(n,e,t){if(n.querySelectorAll(".vibe-addon").forEach(a=>a.remove()),!e)return;const s=t.filter(a=>a.showInMainMenu),r=t.filter(a=>!a.showInMainMenu);let i=!0;s.forEach(a=>{const o=yc(a,e);i&&(o.classList.add("vibe-addon-first"),i=!1),n.appendChild(o)}),r.length>0&&Nh(n,r,e)}function yc(n,e){const t=document.createElement("button");return t.className="clickable-icon vibe-addon",n.isActive?.(e)&&t.classList.add("is-active"),te.setIcon(t,n.icon),te.setTooltip(t,n.tooltip,{placement:"top"}),n.dataset&&Object.entries(n.dataset).forEach(([s,r])=>{t.dataset[s]=r}),t.addEventListener("click",s=>{s.preventDefault(),s.stopPropagation(),n.onClick(e)}),t}function Nh(n,e,t){const s=document.createElement("div");s.className="vibe-addon-wrapper vibe-addon",n.appendChild(s);const r=document.createElement("button");r.className="clickable-icon",te.setIcon(r,"more-horizontal"),te.setTooltip(r,"Êõ¥Â§öÊìç‰Ωú",{placement:"top"}),s.appendChild(r);const i=document.createElement("div");i.className="vibe-canvas-menu-panel",i.style.display="none",s.appendChild(i);const a=o=>{o.preventDefault(),o.stopPropagation();const l=i.style.display==="none";if(document.querySelectorAll(".vibe-canvas-menu-panel").forEach(c=>{c!==i&&(c.style.display="none")}),l){Oh(i,e,t),i.style.display="flex";const c=h=>{!i.contains(h.target)&&h.target!==r&&(i.style.display="none",document.removeEventListener("click",c))};setTimeout(()=>document.addEventListener("click",c),0)}else i.style.display="none"};r.addEventListener("click",a)}function Oh(n,e,t){n.replaceChildren();const s=document.createElement("div");if(s.className="vibe-canvas-action-grid",e.forEach(r=>{const i=yc(r,t);s.appendChild(i)}),s.hasChildNodes())n.appendChild(s);else{const r=document.createElement("div");r.className="vibe-canvas-empty-state",r.textContent="Êó†Êõ¥Â§öÊìç‰Ωú",n.appendChild(r)}}function $h(n,e){return _c(n.menu.constructor.prototype,{render(t){return async function(...s){const r=await t.call(this,...s);return e(this.menuEl,this.canvas),r}}})}function Lh(n,e){return _c(n.constructor.prototype,{selectOnly(t){return async function(...s){await t.call(this,...s),e(s[0])}}})}function Fh(n){document.querySelectorAll("button[data-role]").forEach(t=>{const s=t;s.dataset.role===n?s.classList.add("is-active"):s.classList.remove("is-active")})}const Dh={verticalGap:50,levelGap:100};function zh(n,e){if(!n||!Array.isArray(n.edges)||!Array.isArray(n.nodes))return null;const t=new Map;n.edges.forEach(r=>{if(r?.fromNode&&r?.toNode){const i=t.get(r.fromNode)??[],a=r.fromSide==="bottom"?"bottom":"right";i.push({toNode:r.toNode,direction:a}),t.set(r.fromNode,i)}});const s=(r,i,a)=>{if(i.has(r))return null;i.add(r);const o=t.get(r)??[],l=[];return o.forEach(({toNode:c,direction:h})=>{const f=s(c,i,h);f&&l.push(f)}),{id:r,children:l,direction:a}};return s(e,new Set)}const Bh=160,Hh=280;function wc(n){return{width:n?.width??Hh,height:n?.height??Bh}}function bc(n){return n.maxX-n.minX}function xc(n){return n.maxY-n.minY}function qs(n,e,t,s){const r=s.get(n.id);if(r)return r;const i=e.get(n.id),{width:a,height:o}=wc(i);let l={minX:0,maxX:a,minY:0,maxY:o};if(n.children.length===0)return s.set(n.id,l),l;const c=n.children.filter(u=>u.direction!=="bottom"),h=n.children.filter(u=>u.direction==="bottom");let f=o;if(c.length>0){const u=c.map(y=>qs(y,e,t,s)),d=u.map(xc),g=d.reduce((y,A)=>y+A,0)+t.verticalGap*(d.length-1);let m=o/2-g/2;const v=a+t.levelGap;c.forEach((y,A)=>{const k=u[A],R=v-k.minX,I=m-k.minY,M=R+k.minX,C=R+k.maxX,T=I+k.minY,O=I+k.maxY;l.minX=Math.min(l.minX,M),l.maxX=Math.max(l.maxX,C),l.minY=Math.min(l.minY,T),l.maxY=Math.max(l.maxY,O),f=Math.max(f,O),m+=d[A]+t.verticalGap})}if(h.length>0){const u=h.map(y=>qs(y,e,t,s)),d=u.map(bc),g=d.reduce((y,A)=>y+A,0)+t.verticalGap*(d.length-1),_=Math.max(o+t.levelGap,f+t.verticalGap);let v=a/2-g/2;h.forEach((y,A)=>{const k=u[A],R=v-k.minX,I=_-k.minY,M=R+k.minX,C=R+k.maxX,T=I+k.minY,O=I+k.maxY;l.minX=Math.min(l.minX,M),l.maxX=Math.max(l.maxX,C),l.minY=Math.min(l.minY,T),l.maxY=Math.max(l.maxY,O),v+=d[A]+t.verticalGap})}return s.set(n.id,l),l}function ti(n,e,t,s,r,i,a){const o=e.get(n.id),{width:l,height:c}=wc(o);if(n.children.length===0)return i.set(n.id,{x:t,y:s}),{minX:t,maxX:t+l,minY:s,maxY:s+c};const h=n.children.filter(g=>g.direction!=="bottom"),f=n.children.filter(g=>g.direction==="bottom");i.set(n.id,{x:t,y:s});let u={minX:t,maxX:t+l,minY:s,maxY:s+c},d=s+c;if(h.length>0){const g=h.map(k=>qs(k,e,r,a)),_=g.map(xc),m=_.reduce((k,R)=>k+R,0)+r.verticalGap*(_.length-1);let y=s+c/2-m/2;const A=t+l+r.levelGap;h.forEach((k,R)=>{const I=g[R],M=A-I.minX,C=y-I.minY,T=ti(k,e,M,C,r,i,a);u.minY=Math.min(u.minY,T.minY),u.maxY=Math.max(u.maxY,T.maxY),u.maxX=Math.max(u.maxX,T.maxX),u.minX=Math.min(u.minX,T.minX),d=Math.max(d,T.maxY),y+=_[R]+r.verticalGap})}if(f.length>0){const g=f.map(k=>qs(k,e,r,a)),_=g.map(bc),m=_.reduce((k,R)=>k+R,0)+r.verticalGap*(_.length-1),v=Math.max(s+c+r.levelGap,d+r.verticalGap);let A=t+l/2-m/2;f.forEach((k,R)=>{const I=g[R],M=A-I.minX,C=v-I.minY,T=ti(k,e,M,C,r,i,a);u.minX=Math.min(u.minX,T.minX),u.maxX=Math.max(u.maxX,T.maxX),u.maxY=Math.max(u.maxY,T.maxY),u.minY=Math.min(u.minY,T.minY),A+=_[R]+r.verticalGap})}return u}function Wh(n,e,t,s,r,i){ti(n,e,t,s,r,i,new Map)}function Uh(n,e,t){if(!n||!e||typeof n.getData!="function")return!1;const s=n.getData();if(!s)return!1;const r={...Dh,...t},i=zh(s,e.id);if(!i)return!1;const a=new Map,o=new Set,l=d=>{o.add(d.id),d.children.forEach(l)};l(i),o.forEach(d=>{const g=n.nodes?.get(d);g&&a.set(d,g)}),a.has(e.id)||a.set(e.id,e);const c=new Map,h=e.x??0,f=e.y??0;Wh(i,a,h,f,r,c);let u=!1;return c.forEach((d,g)=>{const _=a.get(g);if(!_)return;const m=_.x??0,v=_.y??0;if(Math.abs(m-d.x)>.1||Math.abs(v-d.y)>.1){const y=_.getData();_.setData({...y,x:d.x,y:d.y}),u=!0}}),u&&(n.requestFrame?.(),n.requestSave?.()),u}async function Bn(n,e,t=new Set){if(!n||typeof n!="string")return n;const s=/\[\[([^\]]+)\]\]/g,r=[];let i;for(;(i=s.exec(n))!==null;)r.push(i);if(r.length===0)return n;let a=n;const o=[];for(const l of r){const c=l[1],[h,f]=jh(c),u=await qh(e,h);if(!u)continue;const d=u.path.toLowerCase();if(!t.has(d))try{let g=null;if(f&&(g=await Xh(e,u,f)),g||(g=await e.vault.cachedRead(u)),g){new Set(t).add(d);const m=Gh(u.path,f,g);o.push(m)}}catch(g){console.error(`Â±ïÂºÄÂºïÁî®Â§±Ë¥•: ${u.path}`,g)}}return o.length>0&&(a+=`

`+o.join(`

`)),a}function jh(n){const e=n.indexOf("#");if(e===-1)return[n.trim(),void 0];const t=n.substring(0,e).trim(),s=n.substring(e+1).trim();return[t,s||void 0]}async function qh(n,e){let t=n.vault.getFileByPath(e);if(t)return t;if(!e.includes(".")){const i=e+".md";if(t=n.vault.getFileByPath(i),t)return t}const r=n.vault.getFiles().find(i=>i.name===e||i.name===e+".md");return r||null}async function Xh(n,e,t){try{if(!t.includes("^")&&!t.includes("-")){const r=(await n.vault.cachedRead(e)).split(`
`),i=t.trim();let a=!1,o=0;const l=[];for(const c of r){const h=c.match(/^#+\s+(.+)$/);if(h&&h[1].trim()===i){a=!0,o=h[0].match(/#/g)?.length??0,l.push(c);continue}if(a){const f=c.match(/^#+\s+/);if(f&&(f[0].match(/#/g)?.length??0)<=o)break;l.push(c)}}if(l.length>0)return l.join(`
`)}return null}catch(s){return console.error(`ËØªÂèñÂùóÂÜÖÂÆπÂ§±Ë¥•: ${e.path}#${t}`,s),null}}function Gh(n,e,t){return`${e?`---
ÂºïÁî®: ${n}#${e}
---`:`---
ÂºïÁî®: ${n}
---`}
${t}`}async function Yh(n,e){const t=n.vault.getFileByPath(e);if(!t)return null;try{return await n.vault.cachedRead(t)}catch(s){return console.error(`ËØªÂèñÊñá‰ª∂Â§±Ë¥•: ${e}`,s),null}}async function Vh(n,e,t,s,r,i){const a=r.systemPrompt.trim(),o=await Jh(n,e,i,r),{systemMessages:l,nonSystemMessages:c}=Qh(o);if(s==="system"&&t.trim()){let d=t;r.expandNestedRefs&&(d=await Bn(d,i)),l.push({role:"system",content:d})}let h=Zh(a,l);r.expandNestedRefs&&h&&(h=await Bn(h,i));const f=[];h&&f.push({role:"system",content:h});const u=await Promise.all(c.map(async d=>r.expandNestedRefs?{...d,content:await Bn(d.content,i)}:d));if(f.push(...u),s!=="system"){let d=t;r.expandNestedRefs&&(d=await Bn(d,i)),f.push({role:s,content:d})}return f}async function Jh(n,e,t,s){if(!n||typeof n!="object")return[];const r=Array.isArray(n.nodes)?n.nodes:[],i=Array.isArray(n.edges)?n.edges:[];if(r.length===0||i.length===0)return[];const a=new Map;i.forEach(u=>{if(u&&u.fromNode&&u.toNode){const d=a.get(u.toNode)??[];d.push(u.fromNode),a.set(u.toNode,d)}});const o=new Set,l=u=>{if(o.has(u))return[];o.add(u);const d=a.get(u);if(!d||d.length===0)return[u];let g=[];return d.forEach(_=>{const m=l(_);m.length>g.length&&(g=m)}),[...g,u]},c=l(e);if(c.length===0)return[];const h=c.slice(0,-1).map(u=>r.find(d=>d.id===u)).filter(u=>u!==void 0),f=[];for(const u of h){const d=Kh(u);if(!d)continue;let g=null;if(u.type==="text")g=typeof u.text=="string"?u.text:null;else if(u.type==="file"){const _=await Yh(t,u.file);_&&(g=`${u.file}
${_}`)}if(g&&g.trim().length>0){let _=g;s.expandNestedRefs&&(_=await Bn(g,t)),f.push({role:d,content:_})}}return f}function Kh(n){const e=n.unknownData?._cai_role??n._cai_role;return e==="user"||e==="assistant"||e==="system"?e:null}function Qh(n){const e=[],t=[];for(const s of n)s.role==="system"?e.push(s):t.push(s);return{systemMessages:e,nonSystemMessages:t}}function Zh(n,e){const t=[];n&&t.push(n);for(const s of e){const r=s.content.trim();r&&t.push(r)}return t.join(`
`)}class ep{constructor(e){this.plugin=e}async handle(e){const{canvas:t,node:s}=e;if(!t||!s){new te.Notice("Êú™ÊâæÂà∞ Canvas ÈÄâ‰∏≠ËäÇÁÇπ");return}const r=Pd(s).trim();if(!r){new te.Notice("ÂΩìÂâçËäÇÁÇπÊ≤°ÊúâÂèØÁî®ÊñáÊú¨");return}const a=Br(s)||this.plugin.settings.defaultModelId,o=this.plugin.settings.models.find(m=>m.id===a);if(!o){new te.Notice("Êú™ÊâæÂà∞ÊñáÊú¨Ê®°ÂûãÔºåËØ∑Âú®ËÆæÁΩÆ‰∏≠ÈÖçÁΩÆ");return}const l=typeof t.getData=="function"?t.getData():null,c=Id(s),h=await Vh(l,s.id,r,c,this.plugin.settings,this.plugin.app),f=Md(t,s,this.plugin.settings.nodeSize),u=f.node;u&&(this.plugin.quickActions?.applyRoleToNode(u,t,"assistant"),Bd(u,o.id,t),Td(t,s,u,f.fromSide,f.toSide));let d="",g="",_=!1;try{const m=await this.plugin.aiService.requestChat({modelId:o.id,messages:h,stream:o.streaming,onToken:u!==null?(R,I,M)=>{R&&(d+=R),I&&(g+=I),M&&(_=!0);const C=qa(d,g,_);ja(u,C,t)}:void 0}),v=d,y=m||g,A=v.trim().length>0,k=qa(v,y,A);u?ja(u,k,t):k?new te.Notice(`AI ÁîüÊàêÂÆåÊàêÔºà${k.length} Â≠óÔºâ`):new te.Notice("AI Ê≤°ÊúâËøîÂõûÂÜÖÂÆπ")}catch(m){console.error("Canvas AI ËØ∑Ê±ÇÂ§±Ë¥•",m)}}}const Xs=new Map;function Ir(n,e,t){const s=Xs.get(n);s&&s(),Xs.set(n,e),t.register(e)}function tp(){for(const n of Xs.values())n();Xs.clear()}class np{constructor(e){this.lineageHighlighter=new Ih,this.roleBadgeProvider=el(),this.plugin=e,this.canvasAIExecutor=new ep(this.plugin),this.modelBadgeProvider=Ad(this.plugin),this.badgeProviders=[this.roleBadgeProvider,this.modelBadgeProvider]}start(){this.registerCanvasEvents(),this.tryPatchActiveCanvasMenu(),this.tryPatchCanvasSelectOnly(),Ua(this.getActiveCanvas(),this.badgeProviders)}destroy(){tp(),this.lineageHighlighter.clearHighlight()}getActiveCanvas(){return this.plugin.app.workspace.getMostRecentLeaf()?.view?.canvas??null}getContext(e){const t=e??this.getActiveCanvas();if(!t?.selection)return null;const s=t.selection;if(s.size!==1)return null;const r=s.values().next().value;return{canvas:t,node:r}}applyRoleToNode(e,t,s){e&&(Dd(e,s,t,this.plugin.settings.nodeSize),As(e,this.modelBadgeProvider),t?.requestSave?.(),Fh(s))}arrangeNodeLayout(e){const t=e??this.getContext();if(!t)return!1;const{node:s,canvas:r}=t;return Uh(r,s)}registerCanvasEvents(){const e=this.plugin.app.workspace,t=()=>{this.getActiveCanvas()&&(this.tryPatchActiveCanvasMenu(),this.tryPatchCanvasSelectOnly(),this.tryPatchCanvasClick(),Ua(this.getActiveCanvas(),this.badgeProviders))};this.plugin.registerEvent(e.on("active-leaf-change",t)),this.plugin.registerEvent(e.on("layout-change",t))}tryPatchActiveCanvasMenu(){const e=this.getActiveCanvas();if(!e?.menu)return;const s=$h(e,(r,i)=>{i.selection.size!==1||Nd(i.selection.values().next().value)||this.injectMenuButtons(r,i)});Ir("menu",s,this.plugin)}tryPatchCanvasSelectOnly(){const e=this.getActiveCanvas();if(!e)return;const t=Lh(e,s=>{});Ir("selectOnly",t,this.plugin)}tryPatchCanvasClick(){const e=this.getActiveCanvas();if(!e?.wrapperEl)return;const t=()=>{this.refreshLineageHighlight()};e.wrapperEl.addEventListener("click",t),Ir("canvasClick",()=>{e.wrapperEl.removeEventListener("click",t)},this.plugin)}injectMenuButtons(e,t){const s=this.getContext(t);if(!s)return;const r=this.buildMenuActions();Th(e,s,r),As(s.node,this.roleBadgeProvider),As(s.node,this.modelBadgeProvider)}buildMenuActions(){const e=this.plugin.settings.quickActions,t=[];return Hr.forEach(r=>{if(!r.isRole){if(r.id==="ai"){t.push({id:r.id,icon:r.icon,tooltip:r.tooltip,showInMainMenu:e[r.id],onClick:async i=>{await this.handleAI(i)}});return}if(r.id==="arrangeLayout"){t.push({id:r.id,icon:r.icon,tooltip:r.tooltip,showInMainMenu:e[r.id],onClick:i=>{this.arrangeNodeLayout(i)}});return}}}),["user","assistant","system"].forEach(r=>{const i=Hr.find(a=>a.id===r);i&&t.push({id:i.id,icon:i.icon,tooltip:Ud(i,r),showInMainMenu:e[r],isActive:a=>ft(a.node)===r,onClick:a=>{this.setRole(a,r)},dataset:{role:r}})}),t}async handleAI(e){return ft(e.node)||this.setRole(e,"user"),new Promise(s=>{setTimeout(async()=>{await this.canvasAIExecutor.handle(e),s()},100)})}setRole(e,t){const{node:s,canvas:r}=e;this.applyRoleToNode(s,r,t)}refreshLineageHighlight(e){const t=e??this.getActiveCanvas(),s=t&&this.getContext(t);if(!t||!s||!ft(s.node)){this.lineageHighlighter.clearHighlight(t??void 0);return}const r=s.node,i=typeof t.getData=="function"?t.getData():null,a=Rh(i,r.id);if(a.nodeIds.size===0){this.lineageHighlighter.clearHighlight(t);return}this.lineageHighlighter.highlightLineage(t,a)}}function sp(n,e){n.addCommand({id:"caret-canvas-mark-assistant",name:"Ê†áËÆ∞ÈÄâ‰∏≠ËäÇÁÇπ‰∏∫ assistant",checkCallback:t=>{const s=e.getActiveCanvas(),r=e.getContext(s??void 0);return r?(t||e.applyRoleToNode(r.node,r.canvas,"assistant"),!0):!1}}),n.addCommand({id:"caret-canvas-mark-user",name:"Ê†áËÆ∞ÈÄâ‰∏≠ËäÇÁÇπ‰∏∫ user",checkCallback:t=>{const s=e.getActiveCanvas(),r=e.getContext(s??void 0);return r?(t||e.applyRoleToNode(r.node,r.canvas,"user"),!0):!1}})}const rp="debug.log";class ip{constructor(e,t){this.entries=[],this.plugin=e,this.getConfig=t}async load(){try{const e=this.getLogPath(),t=this.plugin.app.vault.adapter;if(await t.exists(e)){const s=await t.read(e);this.entries=s.split(`
`).filter(r=>r.trim())}}catch{this.entries=[]}}debug(e){return this.append("DEBUG",e)}log(e){return this.append("INFO",e)}warn(e){return this.append("WARN",e)}error(e){return this.append("ERROR",e)}async append(e,t){const{enabled:s,limit:r}=this.getConfig();if(!s)return;const i=`${new Date().toISOString()} [${e}] ${t}`;this.entries.push(i),this.entries.length>r&&(this.entries=this.entries.slice(-r)),await this.save()}getEntries(){return[...this.entries]}async clear(){this.entries=[],await this.save()}async save(){const e=this.getLogPath();await this.plugin.app.vault.adapter.write(e,this.entries.join(`
`))}getLogPath(){return`${this.plugin.manifest.dir}/${rp}`}}class ap extends tu{async onload(){await super.onload(),this.debugLogger=new ip(this,()=>this.settings.debugLog),await this.debugLogger.load(),this.addSettingTab(new _f(this.app,this)),this.aiService=new Ah(this),this.quickActions=new np(this),this.quickActions.start(),sp(this,this.quickActions)}onunload(){super.onunload(),this.quickActions?.destroy()}}module.exports=ap;
